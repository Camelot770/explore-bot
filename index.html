<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Explore</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{--bg:#0a0a0f;--bg2:#14141c;--bg3:#1c1c28;--accent:#ff6b9d;--accent2:#a855f7;--green:#22c55e;--yellow:#f59e0b;--blue:#3b82f6;--text:#fff;--text2:rgba(255,255,255,.7);--muted:rgba(255,255,255,.4);--border:rgba(255,255,255,.1)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
.app{max-width:440px;margin:0 auto;min-height:100vh;padding-bottom:80px}
.screen{display:none;animation:fadeIn .25s}.screen.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

/* Auth Screen */
.auth-screen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;text-align:center}
.auth-logo{font-size:64px;margin-bottom:16px}
.auth-title{font-size:32px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
.auth-sub{font-size:16px;color:var(--text2);margin-bottom:40px}
.auth-btns{display:flex;flex-direction:column;gap:14px;width:100%;max-width:300px}
.auth-btn{padding:18px 24px;border-radius:16px;border:none;font-size:16px;font-weight:600;cursor:pointer;transition:transform .15s}
.auth-btn:active{transform:scale(.96)}
.auth-btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
.auth-btn.secondary{background:var(--bg2);border:1px solid var(--border);color:var(--text)}

/* Pair Code Screen */
.pair-screen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;text-align:center}
.pair-back{position:absolute;top:20px;left:20px;font-size:14px;color:var(--text2);cursor:pointer}
.pair-icon{font-size:56px;margin-bottom:16px}
.pair-title{font-size:24px;font-weight:700;margin-bottom:8px}
.pair-desc{font-size:14px;color:var(--text2);margin-bottom:32px;max-width:280px}
.pair-code-box{background:var(--bg2);border:2px dashed var(--accent);border-radius:20px;padding:24px 40px;margin-bottom:24px}
.pair-code{font-size:36px;font-weight:800;letter-spacing:8px;font-family:monospace;color:var(--accent)}
.pair-copy{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:12px 24px;color:var(--text);font-size:14px;cursor:pointer;margin-bottom:32px}
.pair-copy:active{background:var(--accent);border-color:var(--accent)}
.pair-input{width:100%;max-width:280px;padding:18px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;color:var(--text);font-size:20px;text-align:center;letter-spacing:4px;text-transform:uppercase;margin-bottom:16px}
.pair-input::placeholder{letter-spacing:normal;text-transform:none}
.pair-input:focus{outline:none;border-color:var(--accent)}
.pair-submit{width:100%;max-width:280px;padding:18px;background:var(--accent);border:none;border-radius:14px;color:#fff;font-size:16px;font-weight:600;cursor:pointer}
.pair-submit:disabled{opacity:.5}
.pair-status{margin-top:16px;padding:14px 20px;border-radius:12px;font-size:14px}
.pair-status.success{background:rgba(34,197,94,.15);color:var(--green)}
.pair-status.error{background:rgba(239,68,68,.15);color:#ef4444}
.pair-or{margin:24px 0;color:var(--muted);font-size:14px}
.pair-link{color:var(--accent);cursor:pointer;font-size:14px}

/* Partner Badge */
.partner-badge{display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;margin:16px}
.partner-badge-icon{font-size:24px}
.partner-badge-info{text-align:left}
.partner-badge-name{font-size:14px;font-weight:600}
.partner-badge-status{font-size:12px;color:var(--green)}

/* Rest of styles */
.hdr{padding:16px;display:flex;justify-content:space-between;align-items:center}
.logo{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.user-info{display:flex;align-items:center;gap:8px}
.user-name{font-size:14px;color:var(--text2)}
.user-linked{font-size:12px;color:var(--green)}
.p16{padding:0 16px 16px}
.back{padding:14px 16px;font-size:14px;color:var(--text2);cursor:pointer}
h2{font-size:22px;font-weight:800;margin-bottom:8px}
.desc{font-size:14px;color:var(--text2);margin-bottom:18px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:22px}
.card{padding:18px;border-radius:18px;cursor:pointer;transition:transform .15s}
.card:active{transform:scale(.96)}
.c1{background:linear-gradient(135deg,#0891b2,#06b6d4)}.c2{background:linear-gradient(135deg,#e11d48,#f43f5e)}.c3{background:linear-gradient(135deg,#7c3aed,#8b5cf6)}.c4{background:linear-gradient(135deg,#d97706,#f59e0b)}.c5{background:linear-gradient(135deg,#059669,#10b981)}.c6{background:linear-gradient(135deg,#db2777,#ec4899)}.c7{background:linear-gradient(135deg,#f472b6,#f9a8d4)}.c8{background:linear-gradient(135deg,#a855f7,#c084fc)}
.card-i{font-size:32px;margin-bottom:8px}.card-t{font-size:15px;font-weight:700}.card-d{font-size:12px;opacity:.9;margin-top:4px}
.lv{padding:18px;border-radius:16px;cursor:pointer;margin-bottom:14px;transition:transform .15s}.lv:active{transform:scale(.98)}
.l1{background:linear-gradient(135deg,#059669,#10b981)}.l2{background:linear-gradient(135deg,#2563eb,#3b82f6)}.l3{background:linear-gradient(135deg,#d97706,#f59e0b)}.l4{background:linear-gradient(135deg,#db2777,#ec4899)}.l5{background:linear-gradient(135deg,#dc2626,#ef4444)}.l6{background:linear-gradient(135deg,#7f1d1d,#991b1b)}
.lv-h{display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px;opacity:.85}.lv-t{font-size:18px;font-weight:700}.lv-d{font-size:13px;opacity:.9;margin-top:4px}
.pb{height:6px;background:rgba(255,255,255,.2);border-radius:3px;margin-top:12px;overflow:hidden}.pb-f{height:100%;background:#fff;border-radius:3px;opacity:.9;transition:width .4s}
.qc{padding:16px}.qp{display:flex;gap:3px;margin-bottom:18px}.qp-d{flex:1;height:5px;border-radius:3px;background:rgba(255,255,255,.15)}.qp-d.done{background:var(--green)}.qp-d.cur{background:var(--accent)}
.qcard{background:var(--bg2);border:1px solid var(--border);border-radius:24px;padding:28px 24px;text-align:center;min-height:360px;display:flex;flex-direction:column;align-items:center}
.qbadge{padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;margin-bottom:20px}
.qcard.l1 .qbadge{background:rgba(16,185,129,.2);color:#34d399}.qcard.l2 .qbadge{background:rgba(59,130,246,.2);color:#60a5fa}.qcard.l3 .qbadge{background:rgba(245,158,11,.2);color:#fbbf24}.qcard.l4 .qbadge{background:rgba(236,72,153,.2);color:#f472b6}.qcard.l5 .qbadge{background:rgba(239,68,68,.2);color:#f87171}.qcard.l6 .qbadge{background:rgba(153,27,27,.3);color:#fca5a5}
.qicon{font-size:48px;margin-bottom:20px}.qtext{font-size:20px;font-weight:600;flex:1;display:flex;align-items:center;line-height:1.4}.qhint{font-size:13px;color:var(--muted);margin-top:20px;padding:12px 16px;background:rgba(255,255,255,.04);border-radius:14px}
.qnav{display:flex;gap:14px;margin-top:20px;width:100%}.qbtn{flex:1;padding:16px;border-radius:14px;border:none;font-size:15px;font-weight:600;cursor:pointer}.qbtn:active{transform:scale(.97)}.qbtn.sec{background:var(--bg2);color:var(--text);border:1px solid var(--border)}.qbtn.pri{background:var(--accent);color:#fff}
.tabs{display:flex;gap:8px;margin-bottom:18px}.tab{flex:1;padding:14px 8px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;text-align:center;font-size:13px;font-weight:600;cursor:pointer}.tab.on{background:var(--accent);border-color:var(--accent)}
.rlt{display:flex;flex-direction:column;align-items:center;padding:24px 0}
.whl{width:260px;height:260px;border-radius:50%;background:conic-gradient(from 0deg,#e11d48,#db2777,#a855f7,#7c3aed,#2563eb,#0891b2,#059669,#d97706,#e11d48);display:flex;align-items:center;justify-content:center;position:relative;box-shadow:0 0 60px rgba(236,72,153,.3)}.whl::before{content:'';position:absolute;width:190px;height:190px;background:var(--bg);border-radius:50%}.whl-c{position:relative;z-index:1;text-align:center;padding:12px}.whl-n{font-size:16px;font-weight:700;margin-bottom:6px}.whl-d{font-size:12px;color:var(--text2)}
.sbtn{margin-top:24px;padding:16px 48px;background:linear-gradient(135deg,#e11d48,#db2777);border:none;border-radius:30px;color:#fff;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 6px 30px rgba(225,29,72,.4)}.sbtn:active{transform:scale(.96)}
.spin .whl{animation:spin 3s cubic-bezier(.17,.67,.12,.99) forwards}@keyframes spin{from{transform:rotate(0)}to{transform:rotate(1800deg)}}
.rcard{margin-top:24px;padding:18px;background:var(--bg2);border:1px solid var(--border);border-radius:18px;width:100%;cursor:pointer}.rcard:active{transform:scale(.98)}.rcard h3{font-size:16px;margin-bottom:8px}.rcard p{font-size:13px;color:var(--text2)}
.dice-c{display:flex;flex-direction:column;align-items:center;padding:24px 0}.dice-p{display:flex;gap:18px;margin-bottom:24px}.dice{width:130px;height:100px;background:var(--bg2);border:2px solid var(--border);border-radius:18px;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:14px}.dice-l{font-size:12px;color:var(--muted);margin-bottom:8px}.dice-v{font-size:16px;font-weight:700;text-align:center}.dice.a{border-color:var(--accent)}.dice.a .dice-v{color:var(--accent)}.dice.b{border-color:var(--blue)}.dice.b .dice-v{color:var(--blue)}.dice.roll{animation:shake .6s}@keyframes shake{0%,100%{transform:rotate(0)}25%{transform:rotate(-12deg)}75%{transform:rotate(12deg)}}
.dres{text-align:center;padding:18px;background:var(--bg2);border:1px solid var(--border);border-radius:18px;width:100%}.dres-t{font-size:20px;font-weight:700;margin-bottom:8px}.dres-s{font-size:14px;color:var(--text2)}
.pgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}.pcard{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:16px;cursor:pointer;text-align:center}.pcard:active{transform:scale(.96)}.pcard-i{font-size:36px;margin-bottom:10px}.pcard-n{font-size:13px;font-weight:700;margin-bottom:8px}.pdiff{display:flex;gap:5px;justify-content:center}.pdot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.2)}.pdot.on{background:var(--yellow)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.94);z-index:200;display:none;align-items:center;justify-content:center;padding:16px}.modal.show{display:flex}.modal-c{background:var(--bg2);border:1px solid var(--border);border-radius:24px;padding:24px;width:100%;max-width:420px;max-height:88vh;overflow-y:auto}.modal-h{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px}.modal-i{font-size:52px}.modal-x{background:none;border:none;color:var(--muted);font-size:28px;cursor:pointer}.modal-t{font-size:24px;font-weight:800;margin-bottom:8px}.modal-diff{display:flex;gap:6px;align-items:center;margin-bottom:20px}.modal-diff .pdot{width:12px;height:12px}
.msec{margin-bottom:18px}.msec h4{font-size:13px;color:var(--accent);margin-bottom:8px;text-transform:uppercase}.msec p{font-size:14px;color:var(--text2);line-height:1.6}.msteps{background:var(--bg3);border-radius:14px;padding:14px}.mstep{display:flex;gap:12px;margin-bottom:10px}.mstep:last-child{margin-bottom:0}.mstep-n{width:28px;height:28px;border-radius:50%;background:var(--accent);color:#fff;font-size:13px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}.mstep-t{font-size:14px;color:var(--text2)}.mtip{padding:14px;background:rgba(251,191,36,.12);border-left:4px solid var(--yellow);border-radius:0 12px 12px 0;margin-bottom:18px}.mtip-t{font-size:12px;color:var(--yellow);font-weight:700;margin-bottom:6px}.mtip-c{font-size:13px;color:var(--text2)}.mvars{margin-top:14px}.mvar{display:inline-block;padding:8px 14px;background:var(--bg);border-radius:20px;font-size:12px;margin:0 8px 8px 0}
n{width:22px;height:22px;border-radius:50%;background:var(--accent);color:#fff;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}.tip-step-t{font-size:12px;color:var(--text2)}
.idea-sec{margin-bottom:22px}.idea-sec h3{font-size:17px;margin-bottom:12px}.idea-tags{display:flex;flex-wrap:wrap;gap:10px}.idea-tag{padding:10px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:20px;font-size:13px}
.cal-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}.cal-m{font-size:18px;font-weight:700}.cal-nav{width:36px;height:36px;border-radius:10px;background:var(--bg2);border:1px solid var(--border);color:var(--text);font-size:16px;cursor:pointer}.cal-w{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:8px}.cal-wd{text-align:center;font-size:11px;color:var(--muted);padding:8px 0}.cal-days{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}.cal-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:10px;font-size:13px;cursor:pointer;background:var(--bg2);border:2px solid transparent;position:relative;font-weight:500}.cal-day:active{transform:scale(.92)}.cal-day.other{opacity:.3}.cal-day.today{border-color:var(--accent)}.cal-day.has::after{content:'';position:absolute;bottom:4px;width:6px;height:6px;border-radius:50%;background:var(--accent)}.cal-day.period{background:rgba(239,68,68,.35)}.cal-day.fertile{background:rgba(34,197,94,.35)}.cal-day.ovul{background:rgba(251,191,36,.5)}
.cal-e{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:14px;margin-top:12px}.cal-e-h{display:flex;justify-content:space-between;margin-bottom:8px}.cal-e-d{font-size:14px;font-weight:600}.cal-e-type{padding:5px 10px;border-radius:12px;font-size:11px;font-weight:600;background:rgba(255,107,157,.15);color:var(--accent)}.cal-e-c{font-size:13px;color:var(--text2)}.cal-add{position:fixed;bottom:100px;right:20px;width:58px;height:58px;border-radius:50%;background:var(--accent);border:none;font-size:28px;color:#fff;cursor:pointer;box-shadow:0 6px 24px rgba(255,107,157,.5);z-index:50}
.preg-wk{background:var(--bg2);border:1px solid var(--border);border-radius:18px;padding:20px;margin-bottom:16px}.preg-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}.preg-w{font-size:28px;font-weight:800;color:var(--accent)}.preg-size{text-align:right}.preg-size-i{font-size:24px}.preg-size-t{font-size:12px;color:var(--text2)}.preg-dev{font-size:14px;color:var(--text2);margin-bottom:14px;line-height:1.6}.preg-tips{background:var(--bg3);border-radius:12px;padding:14px}.preg-tip{font-size:13px;color:var(--text2);padding:6px 0;border-bottom:1px solid var(--border)}.preg-tip:last-child{border:none}.preg-setup{background:var(--bg2);border:1px solid var(--border);border-radius:18px;padding:28px;text-align:center}.preg-setup h3{font-size:20px;margin-bottom:16px}.preg-input{width:100%;padding:16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:16px;margin-bottom:14px}.preg-btn{width:100%;padding:16px;background:var(--accent);border:none;border-radius:12px;color:#fff;font-size:16px;font-weight:600;cursor:pointer}
.cycle-legend{display:flex;gap:16px;margin-bottom:18px;flex-wrap:wrap}.cycle-leg{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2)}.cycle-dot{width:12px;height:12px;border-radius:50%}.cycle-dot.period{background:rgba(239,68,68,.7)}.cycle-dot.fertile{background:rgba(34,197,94,.7)}.cycle-dot.ovul{background:rgba(251,191,36,.8)}.cycle-info{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px;margin-top:16px}.cycle-info h4{font-size:15px;margin-bottom:12px}.cycle-info p{font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:10px}
.checklist{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px;margin-bottom:14px}.checklist h4{font-size:15px;margin-bottom:14px}.check-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);font-size:14px}.check-item:last-child{border:none}.check-box{width:24px;height:24px;border-radius:8px;border:2px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}.check-box.done{background:var(--green);border-color:var(--green)}
.bnav{position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,15,.97);backdrop-filter:blur(20px);border-top:1px solid var(--border);padding:10px 0 calc(10px + env(safe-area-inset-bottom));z-index:100}.bnav-items{display:flex;justify-content:space-around;max-width:440px;margin:0 auto}.bnav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px 10px;background:none;border:none;color:var(--muted);font-size:11px;font-weight:600;cursor:pointer}.bnav-item.on{color:var(--accent)}.bnav-i{font-size:22px}
.toast{position:fixed;bottom:110px;left:50%;transform:translateX(-50%) translateY(60px);padding:14px 24px;background:#fff;color:#000;border-radius:16px;font-size:14px;font-weight:600;opacity:0;transition:all .3s;z-index:999}.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.cmodal{position:fixed;inset:0;background:rgba(0,0,0,.94);z-index:200;display:none;align-items:flex-end;justify-content:center}.cmodal.show{display:flex}.cmodal-c{background:var(--bg2);border-radius:24px 24px 0 0;padding:24px;width:100%;max-width:440px}.cmodal-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.cmodal-t{font-size:20px;font-weight:700}.cmodal-x{background:none;border:none;color:var(--text);font-size:24px;cursor:pointer}.fg{margin-bottom:16px}.fg-l{font-size:13px;color:var(--text2);margin-bottom:6px;display:block}.fg-i{width:100%;padding:14px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:15px}.fg-i:focus{outline:none;border-color:var(--accent)}.type-btns{display:flex;gap:10px}.type-btn{flex:1;padding:14px;border-radius:12px;border:2px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-weight:600;cursor:pointer}.type-btn.on{border-color:var(--accent);background:rgba(255,107,157,.12)}.mood-btns{display:flex;gap:10px;justify-content:center}.mood-btn{width:48px;height:48px;border-radius:50%;border:2px solid var(--border);background:var(--bg);font-size:22px;cursor:pointer}.mood-btn.on{border-color:var(--accent);background:rgba(255,107,157,.12)}.save-btn{width:100%;padding:16px;background:var(--accent);border:none;border-radius:14px;color:#fff;font-size:16px;font-weight:600;cursor:pointer;margin-top:10px}
</style>
</head>
<body>
<div class="app">
<!-- Auth Screen -->
<div class="screen active" id="authScreen">
<div class="auth-screen">
<div class="auth-logo">üíï</div>
<div class="auth-title">Explore</div>
<div class="auth-sub">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–∞—Ä</div>
<div class="auth-btns">
<button class="auth-btn primary" onclick="showRegister()">–Ø –ø–µ—Ä–≤—ã–π –≤ –ø–∞—Ä–µ</button>
<button class="auth-btn secondary" onclick="showJoin()">–ü–∞—Ä—Ç–Ω—ë—Ä —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</button>
</div>
</div>
</div>

<!-- Register Screen (Get Code) -->
<div class="screen" id="registerScreen">
<div class="pair-screen">
<div class="pair-back" onclick="showAuth()">‚Üê –ù–∞–∑–∞–¥</div>
<div class="pair-icon">üîó</div>
<div class="pair-title">–í–∞—à –∫–æ–¥ –ø–∞—Ä—ã</div>
<div class="pair-desc">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä—É, —á—Ç–æ–±—ã —Å–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã</div>
<div class="pair-code-box">
<div class="pair-code" id="myPairCode">------</div>
</div>
<button class="pair-copy" onclick="copyCode()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
<button class="auth-btn primary" onclick="continueAlone()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
<div class="pair-or">–∏–ª–∏</div>
<div class="pair-link" onclick="showJoin()">–£ –º–µ–Ω—è —É–∂–µ –µ—Å—Ç—å –∫–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞</div>
</div>
</div>

<!-- Join Screen (Enter Code) -->
<div class="screen" id="joinScreen">
<div class="pair-screen">
<div class="pair-back" onclick="showAuth()">‚Üê –ù–∞–∑–∞–¥</div>
<div class="pair-icon">ü§ù</div>
<div class="pair-title">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥</div>
<div class="pair-desc">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Å–ª–∞–ª –≤–∞—à –ø–∞—Ä—Ç–Ω—ë—Ä</div>
<input type="text" class="pair-input" id="joinCodeInput" placeholder="XXXXXX" maxlength="6" oninput="this.value=this.value.toUpperCase()">
<button class="pair-submit" id="joinBtn" onclick="joinPartner()">–°–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã</button>
<div id="joinStatus"></div>
<div class="pair-or">–∏–ª–∏</div>
<div class="pair-link" onclick="showRegister()">–ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–π –∫–æ–¥</div>
</div>
</div>

<!-- Home Screen -->
<div class="screen" id="homeScreen">
<div class="hdr">
<div class="logo">Explore</div>
<div class="user-info">
<div>
<div class="user-name" id="userName"></div>
<div class="user-linked" id="partnerStatus"></div>
</div>
</div>
</div>
<div id="partnerBadge"></div>
<div class="p16">
<div class="grid">
<div class="card c1" onclick="go('questionsScreen')"><div class="card-i">üí¨</div><div class="card-t">200 –≤–æ–ø—Ä–æ—Å–æ–≤</div><div class="card-d">6 —É—Ä–æ–≤–Ω–µ–π</div></div>
<div class="card c2" onclick="go('kamaScreen')"><div class="card-i">üî•</div><div class="card-t">50 –ø–æ–∑</div><div class="card-d">–ö–∞–º–∞—Å—É—Ç—Ä–∞</div></div>
<div class="card c3" onclick="go('testsScreen')"><div class="card-i">üíï</div><div class="card-t">10 —Ç–µ—Å—Ç–æ–≤</div><div class="card-d">–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å</div></div>
<div class="card c4" onclick="go('calendarScreen')"><div class="card-i">üìÖ</div><div class="card-t">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div><div class="card-d">–ò—Å—Ç–æ—Ä–∏—è</div></div>
<div class="card c5" onclick="go('tipsScreen')"><div class="card-i">üí°</div><div class="card-t">20 —Å–æ–≤–µ—Ç–æ–≤</div><div class="card-d">–¢–µ—Ö–Ω–∏–∫–∏</div></div>
<div class="card c6" onclick="go('ideasScreen')"><div class="card-i">‚ú®</div><div class="card-t">100 –∏–¥–µ–π</div><div class="card-d">–í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ</div></div>
</div>
<h2>ü§∞ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
<p class="desc">–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å –∏ –∑–¥–æ—Ä–æ–≤—å–µ</p>
<div class="grid">
<div class="card c7" onclick="go('pregScreen')"><div class="card-i">üë∂</div><div class="card-t">–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å</div><div class="card-d">40 –Ω–µ–¥–µ–ª—å</div></div>
<div class="card c8" onclick="go('cycleScreen')"><div class="card-i">üåô</div><div class="card-t">–¶–∏–∫–ª</div><div class="card-d">–§–µ—Ä—Ç–∏–ª—å–Ω–æ—Å—Ç—å</div></div>
</div>
</div>
</div>
<div class="screen" id="questionsScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2 id="qTitle">üí¨ 200 –≤–æ–ø—Ä–æ—Å–æ–≤</h2><p class="desc">–û—Ç –ª—ë–≥–∫–∏—Ö –¥–æ –∑–∞–ø—Ä–µ—Ç–Ω—ã—Ö</p><div id="lvList"></div></div></div>
<div class="screen" id="qPlayScreen"><div class="back" onclick="go('questionsScreen')">‚Üê –£—Ä–æ–≤–Ω–∏</div><div class="qc" id="qContainer"></div></div>
<div class="screen" id="kamaScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üî• 50 –ø–æ–∑</h2><div class="tabs"><div class="tab on" onclick="kamaTab('rlt',this)">üé∞ –†—É–ª–µ—Ç–∫–∞</div><div class="tab" onclick="kamaTab('dice',this)">üé≤ –ö—É–±–∏–∫–∏</div><div class="tab" onclick="kamaTab('pos',this)">üìñ –í—Å–µ</div></div><div id="kamaC"></div></div></div>
<div class="screen" id="testsScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üíï 10 —Ç–µ—Å—Ç–æ–≤</h2><p class="desc">–£–∑–Ω–∞–π—Ç–µ –¥—Ä—É–≥ –¥—Ä—É–≥–∞</p><div id="testsList"></div></div></div>
<div class="screen" id="testPlayScreen"><div class="back" onclick="go('testsScreen')">‚Üê –¢–µ—Å—Ç—ã</div><div class="p16" id="testC"></div></div>
<div class="screen" id="calendarScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2><div id="calC"></div></div><button class="cal-add" onclick="openCM()">+</button></div>
<div class="screen" id="tipsScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üí° 20 —Å–æ–≤–µ—Ç–æ–≤</h2><div id="tipsC"></div></div></div>
<div class="screen" id="ideasScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>‚ú® 100 –∏–¥–µ–π</h2><div id="ideasC"></div></div></div>
<div class="screen" id="pregScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>ü§∞ –ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å</h2><div id="pregC"></div></div></div>
<div class="screen" id="cycleScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üåô –¶–∏–∫–ª</h2><div id="cycleC"></div></div></div>
</div>
<nav class="bnav" id="mainNav" style="display:none"><div class="bnav-items">
<button class="bnav-item on" onclick="go('homeScreen')" id="nav0"><span class="bnav-i">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></button>
<button class="bnav-item" onclick="go('questionsScreen')" id="nav1"><span class="bnav-i">üí¨</span><span>–í–æ–ø—Ä–æ—Å—ã</span></button>
<button class="bnav-item" onclick="go('kamaScreen')" id="nav2"><span class="bnav-i">üî•</span><span>–ü–æ–∑—ã</span></button>
<button class="bnav-item" onclick="go('calendarScreen')" id="nav3"><span class="bnav-i">üìÖ</span><span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
<button class="bnav-item" onclick="go('pregScreen')" id="nav4"><span class="bnav-i">ü§∞</span><span>–ú–∞–ª—ã—à</span></button>
</div></nav>
<div class="modal" id="posModal"><div class="modal-c" id="posModalC"></div></div>
<div class="cmodal" id="calModal"><div class="cmodal-c">
<div class="cmodal-h"><div class="cmodal-t">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</div><button class="cmodal-x" onclick="closeCM()">‚úï</button></div>
<div class="fg"><label class="fg-l">–¢–∏–ø</label><div class="type-btns"><div class="type-btn on" onclick="selType('intimate',this)">üíï –ë–ª–∏–∑–æ—Å—Ç—å</div><div class="type-btn" onclick="selType('special',this)">‚≠ê –û—Å–æ–±–µ–Ω–Ω–æ–µ</div></div></div>
<div class="fg"><label class="fg-l">–ß—Ç–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª–∏?</label><input type="text" class="fg-i" id="calTitle" placeholder="–ù–æ–≤–∞—è –ø–æ–∑–∞..."></div>
<div class="fg"><label class="fg-l">–ó–∞–º–µ—Ç–∫–∏</label><textarea class="fg-i" id="calNotes" rows="2" placeholder="–ö–∞–∫ –ø—Ä–æ—à–ª–æ?"></textarea></div>
<div class="fg"><label class="fg-l">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</label><div class="mood-btns"><button class="mood-btn" onclick="selMood('üî•',this)">üî•</button><button class="mood-btn on" onclick="selMood('üòç',this)">üòç</button><button class="mood-btn" onclick="selMood('üòä',this)">üòä</button><button class="mood-btn" onclick="selMood('üí≠',this)">üí≠</button></div></div>
<button class="save-btn" onclick="saveCal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div></div>
<div class="toast" id="toast"></div>
<script>
// ===== CONFIG =====
const API = 'explore-api-production.up.railway.app/api'; // <- –ó–ê–ú–ï–ù–ò

// ===== TELEGRAM =====
const tg = window.Telegram?.WebApp;
let tgUser = null;
let userId = null;

if (tg) {
  tg.ready();
  tg.expand();
  if (tg.initDataUnsafe?.user) {
    tgUser = tg.initDataUnsafe.user;
    userId = String(tgUser.id);
  }
}

// ===== STATE =====
let currentUser = null;
let partner = null;
let D = { questionLevels: [], positions: [], tests: [], tips: [], ideas: [], pregnancyInfo: {} };
let S = { progress: {}, calendar: [], pregnancy: null, cycle: [] };
let curLv, curQi = 0, curTest, curTi = 0, testRes = [];
let calMonth = new Date().getMonth(), calYear = new Date().getFullYear();
let calType = 'intimate', calMood = 'üòç';
let cycleMonth = new Date().getMonth(), cycleYear = new Date().getFullYear();

// ===== AUTH FLOW =====
async function checkAuth() {
  if (!userId) {
    // Dev mode without Telegram
    userId = 'dev_' + Date.now();
    tgUser = { first_name: '–¢–µ—Å—Ç', id: userId };
  }
  
  try {
    const r = await fetch(API + '/user/' + userId + '/status');
    const data = await r.json();
    
    if (data.registered) {
      currentUser = data.user;
      partner = data.partner;
      enterApp();
    }
    // else stay on auth screen
  } catch (e) {
    console.log('API error, show auth');
  }
}

function showAuth() {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('authScreen').classList.add('active');
  document.getElementById('mainNav').style.display = 'none';
}

async function showRegister() {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('registerScreen').classList.add('active');
  
  // Register and get code
  try {
    const r = await fetch(API + '/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        telegramId: userId,
        name: tgUser?.first_name || '–ì–æ—Å—Ç—å',
        username: tgUser?.username || null
      })
    });
    const data = await r.json();
    
    if (data.success) {
      currentUser = data.user;
      document.getElementById('myPairCode').textContent = data.pairCode;
    } else if (data.error === 'Already registered') {
      // User exists, get their code
      const status = await fetch(API + '/user/' + userId + '/status');
      const statusData = await status.json();
      if (statusData.pairCode) {
        document.getElementById('myPairCode').textContent = statusData.pairCode;
        currentUser = statusData.user;
        partner = statusData.partner;
      }
    }
  } catch (e) {
    toast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  }
}

function showJoin() {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('joinScreen').classList.add('active');
  document.getElementById('joinCodeInput').focus();
}

async function joinPartner() {
  const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
  if (code.length !== 6) {
    showJoinStatus('–ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
    return;
  }
  
  try {
    const r = await fetch(API + '/join', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        telegramId: userId,
        name: tgUser?.first_name || '–ì–æ—Å—Ç—å',
        username: tgUser?.username || null,
        pairCode: code
      })
    });
    const data = await r.json();
    
    if (data.success) {
      currentUser = data.user;
      partner = data.partner;
      showJoinStatus('‚úÖ –°–≤—è–∑–∞–Ω–æ —Å ' + partner.name + '!', 'success');
      if (tg) tg.HapticFeedback?.notificationOccurred('success');
      setTimeout(enterApp, 1500);
    } else {
      showJoinStatus(data.error === 'Invalid code' ? '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥' : 
                     data.error === 'Code already used' ? '–ö–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω' :
                     data.error === 'Already registered' ? '–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã' : '–û—à–∏–±–∫–∞', 'error');
      if (tg) tg.HapticFeedback?.notificationOccurred('error');
    }
  } catch (e) {
    showJoinStatus('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
  }
}

function showJoinStatus(msg, type) {
  const el = document.getElementById('joinStatus');
  el.className = 'pair-status ' + type;
  el.textContent = msg;
}

function copyCode() {
  const code = document.getElementById('myPairCode').textContent;
  navigator.clipboard?.writeText(code);
  toast('üìã –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
  if (tg) tg.HapticFeedback?.impactOccurred('light');
}

function continueAlone() {
  enterApp();
}

function enterApp() {
  document.getElementById('mainNav').style.display = 'block';
  go('homeScreen');
  
  // Update header
  document.getElementById('userName').textContent = currentUser?.name || tgUser?.first_name || '';
  
  if (partner) {
    document.getElementById('partnerStatus').textContent = 'üíï ' + partner.name;
    document.getElementById('partnerBadge').innerHTML = 
      '<div class="partner-badge"><div class="partner-badge-icon">üíë</div><div class="partner-badge-info"><div class="partner-badge-name">–ü–∞—Ä–∞ —Å ' + partner.name + '</div><div class="partner-badge-status">–ê–∫–∫–∞—É–Ω—Ç—ã —Å–≤—è–∑–∞–Ω—ã</div></div></div>';
  } else if (currentUser?.pairCode) {
    document.getElementById('partnerStatus').textContent = '–ö–æ–¥: ' + currentUser.pairCode;
    document.getElementById('partnerBadge').innerHTML = 
      '<div class="partner-badge" onclick="showRegister()"><div class="partner-badge-icon">üîó</div><div class="partner-badge-info"><div class="partner-badge-name">–°–≤—è–∑–∞—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞</div><div class="partner-badge-status">–ö–æ–¥: ' + currentUser.pairCode + '</div></div></div>';
  }
  
  loadData();
}

// ===== DATA =====
async function loadData() {
  try {
    const r = await fetch(API + '/content');
    D = await r.json();
  } catch (e) { console.log('Content error'); }

  if (userId && currentUser) {
    try {
      const r = await fetch(API + '/user/' + userId);
      const data = await r.json();
      if (data.progress) S.progress = data.progress;
      if (data.calendar) S.calendar = data.calendar;
      if (data.pregnancy) S.pregnancy = data.pregnancy;
      if (data.cycles) S.cycle = data.cycles;
    } catch (e) {
      S = JSON.parse(localStorage.getItem('exploreMega') || '{}');
    }
  } else {
    S = JSON.parse(localStorage.getItem('exploreMega') || '{}');
  }
  
  S.progress = S.progress || {};
  S.calendar = S.calendar || [];
  S.cycle = S.cycle || [];
  init();
}

function saveState() {
  localStorage.setItem('exploreMega', JSON.stringify(S));
  if (userId && currentUser) {
    fetch(API + '/user/' + userId + '/sync', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ progress: S.progress, calendar: S.calendar, pregnancy: S.pregnancy, cycles: S.cycle })
    }).catch(() => {});
  }
}

function init() {
  if (D.questionLevels?.length) renderLevels();
  renderRoulette();
  if (D.tests?.length) renderTests();
  if (D.tips?.length) renderTips();
  if (D.ideas?.length) renderIdeas();
  renderCalendar();
  renderPregnancy();
  renderCycle();
}

// ===== NAV =====
function go(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.bnav-item').forEach(n => n.classList.remove('on'));
  const m = { homeScreen: 'nav0', questionsScreen: 'nav1', qPlayScreen: 'nav1', kamaScreen: 'nav2', calendarScreen: 'nav3', pregScreen: 'nav4', cycleScreen: 'nav4' };
  if (m[id]) document.getElementById(m[id]).classList.add('on');
  if (tg) tg.HapticFeedback?.impactOccurred('light');
}

function toast(m) { const t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); }

// ===== QUESTIONS =====
function renderLevels() {
  let total = 0; D.questionLevels.forEach(l => total += l.questions.length);
  document.getElementById('qTitle').textContent = 'üí¨ ' + total + ' –≤–æ–ø—Ä–æ—Å–æ–≤';
  document.getElementById('lvList').innerHTML = D.questionLevels.map(l => {
    const p = S.progress[l.id] || 0;
    return '<div class="lv ' + l.color + '" onclick="startLv(' + l.id + ')"><div class="lv-h"><span>–£—Ä–æ–≤–µ–Ω—å ' + l.id + '</span><span>' + p + '/' + l.questions.length + '</span></div><div class="lv-t">' + l.icon + ' ' + l.title + '</div><div class="lv-d">' + l.desc + '</div><div class="pb"><div class="pb-f" style="width:' + (p / l.questions.length * 100) + '%"></div></div></div>';
  }).join('');
}

function startLv(id) { curLv = D.questionLevels.find(l => l.id === id); curQi = S.progress[id] || 0; if (curQi >= curLv.questions.length) curQi = 0; renderQ(); go('qPlayScreen'); }

function renderQ() {
  const l = curLv, q = l.questions[curQi];
  let dots = ''; for (let i = 0; i < l.questions.length; i++) dots += '<div class="qp-d' + (i < curQi ? ' done' : '') + (i === curQi ? ' cur' : '') + '"></div>';
  document.getElementById('qContainer').innerHTML = '<div class="qp">' + dots + '</div><div class="qcard ' + l.color + '"><div class="qbadge">' + l.icon + ' ' + l.title + '</div><div class="qicon">üí¨</div><div class="qtext">' + q.q + '</div>' + (q.h ? '<div class="qhint">üí° ' + q.h + '</div>' : '') + '</div><div class="qnav"><button class="qbtn sec" onclick="prevQ()">‚Üê –ù–∞–∑–∞–¥</button><button class="qbtn pri" onclick="nextQ()">–û—Ç–≤–µ—Ç–∏–ª–∏ ‚Üí</button></div>';
}

function nextQ() { curQi++; S.progress[curLv.id] = curQi; saveState(); if (curQi >= curLv.questions.length) { toast('üéâ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!'); renderLevels(); go('questionsScreen'); } else renderQ(); }
function prevQ() { if (curQi > 0) { curQi--; renderQ(); } else go('questionsScreen'); }

// ===== KAMA SUTRA =====
function kamaTab(t, el) { document.querySelectorAll('.tabs .tab').forEach(x => x.classList.remove('on')); el.classList.add('on'); if (t === 'rlt') renderRoulette(); else if (t === 'dice') renderDice(); else renderPositions(); }

function renderRoulette() {
  document.getElementById('kamaC').innerHTML = '<div class="rlt" id="rCont"><div class="whl"><div class="whl-c"><div class="whl-n" id="wN">–ö—Ä—É—Ç–∏—Ç–µ!</div><div class="whl-d" id="wD">–í—ã–ø–∞–¥–µ—Ç –ø–æ–∑–∞</div></div></div><button class="sbtn" onclick="spin()">üé∞ –ö—Ä—É—Ç–∏—Ç—å</button><div class="rcard" id="rCard" style="display:none"></div></div>';
}

function spin() {
  if (!D.positions?.length) return toast('–ó–∞–≥—Ä—É–∑–∫–∞...');
  const p = D.positions[Math.floor(Math.random() * D.positions.length)];
  document.getElementById('rCont').classList.add('spin');
  document.getElementById('wN').textContent = '...';
  document.getElementById('wD').textContent = '';
  document.getElementById('rCard').style.display = 'none';
  if (tg) tg.HapticFeedback?.impactOccurred('medium');
  setTimeout(() => {
    document.getElementById('rCont').classList.remove('spin');
    document.getElementById('wN').textContent = p.icon + ' ' + p.name;
    document.getElementById('wD').textContent = '–ù–∞–∂–º–∏—Ç–µ ‚Üì';
    document.getElementById('rCard').style.display = 'block';
    document.getElementById('rCard').innerHTML = '<h3>' + p.icon + ' ' + p.name + '</h3><p>' + p.desc + '</p>';
    document.getElementById('rCard').onclick = () => showPos(p.name);
    if (tg) tg.HapticFeedback?.notificationOccurred('success');
  }, 3000);
}

function renderDice() {
  document.getElementById('kamaC').innerHTML = '<div class="dice-c"><div class="dice-p"><div class="dice a" id="dA"><div class="dice-l">–î–µ–π—Å—Ç–≤–∏–µ</div><div class="dice-v">üé≤</div></div><div class="dice b" id="dB"><div class="dice-l">–ö—É–¥–∞</div><div class="dice-v">üé≤</div></div></div><div class="dres" id="dR"><div class="dres-t">–ë—Ä–æ—Å—å—Ç–µ!</div><div class="dres-s">üòè</div></div><button class="sbtn" onclick="roll()">üé≤ –ë—Ä–æ—Å–∏—Ç—å</button></div>';
}

function roll() {
  const actions = ["–ü–æ—Ü–µ–ª—É–π", "–õ–∏–∑–Ω–∏", "–ü–æ–≥–ª–∞–¥—å", "–ü–æ–¥—É–π", "–£–∫—É—Å–∏", "–ú–∞—Å—Å–∏—Ä—É–π", "–ü–æ—â–µ–∫–æ—á–∏", "–®–µ–ø–Ω–∏"];
  const parts = ["—à–µ—é", "–≥—É–±—ã", "—É—Ö–æ", "–≥—Ä—É–¥—å", "–∂–∏–≤–æ—Ç", "–±–µ–¥—Ä–æ", "—Å–ø–∏–Ω—É", "–ø–æ–ø—É"];
  const d1 = document.getElementById('dA'), d2 = document.getElementById('dB');
  d1.classList.add('roll'); d2.classList.add('roll');
  if (tg) tg.HapticFeedback?.impactOccurred('medium');
  setTimeout(() => {
    d1.classList.remove('roll'); d2.classList.remove('roll');
    const a = actions[Math.floor(Math.random() * actions.length)];
    const b = parts[Math.floor(Math.random() * parts.length)];
    d1.querySelector('.dice-v').textContent = a;
    d2.querySelector('.dice-v').textContent = b;
    document.getElementById('dR').innerHTML = '<div class="dres-t">' + a + ' ' + b + '</div><div class="dres-s">–í—ã–ø–æ–ª–Ω—è–π—Ç–µ! üòè</div>';
  }, 600);
}

function renderPositions() {
  if (!D.positions?.length) return;
  let h = '<div class="pgrid">';
  D.positions.forEach(p => {
    let dots = ''; for (let d = 1; d <= 3; d++) dots += '<div class="pdot' + (d <= p.diff ? ' on' : '') + '"></div>';
    h += '<div class="pcard" onclick="showPos(\'' + p.name.replace(/'/g, "\\'") + '\')"><div class="pcard-i">' + p.icon + '</div><div class="pcard-n">' + p.name + '</div><div class="pdiff">' + dots + '</div></div>';
  });
  document.getElementById('kamaC').innerHTML = h + '</div>';
}

function showPos(name) {
  const p = D.positions.find(x => x.name === name); if (!p) return;
  let dots = ''; for (let d = 1; d <= 3; d++) dots += '<div class="pdot' + (d <= p.diff ? ' on' : '') + '"></div>';
  let steps = ''; (p.howTo || []).forEach((s, i) => steps += '<div class="mstep"><div class="mstep-n">' + (i + 1) + '</div><div class="mstep-t">' + s + '</div></div>');
  let vars = ''; (p.variants || []).forEach(v => vars += '<span class="mvar">' + v + '</span>');
  document.getElementById('posModalC').innerHTML = '<div class="modal-h"><div class="modal-i">' + p.icon + '</div><button class="modal-x" onclick="closePos()">‚úï</button></div><div class="modal-t">' + p.name + '</div><div class="modal-diff">' + dots + '<span style="margin-left:12px;font-size:13px;color:var(--muted)">' + (p.diff === 1 ? '–õ–µ–≥–∫–æ' : p.diff === 2 ? '–°—Ä–µ–¥–Ω–µ' : '–°–ª–æ–∂–Ω–æ') + '</span></div><div class="msec"><h4>–û–ø–∏—Å–∞–Ω–∏–µ</h4><p>' + p.desc + '</p></div><div class="msec"><h4>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h4><div class="msteps">' + steps + '</div></div>' + (p.tip ? '<div class="mtip"><div class="mtip-t">üí° –°–æ–≤–µ—Ç</div><div class="mtip-c">' + p.tip + '</div></div>' : '') + '<div class="msec"><h4>–í–∞—Ä–∏–∞—Ü–∏–∏</h4><div class="mvars">' + vars + '</div></div>';
  document.getElementById('posModal').classList.add('show');
}
function closePos() { document.getElementById('posModal').classList.remove('show'); }

// ===== TESTS =====
function renderTests() {
  const icons = ['tc1', 'tc2', 'tc3', 'tc4', 'tc5', 'tc6', 'tc1', 'tc2', 'tc3', 'tc4'];
  const emojis = ['üíï', 'üé≠', 'üî•', 'üí≠', 'üí¨', '‚ù§Ô∏è', 'üå∂Ô∏è', 'üìä', 'üíë', 'üîÆ'];
  document.getElementById('testsList').innerHTML = D.tests.map((t, i) =>
    '<div class="tcard" onclick="startTest(\'' + t.id + '\')"><div class="tcard-h"><div class="tcard-i ' + icons[i % 10] + '">' + emojis[i % 10] + '</div><div class="tcard-info"><div class="tcard-t">' + t.title + '</div><div class="tcard-d">' + t.desc + '</div><div class="tcard-m">‚è± ' + t.time + ' ‚Ä¢ ' + t.questions.length + ' –≤–æ–ø—Ä–æ—Å–æ–≤</div></div></div></div>'
  ).join('');
}

function startTest(id) { curTest = D.tests.find(t => t.id === id); curTi = 0; testRes = []; renderTestQ(); go('testPlayScreen'); }

function renderTestQ() {
  const t = curTest, q = t.questions[curTi];
  document.getElementById('testC').innerHTML = '<div class="tq"><div class="tq-n">–í–æ–ø—Ä–æ—Å ' + (curTi + 1) + ' –∏–∑ ' + t.questions.length + '</div><div class="tq-t">' + q.q + '</div><div class="tq-opts">' + q.opts.map((o, i) => '<div class="tq-opt" onclick="selOpt(' + i + ')">' + o + '</div>').join('') + '</div></div>';
}

function selOpt(i) { testRes.push(i); curTi++; if (curTi >= curTest.questions.length) showTestRes(); else renderTestQ(); }

function showTestRes() {
  const good = testRes.filter(r => r < 2).length;
  const score = Math.round((good / testRes.length) * 100);
  const title = score >= 80 ? '–û—Ç–ª–∏—á–Ω–æ! üî•' : score >= 60 ? '–•–æ—Ä–æ—à–æ üíï' : '–ï—Å—Ç—å –Ω–∞–¥ —á–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å';
  const desc = score >= 80 ? '–í—ã –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ –ø–æ–Ω–∏–º–∞–µ—Ç–µ –¥—Ä—É–≥ –¥—Ä—É–≥–∞!' : score >= 60 ? '–ú–Ω–æ–≥–æ –æ–±—â–µ–≥–æ, –µ—Å—Ç—å –∫—É–¥–∞ —Ä–∞—Å—Ç–∏.' : '–†–∞–∑–ª–∏—á–∏—è ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.';
  document.getElementById('testC').innerHTML = '<div class="tres"><div class="tres-i">üíï</div><div class="tres-t">' + title + '</div><div class="tres-s">' + score + '%</div><div class="tres-d">' + desc + '</div><button class="sbtn" onclick="go(\'testsScreen\')" style="margin-top:24px">–ì–æ—Ç–æ–≤–æ</button></div>';
}

// ===== TIPS & IDEAS =====
function renderTips() {
  document.getElementById('tipsC').innerHTML = D.tips.map(t => {
    const icon = t.icon === 'her' ? 'üë©' : t.icon === 'him' ? 'üë®' : 'üíë';
    const steps = (t.steps || []).map((s, j) => '<div class="tip-step"><div class="tip-step-n">' + (j + 1) + '</div><div class="tip-step-t">' + s + '</div></div>').join('');
    return '<div class="tip-card"><div class="tip-h"><div class="tip-i ' + t.icon + '">' + icon + '</div><div><div class="tip-cat">' + t.cat + '</div><div class="tip-t">' + t.title + '</div></div></div><div class="tip-c">' + t.content + '</div><div class="tip-steps">' + steps + '</div></div>';
  }).join('');
}

function renderIdeas() {
  document.getElementById('ideasC').innerHTML = D.ideas.map(c =>
    '<div class="idea-sec"><h3>' + c.cat + '</h3><div class="idea-tags">' + c.items.map(i => '<div class="idea-tag">' + i + '</div>').join('') + '</div></div>'
  ).join('');
}

// ===== CALENDAR =====
function renderCalendar() {
  const months = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
  const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
  const fd = new Date(calYear, calMonth, 1).getDay();
  const dim = new Date(calYear, calMonth + 1, 0).getDate();
  const today = new Date();
  const sd = (fd + 6) % 7;
  
  let dh = ''; for (let i = 0; i < sd; i++) dh += '<div class="cal-day other"></div>';
  for (let d = 1; d <= dim; d++) {
    const ds = calYear + '-' + String(calMonth + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
    const hasE = S.calendar.some(e => e.date === ds);
    const isToday = today.getDate() === d && today.getMonth() === calMonth && today.getFullYear() === calYear;
    dh += '<div class="cal-day' + (isToday ? ' today' : '') + (hasE ? ' has' : '') + '" onclick="showDay(\'' + ds + '\')">' + d + '</div>';
  }
  
  const wd = days.map(d => '<div class="cal-wd">' + d + '</div>').join('');
  const prefix = calYear + '-' + String(calMonth + 1).padStart(2, '0');
  const eh = S.calendar.filter(e => e.date.startsWith(prefix)).map(e =>
    '<div class="cal-e"><div class="cal-e-h"><div class="cal-e-d">' + e.date.split('-')[2] + ' ' + months[calMonth] + '</div><div class="cal-e-type">' + e.mood + '</div></div><div class="cal-e-c"><b>' + e.title + '</b>' + (e.notes ? ' ‚Äî ' + e.notes : '') + '</div></div>'
  ).join('');
  
  document.getElementById('calC').innerHTML = '<div class="cal-h"><button class="cal-nav" onclick="chMonth(-1)">‚Üê</button><div class="cal-m">' + months[calMonth] + ' ' + calYear + '</div><button class="cal-nav" onclick="chMonth(1)">‚Üí</button></div><div class="cal-w">' + wd + '</div><div class="cal-days">' + dh + '</div>' + eh;
}

function chMonth(d) { calMonth += d; if (calMonth > 11) { calMonth = 0; calYear++; } if (calMonth < 0) { calMonth = 11; calYear--; } renderCalendar(); }
function showDay(d) { const e = S.calendar.find(x => x.date === d); if (e) toast(e.mood + ' ' + e.title); else openCM(); }
function openCM() { document.getElementById('calModal').classList.add('show'); }
function closeCM() { document.getElementById('calModal').classList.remove('show'); }
function selType(t, el) { calType = t; document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('on')); el.classList.add('on'); }
function selMood(m, el) { calMood = m; document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('on')); el.classList.add('on'); }
function saveCal() {
  const title = document.getElementById('calTitle').value; if (!title) { toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
  const t = new Date();
  S.calendar.push({ date: t.getFullYear() + '-' + String(t.getMonth() + 1).padStart(2, '0') + '-' + String(t.getDate()).padStart(2, '0'), type: calType, title, notes: document.getElementById('calNotes').value, mood: calMood });
  saveState(); closeCM(); renderCalendar(); toast('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
  document.getElementById('calTitle').value = ''; document.getElementById('calNotes').value = '';
}

// ===== PREGNANCY =====
function renderPregnancy() {
  const info = D.pregnancyInfo || {};
  if (!S.pregnancy) {
    const clHtml = info.checklist ? '<div style="margin-top:24px"><h2 style="font-size:18px;margin-bottom:16px">üìã –ß–µ–∫-–ª–∏—Å—Ç—ã</h2>' + renderChecklists(info.checklist) + '</div>' : '';
    document.getElementById('pregC').innerHTML = '<div class="preg-setup"><h3>ü§∞ –ù–∞—á–∞—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ</h3><p style="font-size:14px;color:var(--text2);margin-bottom:18px">–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏–∏</p><input type="date" class="preg-input" id="pregDate"><button class="preg-btn" onclick="startPreg()">–ù–∞—á–∞—Ç—å</button></div>' + clHtml;
  } else {
    const start = new Date(S.pregnancy.lastPeriod);
    const weeks = Math.floor((new Date() - start) / (7 * 24 * 60 * 60 * 1000));
    const cw = Math.min(Math.max(weeks, 1), 40);
    const wi = (info.weeks || []).filter(w => w.week <= cw).pop() || { week: cw, size: 'üçá', sizeName: '', dev: '', tips: [] };
    const tipsHtml = (wi.tips || []).map(t => '<div class="preg-tip">‚Ä¢ ' + t + '</div>').join('');
    const clHtml = info.checklist ? '<h2 style="font-size:18px;margin-bottom:16px">üìã –ß–µ–∫-–ª–∏—Å—Ç—ã</h2>' + renderChecklists(info.checklist) : '';
    document.getElementById('pregC').innerHTML = '<div class="preg-wk"><div class="preg-h"><div class="preg-w">–ù–µ–¥–µ–ª—è ' + cw + '</div><div class="preg-size"><div class="preg-size-i">' + wi.size + '</div><div class="preg-size-t">' + (wi.sizeName || '') + '</div></div></div><div class="preg-dev">' + (wi.dev || '') + '</div><div class="preg-tips">' + tipsHtml + '</div></div><button class="sbtn" style="width:100%;margin-bottom:20px" onclick="resetPreg()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>' + clHtml;
  }
}

function renderChecklists(cl) {
  if (!cl) return '';
  return [{ key: 'trimester1', title: '1 —Ç—Ä–∏–º–µ—Å—Ç—Ä' }, { key: 'trimester2', title: '2 —Ç—Ä–∏–º–µ—Å—Ç—Ä' }, { key: 'trimester3', title: '3 —Ç—Ä–∏–º–µ—Å—Ç—Ä' }, { key: 'hospital', title: '–°—É–º–∫–∞ –≤ —Ä–æ–¥–¥–æ–º' }].map(sec => {
    const items = (cl[sec.key] || []).map((item, i) => {
      const done = S['chk_' + sec.key + '_' + i];
      return '<div class="check-item"><div class="check-box' + (done ? ' done' : '') + '" onclick="toggleChk(\'' + sec.key + '\',' + i + ')">' + (done ? '‚úì' : '') + '</div><span>' + item + '</span></div>';
    }).join('');
    return '<div class="checklist"><h4>' + sec.title + '</h4>' + items + '</div>';
  }).join('');
}

function toggleChk(k, i) { S['chk_' + k + '_' + i] = !S['chk_' + k + '_' + i]; saveState(); renderPregnancy(); }
function startPreg() { const d = document.getElementById('pregDate').value; if (!d) { toast('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É'); return; } const lmp = new Date(d); const due = new Date(lmp); due.setDate(due.getDate() + 280); S.pregnancy = { lastPeriod: d, dueDate: due.toISOString().split('T')[0] }; saveState(); renderPregnancy(); toast('ü§∞ –ù–∞—á–∞—Ç–æ!'); }
function resetPreg() { S.pregnancy = null; saveState(); renderPregnancy(); }

// ===== CYCLE =====
function renderCycle() {
  const info = (D.pregnancyInfo || {}).cycleInfo || { phases: [], fertileDays: '', signs: [] };
  const months = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
  const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
  const fd = new Date(cycleYear, cycleMonth, 1).getDay();
  const dim = new Date(cycleYear, cycleMonth + 1, 0).getDate();
  const sd = (fd + 6) % 7;
  const lp = S.cycle.find(c => c.type === 'period_start');
  
  let pDays = [], fDays = [], ovDay = null;
  if (lp) {
    const st = new Date(lp.date);
    for (let i = 0; i < 5; i++) { const nd = new Date(st); nd.setDate(nd.getDate() + i); pDays.push(nd.toISOString().split('T')[0]); }
    for (let i = 10; i < 16; i++) { const nd = new Date(st); nd.setDate(nd.getDate() + i); fDays.push(nd.toISOString().split('T')[0]); }
    const ov = new Date(st); ov.setDate(ov.getDate() + 14); ovDay = ov.toISOString().split('T')[0];
  }
  
  let dh = ''; for (let i = 0; i < sd; i++) dh += '<div class="cal-day other"></div>';
  for (let d = 1; d <= dim; d++) {
    const ds = cycleYear + '-' + String(cycleMonth + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
    let cls = pDays.includes(ds) ? ' period' : ds === ovDay ? ' ovul' : fDays.includes(ds) ? ' fertile' : '';
    dh += '<div class="cal-day' + cls + '">' + d + '</div>';
  }
  
  const wd = days.map(d => '<div class="cal-wd">' + d + '</div>').join('');
  const phasesHtml = (info.phases || []).map(p => '<p><b>' + p.name + '</b> (–¥–Ω–∏ ' + p.days + '): ' + p.desc + '</p>').join('');
  const signsHtml = (info.signs || []).map(s => '<p>‚Ä¢ ' + s + '</p>').join('');
  
  document.getElementById('cycleC').innerHTML = '<div class="cycle-legend"><div class="cycle-leg"><div class="cycle-dot period"></div>–ú–µ—Å—è—á–Ω—ã–µ</div><div class="cycle-leg"><div class="cycle-dot fertile"></div>–§–µ—Ä—Ç–∏–ª—å–Ω—ã–µ</div><div class="cycle-leg"><div class="cycle-dot ovul"></div>–û–≤—É–ª—è—Ü–∏—è</div></div><div class="cal-h"><button class="cal-nav" onclick="chCycleM(-1)">‚Üê</button><div class="cal-m">' + months[cycleMonth] + ' ' + cycleYear + '</div><button class="cal-nav" onclick="chCycleM(1)">‚Üí</button></div><div class="cal-w">' + wd + '</div><div class="cal-days">' + dh + '</div><button class="sbtn" style="width:100%;margin-top:18px" onclick="markPeriod()">üî¥ –ù–∞—á–∞–ª–æ –º–µ—Å—è—á–Ω—ã—Ö</button><div class="cycle-info"><h4>üìö –§–∞–∑—ã —Ü–∏–∫–ª–∞</h4>' + phasesHtml + '<p style="margin-top:14px"><b>üéØ –§–µ—Ä—Ç–∏–ª—å–Ω—ã–µ –¥–Ω–∏:</b> ' + (info.fertileDays || '') + '</p><h4 style="margin-top:18px">üîç –ü—Ä–∏–∑–Ω–∞–∫–∏ –æ–≤—É–ª—è—Ü–∏–∏</h4>' + signsHtml + '</div>';
}

function chCycleM(d) { cycleMonth += d; if (cycleMonth > 11) { cycleMonth = 0; cycleYear++; } if (cycleMonth < 0) { cycleMonth = 11; cycleYear--; } renderCycle(); }
function markPeriod() { S.cycle = [{ date: new Date().toISOString().split('T')[0], type: 'period_start' }]; saveState(); renderCycle(); toast('üî¥ –û—Ç–º–µ—á–µ–Ω–æ!'); }

// ===== INIT =====
document.getElementById('posModal').onclick = e => { if (e.target.id === 'posModal') closePos(); };
document.getElementById('calModal').onclick = e => { if (e.target.id === 'calModal') closeCM(); };

checkAuth();
</script>
</body>
</html>
