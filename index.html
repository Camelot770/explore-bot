<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Explore</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{--bg:#0a0a0f;--bg2:#14141c;--bg3:#1c1c28;--accent:#ff6b9d;--accent2:#a855f7;--green:#22c55e;--yellow:#f59e0b;--blue:#3b82f6;--text:#fff;--text2:rgba(255,255,255,.7);--muted:rgba(255,255,255,.4);--border:rgba(255,255,255,.1)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5}
.app{max-width:440px;margin:0 auto;min-height:100vh;padding-bottom:80px;position:relative;overflow-x:hidden}
.screen{display:none;animation:fadeIn .25s}.screen.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(720deg)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes glow{0%,100%{box-shadow:0 0 20px rgba(255,107,157,.3)}50%{box-shadow:0 0 40px rgba(255,107,157,.6)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
@keyframes confetti{0%{transform:translateY(0) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
@keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes heartbeat{0%,100%{transform:scale(1)}14%{transform:scale(1.1)}28%{transform:scale(1)}42%{transform:scale(1.1)}70%{transform:scale(1)}}

/* Glassmorphism */
.glass{background:rgba(20,20,28,.7);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.08)}

/* Premium badge */
.premium-badge{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#000;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;display:inline-flex;align-items:center;gap:4px}
.premium-badge::before{content:'üíé'}

/* Streak fire */
.streak-fire{display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg,#ef4444,#f97316);padding:6px 12px;border-radius:20px;font-size:13px;font-weight:700;animation:pulse 2s infinite}

/* Level badge */
.level-badge{background:linear-gradient(135deg,var(--accent),var(--accent2));padding:6px 14px;border-radius:20px;font-size:13px;font-weight:700;display:inline-flex;align-items:center;gap:6px}

/* XP bar */
.xp-bar{height:6px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden;margin-top:8px}
.xp-bar-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;transition:width .5s ease}

/* Coin display */
.coin-display{display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#fbbf24,#f59e0b);padding:6px 12px;border-radius:20px;font-size:13px;font-weight:700;color:#000}

/* Animated card hover */
.card{position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent 40%,rgba(255,255,255,.1) 50%,transparent 60%);transform:rotate(45deg);transition:all .6s}
.card:hover::before{left:100%}

/* Toast improvements */
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(20px);background:rgba(20,20,28,.95);backdrop-filter:blur(20px);padding:14px 28px;border-radius:30px;font-size:14px;font-weight:600;z-index:1000;opacity:0;transition:all .3s;border:1px solid rgba(255,255,255,.1);box-shadow:0 10px 40px rgba(0,0,0,.5)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* Floating action button */
.fab{position:fixed;bottom:100px;right:20px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;font-size:24px;cursor:pointer;box-shadow:0 4px 20px rgba(255,107,157,.4);animation:glow 3s infinite;z-index:100;display:flex;align-items:center;justify-content:center}
.fab:active{transform:scale(.9)}

/* Stats card */
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:20px;text-align:center}
.stat-card .icon{font-size:32px;margin-bottom:8px}
.stat-card .value{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.stat-card .label{font-size:12px;color:var(--text2);margin-top:4px}

/* Achievement unlocked animation */
.achievement-unlocked{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg2);border:2px solid var(--accent);border-radius:24px;padding:32px;text-align:center;z-index:2000;animation:slideUp .5s,pulse 1s .5s}
.achievement-unlocked .icon{font-size:64px;margin-bottom:16px;animation:float 2s infinite}
.achievement-unlocked .title{font-size:20px;font-weight:700;color:var(--accent);margin-bottom:8px}
.achievement-unlocked .desc{font-size:14px;color:var(--text2)}

/* Partner heartbeat */
.partner-heart{animation:heartbeat 1.5s infinite}

/* Message bubble improved */
.msg-bubble{max-width:75%;padding:14px 18px;border-radius:20px;font-size:14px;line-height:1.5;position:relative;animation:slideUp .3s}
.msg-bubble.sent{background:linear-gradient(135deg,var(--accent),var(--accent2));border-bottom-right-radius:6px;margin-left:auto}
.msg-bubble.received{background:var(--bg2);border:1px solid var(--border);border-bottom-left-radius:6px}
.msg-time{font-size:11px;opacity:.6;margin-top:6px}

/* Swipe hint */
.swipe-hint{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;color:var(--muted);font-size:13px}
.swipe-hint::before,.swipe-hint::after{content:'';width:20px;height:2px;background:var(--border);border-radius:1px}

/* Auth Screen */
.auth-screen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;text-align:center}
.auth-logo{font-size:64px;margin-bottom:16px}
.auth-title{font-size:32px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
.auth-sub{font-size:16px;color:var(--text2);margin-bottom:40px}
.auth-btns{display:flex;flex-direction:column;gap:14px;width:100%;max-width:300px}
.auth-btn{padding:18px 24px;border-radius:16px;border:none;font-size:16px;font-weight:600;cursor:pointer;transition:transform .15s}
.auth-btn:active{transform:scale(.96)}
.auth-btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
.auth-btn.secondary{background:var(--bg2);border:1px solid var(--border);color:var(--text)}

/* Pair Code Screen */
.pair-screen{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;text-align:center}
.pair-back{position:absolute;top:20px;left:20px;font-size:14px;color:var(--text2);cursor:pointer}
.pair-icon{font-size:56px;margin-bottom:16px}
.pair-title{font-size:24px;font-weight:700;margin-bottom:8px}
.pair-desc{font-size:14px;color:var(--text2);margin-bottom:32px;max-width:280px}
.pair-code-box{background:var(--bg2);border:2px dashed var(--accent);border-radius:20px;padding:24px 40px;margin-bottom:24px}
.pair-code{font-size:36px;font-weight:800;letter-spacing:8px;font-family:monospace;color:var(--accent)}
.pair-copy{background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:12px 24px;color:var(--text);font-size:14px;cursor:pointer;margin-bottom:32px}
.pair-copy:active{background:var(--accent);border-color:var(--accent)}
.pair-input{width:100%;max-width:280px;padding:18px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;color:var(--text);font-size:20px;text-align:center;letter-spacing:4px;text-transform:uppercase;margin-bottom:16px}
.pair-input::placeholder{letter-spacing:normal;text-transform:none}
.pair-input:focus{outline:none;border-color:var(--accent)}
.pair-submit{width:100%;max-width:280px;padding:18px;background:var(--accent);border:none;border-radius:14px;color:#fff;font-size:16px;font-weight:600;cursor:pointer}
.pair-submit:disabled{opacity:.5}
.pair-status{margin-top:16px;padding:14px 20px;border-radius:12px;font-size:14px}
.pair-status.success{background:rgba(34,197,94,.15);color:var(--green)}
.pair-status.error{background:rgba(239,68,68,.15);color:#ef4444}
.pair-status.info{background:rgba(59,130,246,.15);color:#3b82f6}
.auth-hint{color:var(--text2);font-size:13px;margin-top:12px;text-align:center}
.tg-auth{display:flex;align-items:center;justify-content:center;gap:10px}
.pair-or{margin:24px 0;color:var(--muted);font-size:14px}
.pair-link{color:var(--accent);cursor:pointer;font-size:14px}

/* Partner Badge */
.partner-badge{display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;margin:16px}
.partner-badge-icon{font-size:24px}
.partner-badge-info{text-align:left}
.partner-badge-name{font-size:14px;font-weight:600}
.partner-badge-status{font-size:12px;color:var(--green)}

/* Rest of styles */
.hdr{padding:16px;display:flex;justify-content:space-between;align-items:center}
.logo{font-size:28px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.user-info{display:flex;align-items:center;gap:8px}
.user-name{font-size:14px;color:var(--text2)}
.user-linked{font-size:12px;color:var(--green)}
.p16{padding:0 16px 16px}
.back{padding:14px 16px;font-size:14px;color:var(--text2);cursor:pointer}
h2{font-size:22px;font-weight:800;margin-bottom:8px}
.desc{font-size:14px;color:var(--text2);margin-bottom:18px}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:22px}
.card{padding:18px;border-radius:18px;cursor:pointer;transition:transform .15s}
.card:active{transform:scale(.96)}
.c1{background:linear-gradient(135deg,#0891b2,#06b6d4)}.c2{background:linear-gradient(135deg,#e11d48,#f43f5e)}.c3{background:linear-gradient(135deg,#7c3aed,#8b5cf6)}.c4{background:linear-gradient(135deg,#d97706,#f59e0b)}.c5{background:linear-gradient(135deg,#059669,#10b981)}.c6{background:linear-gradient(135deg,#db2777,#ec4899)}.c7{background:linear-gradient(135deg,#f472b6,#f9a8d4)}.c8{background:linear-gradient(135deg,#a855f7,#c084fc)}
.card-i{font-size:32px;margin-bottom:8px}.card-t{font-size:15px;font-weight:700}.card-d{font-size:12px;opacity:.9;margin-top:4px}
.lv{padding:18px;border-radius:16px;cursor:pointer;margin-bottom:14px;transition:transform .15s}.lv:active{transform:scale(.98)}
.l1{background:linear-gradient(135deg,#059669,#10b981)}.l2{background:linear-gradient(135deg,#2563eb,#3b82f6)}.l3{background:linear-gradient(135deg,#d97706,#f59e0b)}.l4{background:linear-gradient(135deg,#db2777,#ec4899)}.l5{background:linear-gradient(135deg,#dc2626,#ef4444)}.l6{background:linear-gradient(135deg,#7f1d1d,#991b1b)}
.lv-h{display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px;opacity:.85}.lv-t{font-size:18px;font-weight:700}.lv-d{font-size:13px;opacity:.9;margin-top:4px}
.pb{height:6px;background:rgba(255,255,255,.2);border-radius:3px;margin-top:12px;overflow:hidden}.pb-f{height:100%;background:#fff;border-radius:3px;opacity:.9;transition:width .4s}
.qc{padding:16px}.qp{display:flex;gap:3px;margin-bottom:18px}.qp-d{flex:1;height:5px;border-radius:3px;background:rgba(255,255,255,.15)}.qp-d.done{background:var(--green)}.qp-d.cur{background:var(--accent)}
.qcard{background:var(--bg2);border:1px solid var(--border);border-radius:24px;padding:28px 24px;text-align:center;min-height:360px;display:flex;flex-direction:column;align-items:center}
.qbadge{padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;margin-bottom:20px}
.qcard.l1 .qbadge{background:rgba(16,185,129,.2);color:#34d399}.qcard.l2 .qbadge{background:rgba(59,130,246,.2);color:#60a5fa}.qcard.l3 .qbadge{background:rgba(245,158,11,.2);color:#fbbf24}.qcard.l4 .qbadge{background:rgba(236,72,153,.2);color:#f472b6}.qcard.l5 .qbadge{background:rgba(239,68,68,.2);color:#f87171}.qcard.l6 .qbadge{background:rgba(153,27,27,.3);color:#fca5a5}
.qicon{font-size:48px;margin-bottom:20px}.qtext{font-size:20px;font-weight:600;flex:1;display:flex;align-items:center;line-height:1.4}.qhint{font-size:13px;color:var(--muted);margin-top:20px;padding:12px 16px;background:rgba(255,255,255,.04);border-radius:14px}
.qnav{display:flex;gap:14px;margin-top:20px;width:100%}.qbtn{flex:1;padding:16px;border-radius:14px;border:none;font-size:15px;font-weight:600;cursor:pointer}.qbtn:active{transform:scale(.97)}.qbtn.sec{background:var(--bg2);color:var(--text);border:1px solid var(--border)}.qbtn.pri{background:var(--accent);color:#fff}
.tabs{display:flex;gap:8px;margin-bottom:18px}.tab{flex:1;padding:14px 8px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;text-align:center;font-size:13px;font-weight:600;cursor:pointer}.tab.on{background:var(--accent);border-color:var(--accent)}
.rlt{display:flex;flex-direction:column;align-items:center;padding:24px 0}
.whl{width:260px;height:260px;border-radius:50%;background:conic-gradient(from 0deg,#e11d48,#db2777,#a855f7,#7c3aed,#2563eb,#0891b2,#059669,#d97706,#e11d48);display:flex;align-items:center;justify-content:center;position:relative;box-shadow:0 0 60px rgba(236,72,153,.3)}.whl::before{content:'';position:absolute;width:190px;height:190px;background:var(--bg);border-radius:50%}.whl-c{position:relative;z-index:1;text-align:center;padding:12px}.whl-n{font-size:16px;font-weight:700;margin-bottom:6px}.whl-d{font-size:12px;color:var(--text2)}
.sbtn{margin-top:24px;padding:16px 48px;background:linear-gradient(135deg,#e11d48,#db2777);border:none;border-radius:30px;color:#fff;font-size:16px;font-weight:700;cursor:pointer;box-shadow:0 6px 30px rgba(225,29,72,.4)}.sbtn:active{transform:scale(.96)}
.spin .whl{animation:spin 3s cubic-bezier(.17,.67,.12,.99) forwards}@keyframes spin{from{transform:rotate(0)}to{transform:rotate(1800deg)}}
.rcard{margin-top:24px;padding:18px;background:var(--bg2);border:1px solid var(--border);border-radius:18px;width:100%;cursor:pointer}.rcard:active{transform:scale(.98)}.rcard h3{font-size:16px;margin-bottom:8px}.rcard p{font-size:13px;color:var(--text2)}
.dice-c{display:flex;flex-direction:column;align-items:center;padding:24px 0}.dice-p{display:flex;gap:18px;margin-bottom:24px}.dice{width:130px;height:100px;background:var(--bg2);border:2px solid var(--border);border-radius:18px;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:14px}.dice-l{font-size:12px;color:var(--muted);margin-bottom:8px}.dice-v{font-size:16px;font-weight:700;text-align:center}.dice.a{border-color:var(--accent)}.dice.a .dice-v{color:var(--accent)}.dice.b{border-color:var(--blue)}.dice.b .dice-v{color:var(--blue)}.dice.roll{animation:shake .6s}@keyframes shake{0%,100%{transform:rotate(0)}25%{transform:rotate(-12deg)}75%{transform:rotate(12deg)}}
.dres{text-align:center;padding:18px;background:var(--bg2);border:1px solid var(--border);border-radius:18px;width:100%}.dres-t{font-size:20px;font-weight:700;margin-bottom:8px}.dres-s{font-size:14px;color:var(--text2)}
.pgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}.pcard{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:16px;cursor:pointer;text-align:center}.pcard:active{transform:scale(.96)}.pcard-i{font-size:36px;margin-bottom:10px}.pcard-n{font-size:13px;font-weight:700;margin-bottom:8px}.pdiff{display:flex;gap:5px;justify-content:center}.pdot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.2)}.pdot.on{background:var(--yellow)}

/* Test Cards */
.tcard{background:var(--bg2);border:1px solid var(--border);border-radius:18px;padding:18px;margin-bottom:14px;cursor:pointer;transition:transform .15s}
.tcard:active{transform:scale(.98)}
.tcard-h{display:flex;gap:16px;align-items:center}
.tcard-i{width:56px;height:56px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0}
.tcard-i.tc1{background:linear-gradient(135deg,#ec4899,#f472b6)}.tcard-i.tc2{background:linear-gradient(135deg,#8b5cf6,#a78bfa)}.tcard-i.tc3{background:linear-gradient(135deg,#ef4444,#f87171)}.tcard-i.tc4{background:linear-gradient(135deg,#3b82f6,#60a5fa)}.tcard-i.tc5{background:linear-gradient(135deg,#10b981,#34d399)}.tcard-i.tc6{background:linear-gradient(135deg,#f59e0b,#fbbf24)}
.tcard-info{flex:1;min-width:0}
.tcard-t{font-size:16px;font-weight:700;margin-bottom:4px}
.tcard-d{font-size:13px;color:var(--text2);margin-bottom:6px}
.tcard-m{font-size:12px;color:var(--muted)}

/* Test Question - MOBILE OPTIMIZED */
.tq{padding:20px 0}
.tq-n{text-align:center;font-size:14px;color:var(--accent);font-weight:600;margin-bottom:24px}
.tq-t{font-size:22px;font-weight:700;text-align:center;margin-bottom:32px;line-height:1.4;padding:0 10px}
.tq-opts{display:flex;flex-direction:column;gap:14px}
.tq-opt{padding:20px 24px;background:var(--bg2);border:2px solid var(--border);border-radius:16px;font-size:16px;cursor:pointer;transition:all .2s;text-align:center;font-weight:500;min-height:60px;display:flex;align-items:center;justify-content:center}
.tq-opt:active{transform:scale(.97);background:var(--accent);border-color:var(--accent)}
.tq-opt:hover{border-color:var(--accent)}

/* Test Results */
.tres{text-align:center;padding:40px 20px}
.tres-i{font-size:80px;margin-bottom:20px;animation:float 3s infinite}
.tres-t{font-size:28px;font-weight:800;margin-bottom:16px}
.tres-s{font-size:64px;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:16px}
.tres-d{font-size:16px;color:var(--text2);line-height:1.6;max-width:280px;margin:0 auto}

/* Tip Card */
.tip-card{background:var(--bg2);border:1px solid var(--border);border-radius:18px;padding:20px;margin-bottom:16px}
.tip-h{display:flex;gap:14px;align-items:center;margin-bottom:14px}
.tip-i{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0}
.tip-i.her{background:linear-gradient(135deg,#ec4899,#f472b6)}.tip-i.him{background:linear-gradient(135deg,#3b82f6,#60a5fa)}.tip-i.both{background:linear-gradient(135deg,#8b5cf6,#a78bfa)}
.tip-cat{font-size:12px;color:var(--accent);font-weight:600}
.tip-t{font-size:17px;font-weight:700}
.tip-c{font-size:14px;color:var(--text2);line-height:1.6;margin-bottom:14px}
.tip-steps{background:var(--bg3);border-radius:14px;padding:14px}
.tip-step{display:flex;gap:12px;margin-bottom:10px}
.tip-step:last-child{margin-bottom:0}
.tip-step-n{width:24px;height:24px;border-radius:50%;background:var(--accent);color:#fff;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.tip-step-t{font-size:13px;color:var(--text2);line-height:1.5}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.94);z-index:200;display:none;align-items:center;justify-content:center;padding:16px}.modal.show{display:flex}.modal-c{background:var(--bg2);border:1px solid var(--border);border-radius:24px;padding:24px;width:100%;max-width:420px;max-height:88vh;overflow-y:auto}.modal-h{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px}.modal-i{font-size:52px}.modal-x{background:none;border:none;color:var(--muted);font-size:28px;cursor:pointer}.modal-t{font-size:24px;font-weight:800;margin-bottom:8px}.modal-diff{display:flex;gap:6px;align-items:center;margin-bottom:20px}.modal-diff .pdot{width:12px;height:12px}
.msec{margin-bottom:18px}.msec h4{font-size:13px;color:var(--accent);margin-bottom:8px;text-transform:uppercase}.msec p{font-size:14px;color:var(--text2);line-height:1.6}.msteps{background:var(--bg3);border-radius:14px;padding:14px}.mstep{display:flex;gap:12px;margin-bottom:10px}.mstep:last-child{margin-bottom:0}.mstep-n{width:28px;height:28px;border-radius:50%;background:var(--accent);color:#fff;font-size:13px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}.mstep-t{font-size:14px;color:var(--text2)}.mtip{padding:14px;background:rgba(251,191,36,.12);border-left:4px solid var(--yellow);border-radius:0 12px 12px 0;margin-bottom:18px}.mtip-t{font-size:12px;color:var(--yellow);font-weight:700;margin-bottom:6px}.mtip-c{font-size:13px;color:var(--text2)}.mvars{margin-top:14px}.mvar{display:inline-block;padding:8px 14px;background:var(--bg);border-radius:20px;font-size:12px;margin:0 8px 8px 0}
n{width:22px;height:22px;border-radius:50%;background:var(--accent);color:#fff;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}.tip-step-t{font-size:12px;color:var(--text2)}
.idea-sec{margin-bottom:22px}.idea-sec h3{font-size:17px;margin-bottom:12px}.idea-tags{display:flex;flex-wrap:wrap;gap:10px}.idea-tag{padding:10px 16px;background:var(--bg2);border:1px solid var(--border);border-radius:20px;font-size:13px}
.cal-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}.cal-m{font-size:18px;font-weight:700}.cal-nav{width:36px;height:36px;border-radius:10px;background:var(--bg2);border:1px solid var(--border);color:var(--text);font-size:16px;cursor:pointer}.cal-w{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:8px}.cal-wd{text-align:center;font-size:11px;color:var(--muted);padding:8px 0}.cal-days{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}.cal-day{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:10px;font-size:13px;cursor:pointer;background:var(--bg2);border:2px solid transparent;position:relative;font-weight:500}.cal-day:active{transform:scale(.92)}.cal-day.other{opacity:.3}.cal-day.today{border-color:var(--accent)}.cal-day.has::after{content:'';position:absolute;bottom:4px;width:6px;height:6px;border-radius:50%;background:var(--accent)}.cal-day.period{background:rgba(239,68,68,.35)}.cal-day.fertile{background:rgba(34,197,94,.35)}.cal-day.ovul{background:rgba(251,191,36,.5)}
.cal-e{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:14px;margin-top:12px}.cal-e-h{display:flex;justify-content:space-between;margin-bottom:8px}.cal-e-d{font-size:14px;font-weight:600}.cal-e-type{padding:5px 10px;border-radius:12px;font-size:11px;font-weight:600;background:rgba(255,107,157,.15);color:var(--accent)}.cal-e-c{font-size:13px;color:var(--text2)}.cal-add{position:fixed;bottom:100px;right:20px;width:58px;height:58px;border-radius:50%;background:var(--accent);border:none;font-size:28px;color:#fff;cursor:pointer;box-shadow:0 6px 24px rgba(255,107,157,.5);z-index:50}
.preg-wk{background:var(--bg2);border:1px solid var(--border);border-radius:18px;padding:20px;margin-bottom:16px}.preg-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}.preg-w{font-size:28px;font-weight:800;color:var(--accent)}.preg-size{text-align:right}.preg-size-i{font-size:24px}.preg-size-t{font-size:12px;color:var(--text2)}.preg-dev{font-size:14px;color:var(--text2);margin-bottom:14px;line-height:1.6}.preg-tips{background:var(--bg3);border-radius:12px;padding:14px}.preg-tip{font-size:13px;color:var(--text2);padding:6px 0;border-bottom:1px solid var(--border)}.preg-tip:last-child{border:none}.preg-setup{background:var(--bg2);border:1px solid var(--border);border-radius:18px;padding:28px;text-align:center}.preg-setup h3{font-size:20px;margin-bottom:16px}.preg-input{width:100%;padding:16px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:16px;margin-bottom:14px}.preg-btn{width:100%;padding:16px;background:var(--accent);border:none;border-radius:12px;color:#fff;font-size:16px;font-weight:600;cursor:pointer}
.cycle-legend{display:flex;gap:16px;margin-bottom:18px;flex-wrap:wrap}.cycle-leg{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2)}.cycle-dot{width:12px;height:12px;border-radius:50%}.cycle-dot.period{background:rgba(239,68,68,.7)}.cycle-dot.fertile{background:rgba(34,197,94,.7)}.cycle-dot.ovul{background:rgba(251,191,36,.8)}.cycle-info{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px;margin-top:16px}.cycle-info h4{font-size:15px;margin-bottom:12px}.cycle-info p{font-size:13px;color:var(--text2);line-height:1.6;margin-bottom:10px}
.checklist{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px;margin-bottom:14px}.checklist h4{font-size:15px;margin-bottom:14px}.check-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);font-size:14px}.check-item:last-child{border:none}.check-box{width:24px;height:24px;border-radius:8px;border:2px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}.check-box.done{background:var(--green);border-color:var(--green)}
.bnav{position:fixed;bottom:0;left:0;right:0;background:rgba(10,10,15,.97);backdrop-filter:blur(20px);border-top:1px solid var(--border);padding:10px 0 calc(10px + env(safe-area-inset-bottom));z-index:100}.bnav-items{display:flex;justify-content:space-around;max-width:440px;margin:0 auto}.bnav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:6px 10px;background:none;border:none;color:var(--muted);font-size:11px;font-weight:600;cursor:pointer}.bnav-item.on{color:var(--accent)}.bnav-i{font-size:22px}
.toast{position:fixed;bottom:110px;left:50%;transform:translateX(-50%) translateY(60px);padding:14px 24px;background:#fff;color:#000;border-radius:16px;font-size:14px;font-weight:600;opacity:0;transition:all .3s;z-index:999}.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.cmodal{position:fixed;inset:0;background:rgba(0,0,0,.94);z-index:200;display:none;align-items:flex-end;justify-content:center}.cmodal.show{display:flex}.cmodal-c{background:var(--bg2);border-radius:24px 24px 0 0;padding:24px;width:100%;max-width:440px}.cmodal-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.cmodal-t{font-size:20px;font-weight:700}.cmodal-x{background:none;border:none;color:var(--text);font-size:24px;cursor:pointer}.fg{margin-bottom:16px}.fg-l{font-size:13px;color:var(--text2);margin-bottom:6px;display:block}.fg-i{width:100%;padding:14px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:15px}.fg-i:focus{outline:none;border-color:var(--accent)}.type-btns{display:flex;gap:10px}.type-btn{flex:1;padding:14px;border-radius:12px;border:2px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;font-weight:600;cursor:pointer}.type-btn.on{border-color:var(--accent);background:rgba(255,107,157,.12)}.mood-btns{display:flex;gap:10px;justify-content:center}.mood-btn{width:48px;height:48px;border-radius:50%;border:2px solid var(--border);background:var(--bg);font-size:22px;cursor:pointer}.mood-btn.on{border-color:var(--accent);background:rgba(255,107,157,.12)}.save-btn{width:100%;padding:16px;background:var(--accent);border:none;border-radius:14px;color:#fff;font-size:16px;font-weight:600;cursor:pointer;margin-top:10px}
</style>
</head>
<body>
<div class="app">
<!-- Auth Screen -->
<div class="screen active" id="authScreen">
<div class="auth-screen">
<div class="auth-logo">üíï</div>
<div class="auth-title">Explore</div>
<div class="auth-sub">–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–∞—Ä</div>
<div class="auth-btns">
<button class="auth-btn primary tg-auth" onclick="authWithTelegram()">
  <span style="font-size:20px">üì±</span> –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram
</button>
<p class="auth-hint">–ú—ã –∑–∞–ø—Ä–æ—Å–∏–º –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</p>
</div>
<div id="authStatus"></div>
</div>
</div>

<!-- Phone Request Screen -->
<div class="screen" id="phoneScreen">
<div class="pair-screen">
<div class="pair-icon">üì±</div>
<div class="pair-title">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–º–µ—Ä</div>
<div class="pair-desc">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —á–µ—Ä–µ–∑ Telegram</div>
<button class="auth-btn primary tg-auth" onclick="requestPhone()">üìû –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–æ–º–µ—Ä–æ–º</button>
<div id="phoneStatus"></div>
</div>
</div>

<!-- Register Screen (Get Code) -->
<div class="screen" id="registerScreen">
<div class="pair-screen">
<div class="pair-back" onclick="showAuth()">‚Üê –ù–∞–∑–∞–¥</div>
<div class="pair-icon">üîó</div>
<div class="pair-title">–í–∞—à –∫–æ–¥ –ø–∞—Ä—ã</div>
<div class="pair-desc">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä—É, —á—Ç–æ–±—ã —Å–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã</div>
<div class="pair-code-box">
<div class="pair-code" id="myPairCode">------</div>
</div>
<button class="pair-copy" onclick="copyCode()">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
<button class="auth-btn primary" onclick="continueAlone()">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
<div class="pair-or">–∏–ª–∏</div>
<div class="pair-link" onclick="showJoin()">–£ –º–µ–Ω—è —É–∂–µ –µ—Å—Ç—å –∫–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞</div>
</div>
</div>

<!-- Join Screen (Enter Code) -->
<div class="screen" id="joinScreen">
<div class="pair-screen">
<div class="pair-back" onclick="showPairChoice()">‚Üê –ù–∞–∑–∞–¥</div>
<div class="pair-icon">ü§ù</div>
<div class="pair-title">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥</div>
<div class="pair-desc">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Å–ª–∞–ª –≤–∞—à –ø–∞—Ä—Ç–Ω—ë—Ä</div>
<input type="text" class="pair-input" id="joinCodeInput" placeholder="XXXXXX" maxlength="6" oninput="this.value=this.value.toUpperCase()">
<button class="pair-submit" id="joinBtn" onclick="joinPartner()">–°–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç—ã</button>
<div id="joinStatus"></div>
<div class="pair-or">–∏–ª–∏</div>
<div class="pair-link" onclick="showRegister()">–ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–π –∫–æ–¥</div>
</div>
</div>

<!-- Pair Choice Screen -->
<div class="screen" id="pairChoiceScreen">
<div class="pair-screen">
<div class="pair-icon">üíë</div>
<div class="pair-title">–°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º</div>
<div class="pair-desc">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏</div>
<div class="auth-btns" style="gap:12px">
<button class="auth-btn primary" onclick="showRegister()">üîó –Ø –ø–µ—Ä–≤—ã–π ‚Äî –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
<button class="auth-btn secondary" onclick="showJoin()">ü§ù –£ –º–µ–Ω—è –µ—Å—Ç—å –∫–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞</button>
</div>
</div>
</div>

<!-- Home Screen -->
<div class="screen" id="homeScreen">
<div class="hdr">
<div class="logo">Explore</div>
<div class="user-info">
<div>
<div class="user-name" id="userName"></div>
<div class="user-linked" id="partnerStatus"></div>
</div>
</div>
</div>
<div id="partnerBadge"></div>

<!-- Dashboard Stats -->
<div style="padding:0 16px 16px;display:grid;grid-template-columns:repeat(4,1fr);gap:10px" id="dashStats">
<div class="glass" style="border-radius:14px;padding:12px;text-align:center">
<div style="font-size:20px" id="dashLevel">‚≠ê 1</div>
<div style="font-size:10px;color:var(--text2)">–£—Ä–æ–≤–µ–Ω—å</div>
</div>
<div class="glass" style="border-radius:14px;padding:12px;text-align:center">
<div style="font-size:20px" id="dashCoins">ü™ô 100</div>
<div style="font-size:10px;color:var(--text2)">–ú–æ–Ω–µ—Ç—ã</div>
</div>
<div class="glass" style="border-radius:14px;padding:12px;text-align:center">
<div style="font-size:20px" id="dashStreak">üî• 0</div>
<div style="font-size:10px;color:var(--text2)">–°—Ç—Ä–∏–∫</div>
</div>
<div class="glass" style="border-radius:14px;padding:12px;text-align:center">
<div style="font-size:20px" id="dashDays">üíë 0</div>
<div style="font-size:10px;color:var(--text2)">–î–Ω–µ–π</div>
</div>
</div>

<!-- XP Progress -->
<div style="padding:0 16px 20px">
<div style="display:flex;justify-content:space-between;font-size:12px;color:var(--text2);margin-bottom:6px">
<span id="xpLabel">0 XP</span>
<span id="xpNext">–î–æ —Å–ª–µ–¥. —É—Ä–æ–≤–Ω—è: 100</span>
</div>
<div class="xp-bar"><div class="xp-bar-fill" id="xpBar" style="width:0%"></div></div>
</div>

<div class="p16">
<div class="grid">
<div class="card c1" onclick="go('questionsScreen')"><div class="card-i">üí¨</div><div class="card-t">200 –≤–æ–ø—Ä–æ—Å–æ–≤</div><div class="card-d">6 —É—Ä–æ–≤–Ω–µ–π</div></div>
<div class="card c2" onclick="go('kamaScreen')"><div class="card-i">üî•</div><div class="card-t">50 –ø–æ–∑</div><div class="card-d">–ö–∞–º–∞—Å—É—Ç—Ä–∞</div></div>
<div class="card c3" onclick="go('testsScreen')"><div class="card-i">üíï</div><div class="card-t">10 —Ç–µ—Å—Ç–æ–≤</div><div class="card-d">–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å</div></div>
<div class="card c4" onclick="go('calendarScreen')"><div class="card-i">üìÖ</div><div class="card-t">–ö–∞–ª–µ–Ω–¥–∞—Ä—å</div><div class="card-d">–ò—Å—Ç–æ—Ä–∏—è</div></div>
<div class="card c5" onclick="go('tipsScreen')"><div class="card-i">üí°</div><div class="card-t">20 —Å–æ–≤–µ—Ç–æ–≤</div><div class="card-d">–¢–µ—Ö–Ω–∏–∫–∏</div></div>
<div class="card c6" onclick="go('ideasScreen')"><div class="card-i">‚ú®</div><div class="card-t">100 –∏–¥–µ–π</div><div class="card-d">–í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ</div></div>
</div>
<h2>üéÆ –ò–≥—Ä—ã –¥–ª—è –¥–≤–æ–∏—Ö</h2>
<p class="desc">–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ —á–µ–ª–ª–µ–Ω–¥–∂–∏</p>
<div class="grid">
<div class="card" style="background:linear-gradient(135deg,#ef4444,#f97316)" onclick="go('hotModeScreen')"><div class="card-i">üòà</div><div class="card-t">–ì–æ—Ä—è—á–∏–π —Ä–µ–∂–∏–º</div><div class="card-d">–¢–∞–π–º–µ—Ä + –∑–∞–¥–∞–Ω–∏—è</div></div>
<div class="card" style="background:linear-gradient(135deg,#8b5cf6,#a855f7)" onclick="go('wishesScreen')"><div class="card-i">üéÅ</div><div class="card-t">–ñ–µ–ª–∞–Ω–∏—è</div><div class="card-d">–°–µ–∫—Ä–µ—Ç–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è</div></div>
<div class="card" style="background:linear-gradient(135deg,#06b6d4,#22d3ee)" onclick="go('challengesScreen')"><div class="card-i">üéØ</div><div class="card-t">–ß–µ–ª–ª–µ–Ω–¥–∂–∏</div><div class="card-d">–ó–∞–¥–∞–Ω–∏—è –Ω–∞ –Ω–µ–¥–µ–ª—é</div></div>
<div class="card" style="background:linear-gradient(135deg,#f472b6,#fb7185)" onclick="go('confessScreen')"><div class="card-i">üíå</div><div class="card-t">–ü—Ä–∏–∑–Ω–∞–Ω–∏—è</div><div class="card-d">–ê–Ω–æ–Ω–∏–º–Ω–æ –ø–∞—Ä—Ç–Ω—ë—Ä—É</div></div>
</div>
<h2>üèÜ –ü—Ä–æ–≥—Ä–µ—Å—Å</h2>
<p class="desc">–í–∞—à–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è</p>
<div class="grid">
<div class="card" style="background:linear-gradient(135deg,#fbbf24,#f59e0b)" onclick="go('achieveScreen')"><div class="card-i">üèÜ</div><div class="card-t">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div><div class="card-d" id="achieveCount">0 –∏–∑ 24</div></div>
<div class="card" style="background:linear-gradient(135deg,#34d399,#10b981)" onclick="go('statsScreen')"><div class="card-i">üìä</div><div class="card-t">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div><div class="card-d">–í–∞—à–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è</div></div>
</div>
<h2>üíï –î–ª—è –¥–≤–æ–∏—Ö</h2>
<p class="desc">–û–±—â–µ–Ω–∏–µ –∏ —ç–º–æ—Ü–∏–∏</p>
<div class="grid">
<div class="card" style="background:linear-gradient(135deg,#3b82f6,#60a5fa)" onclick="go('chatScreen');loadChat()"><div class="card-i">üí¨</div><div class="card-t">–ß–∞—Ç</div><div class="card-d">–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div></div>
<div class="card" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa)" onclick="go('diaryScreen');renderDiary()"><div class="card-i">üìñ</div><div class="card-t">–î–Ω–µ–≤–Ω–∏–∫</div><div class="card-d">–í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã</div></div>
<div class="card" style="background:linear-gradient(135deg,#ec4899,#f472b6)" onclick="go('moodScreen');renderMood()"><div class="card-i">üòä</div><div class="card-t">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div><div class="card-d">–ö–∞–∫ –≤—ã —Å–µ–≥–æ–¥–Ω—è?</div></div>
<div class="card" style="background:linear-gradient(135deg,#f97316,#fb923c)" onclick="go('dateIdeaScreen');renderDateIdea()"><div class="card-i">üé≤</div><div class="card-t">–°–≤–∏–¥–∞–Ω–∏–µ</div><div class="card-d">–°–ª—É—á–∞–π–Ω–∞—è –∏–¥–µ—è</div></div>
<div class="card" style="background:linear-gradient(135deg,#ef4444,#f87171)" onclick="go('complimentScreen');renderCompliment()"><div class="card-i">üíå</div><div class="card-t">–ö–æ–º–ø–ª–∏–º–µ–Ω—Ç</div><div class="card-d">–î–ª—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞</div></div>
<div class="card" style="background:linear-gradient(135deg,#10b981,#34d399)" onclick="go('giftsScreen');renderGifts()"><div class="card-i">üéÅ</div><div class="card-t">–ü–æ–¥–∞—Ä–∫–∏</div><div class="card-d">–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ</div></div>
</div>
<h2>üé∞ –ò–≥—Ä—ã 18+</h2>
<p class="desc">–ì–æ—Ä—è—á–∏–µ —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</p>
<div class="grid">
<div class="card" style="background:linear-gradient(135deg,#dc2626,#ef4444)" onclick="go('truthDareScreen');renderTruthDare()"><div class="card-i">üî•</div><div class="card-t">–ü—Ä–∞–≤–¥–∞/–î–µ–π—Å—Ç–≤–∏–µ</div><div class="card-d">18+ –≤–µ—Ä—Å–∏—è</div></div>
<div class="card" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6)" onclick="go('wouldRatherScreen');renderWouldRather()"><div class="card-i">ü§î</div><div class="card-t">–ß—Ç–æ –≤—ã–±–µ—Ä–µ—à—å?</div><div class="card-d">–ü–∏–∫–∞–Ω—Ç–Ω—ã–π –≤—ã–±–æ—Ä</div></div>
<div class="card" style="background:linear-gradient(135deg,#0891b2,#06b6d4)" onclick="go('spinWheelScreen');renderSpinWheel()"><div class="card-i">üé°</div><div class="card-t">–ö–æ–ª–µ—Å–æ</div><div class="card-d">–°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä</div></div>
<div class="card" style="background:linear-gradient(135deg,#be185d,#ec4899)" onclick="go('secretsScreen');renderSecrets()"><div class="card-i">ü§´</div><div class="card-t">–°–µ–∫—Ä–µ—Ç—ã</div><div class="card-d">–†–∞—Å–∫—Ä–æ–π—Ç–µ –≤–º–µ—Å—Ç–µ</div></div>
</div>
<h2>ü§∞ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
<p class="desc">–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å –∏ –∑–¥–æ—Ä–æ–≤—å–µ</p>
<div class="grid">
<div class="card c7" onclick="go('pregScreen')"><div class="card-i">üë∂</div><div class="card-t">–ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å</div><div class="card-d">40 –Ω–µ–¥–µ–ª—å</div></div>
<div class="card c8" onclick="go('cycleScreen')"><div class="card-i">üåô</div><div class="card-t">–¶–∏–∫–ª</div><div class="card-d">–§–µ—Ä—Ç–∏–ª—å–Ω–æ—Å—Ç—å</div></div>
</div>
</div>
</div>
<div class="screen" id="questionsScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2 id="qTitle">üí¨ 200 –≤–æ–ø—Ä–æ—Å–æ–≤</h2><p class="desc">–û—Ç –ª—ë–≥–∫–∏—Ö –¥–æ –∑–∞–ø—Ä–µ—Ç–Ω—ã—Ö</p><div id="lvList"></div></div></div>
<div class="screen" id="qPlayScreen"><div class="back" onclick="go('questionsScreen')">‚Üê –£—Ä–æ–≤–Ω–∏</div><div class="qc" id="qContainer"></div></div>
<div class="screen" id="kamaScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üî• 50 –ø–æ–∑</h2><div class="tabs"><div class="tab on" onclick="kamaTab('rlt',this)">üé∞ –†—É–ª–µ—Ç–∫–∞</div><div class="tab" onclick="kamaTab('dice',this)">üé≤ –ö—É–±–∏–∫–∏</div><div class="tab" onclick="kamaTab('pos',this)">üìñ –í—Å–µ</div></div><div id="kamaC"></div></div></div>
<div class="screen" id="testsScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üíï 10 —Ç–µ—Å—Ç–æ–≤</h2><p class="desc">–£–∑–Ω–∞–π—Ç–µ –¥—Ä—É–≥ –¥—Ä—É–≥–∞</p><div id="testsList"></div></div></div>
<div class="screen" id="testPlayScreen"><div class="back" onclick="go('testsScreen')">‚Üê –¢–µ—Å—Ç—ã</div><div class="p16" id="testC"></div></div>
<div class="screen" id="calendarScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å</h2><div id="calC"></div></div><button class="cal-add" onclick="openCM()">+</button></div>
<div class="screen" id="tipsScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üí° 20 —Å–æ–≤–µ—Ç–æ–≤</h2><div id="tipsC"></div></div></div>
<div class="screen" id="ideasScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>‚ú® 100 –∏–¥–µ–π</h2><div id="ideasC"></div></div></div>
<div class="screen" id="pregScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>ü§∞ –ë–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å</h2><div id="pregC"></div></div></div>
<div class="screen" id="cycleScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üåô –¶–∏–∫–ª</h2><div id="cycleC"></div></div></div>
<div class="screen" id="hotModeScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üòà –ì–æ—Ä—è—á–∏–π —Ä–µ–∂–∏–º</h2><p class="desc">–¢–∞–π–º–µ—Ä —Å –ø–∏–∫–∞–Ω—Ç–Ω—ã–º–∏ –∑–∞–¥–∞–Ω–∏—è–º–∏</p><div id="hotModeC"></div></div></div>
<div class="screen" id="wishesScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üéÅ –°–µ–∫—Ä–µ—Ç–Ω—ã–µ –∂–µ–ª–∞–Ω–∏—è</h2><p class="desc">–í–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è!</p><div id="wishesC"></div></div></div>
<div class="screen" id="challengesScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üéØ –ß–µ–ª–ª–µ–Ω–¥–∂–∏</h2><p class="desc">–ó–∞–¥–∞–Ω–∏—è –¥–ª—è –ø–∞—Ä—ã –Ω–∞ –Ω–µ–¥–µ–ª—é</p><div id="challengesC"></div></div></div>
<div class="screen" id="confessScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üíå –ê–Ω–æ–Ω–∏–º–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏—è</h2><p class="desc">–ù–∞–ø–∏—à–∏ –ø–∞—Ä—Ç–Ω—ë—Ä—É —Ç–∞–π–Ω–æ</p><div id="confessC"></div></div></div>
<div class="screen" id="achieveScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2><p class="desc">–†–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –Ω–∞–≥—Ä–∞–¥—ã –≤–º–µ—Å—Ç–µ</p><div id="achieveC"></div></div></div>
<div class="screen" id="statsScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2><p class="desc">–í–∞—à–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è –≤ —Ü–∏—Ñ—Ä–∞—Ö</p><div id="statsC"></div></div></div>
<div class="screen" id="chatScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16" style="padding-bottom:80px"><h2>üí¨ –ß–∞—Ç</h2><p class="desc">–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</p><div id="chatC"></div></div><div style="position:fixed;bottom:90px;left:0;right:0;padding:12px 16px;background:var(--bg);border-top:1px solid var(--border);max-width:440px;margin:0 auto"><div style="display:flex;gap:10px"><input type="text" id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1;padding:14px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;color:var(--text);font-size:15px"><button onclick="sendChat()" style="padding:14px 20px;background:var(--accent);border:none;border-radius:14px;color:#fff;font-size:15px;cursor:pointer">‚û§</button></div></div></div>
<div class="screen" id="diaryScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üìñ –î–Ω–µ–≤–Ω–∏–∫</h2><p class="desc">–í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã</p><button onclick="openDiaryModal()" style="width:100%;padding:16px;background:var(--accent);border:none;border-radius:14px;color:#fff;font-size:15px;font-weight:600;cursor:pointer;margin-bottom:16px">+ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</button><div id="diaryC"></div></div></div>
<div class="screen" id="moodScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üòä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</h2><p class="desc">–ö–∞–∫ –≤—ã —Å–µ–≥–æ–¥–Ω—è?</p><div id="moodC"></div></div></div>
<div class="screen" id="dateIdeaScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üé≤ –°–ª—É—á–∞–π–Ω–æ–µ —Å–≤–∏–¥–∞–Ω–∏–µ</h2><p class="desc">–ö—Ä—É—Ç–∏—Ç–µ –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –∏–¥–µ—é!</p><div id="dateIdeaC"></div></div></div>
<div class="screen" id="complimentScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üíå –ö–æ–º–ø–ª–∏–º–µ–Ω—Ç –¥–Ω—è</h2><p class="desc">–û—Ç–ø—Ä–∞–≤—å –ø–∞—Ä—Ç–Ω—ë—Ä—É –ª—é–±–æ–≤—å</p><div id="complimentC"></div></div></div>
<div class="screen" id="giftsScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üéÅ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏</h2><p class="desc">–ü–æ—Ä–∞–¥—É–π –ø–∞—Ä—Ç–Ω—ë—Ä–∞</p><div id="giftsC"></div></div></div>
<div class="screen" id="truthDareScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üî• –ü—Ä–∞–≤–¥–∞ –∏–ª–∏ –î–µ–π—Å—Ç–≤–∏–µ</h2><p class="desc">–ì–æ—Ä—è—á–∞—è –≤–µ—Ä—Å–∏—è 18+</p><div id="truthDareC"></div></div></div>
<div class="screen" id="wouldRatherScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>ü§î –ß—Ç–æ –≤—ã–±–µ—Ä–µ—à—å?</h2><p class="desc">–ü–∏–∫–∞–Ω—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</p><div id="wouldRatherC"></div></div></div>
<div class="screen" id="spinWheelScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üé° –ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã</h2><p class="desc">–ü—É—Å—Ç—å —Å–ª—É—á–∞–π —Ä–µ—à–∏—Ç!</p><div id="spinWheelC"></div></div></div>
<div class="screen" id="secretsScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>ü§´ –°–µ–∫—Ä–µ—Ç—ã</h2><p class="desc">–ù–∞–ø–∏—à–∏—Ç–µ –∏ —Ä–∞—Å–∫—Ä–æ–π—Ç–µ –≤–º–µ—Å—Ç–µ</p><div id="secretsC"></div></div></div>
<div class="screen" id="profileScreen"><div class="back" onclick="go('homeScreen')">‚Üê –ì–ª–∞–≤–Ω–∞—è</div><div class="p16"><h2>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h2><div id="profileC"></div></div></div>
</div>
<nav class="bnav" id="mainNav" style="display:none"><div class="bnav-items">
<button class="bnav-item on" onclick="go('homeScreen')" id="nav0"><span class="bnav-i">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></button>
<button class="bnav-item" onclick="go('questionsScreen')" id="nav1"><span class="bnav-i">üí¨</span><span>–í–æ–ø—Ä–æ—Å—ã</span></button>
<button class="bnav-item" onclick="go('kamaScreen')" id="nav2"><span class="bnav-i">üî•</span><span>–ü–æ–∑—ã</span></button>
<button class="bnav-item" onclick="go('calendarScreen')" id="nav3"><span class="bnav-i">üìÖ</span><span>–ö–∞–ª–µ–Ω–¥–∞—Ä—å</span></button>
<button class="bnav-item" onclick="go('profileScreen');renderProfile()" id="nav4"><span class="bnav-i">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span></button>
</div></nav>
<div class="modal" id="posModal"><div class="modal-c" id="posModalC"></div></div>
<div class="cmodal" id="calModal"><div class="cmodal-c">
<div class="cmodal-h"><div class="cmodal-t">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</div><button class="cmodal-x" onclick="closeCM()">‚úï</button></div>
<div class="fg"><label class="fg-l">–¢–∏–ø</label><div class="type-btns"><div class="type-btn on" onclick="selType('intimate',this)">üíï –ë–ª–∏–∑–æ—Å—Ç—å</div><div class="type-btn" onclick="selType('special',this)">‚≠ê –û—Å–æ–±–µ–Ω–Ω–æ–µ</div></div></div>
<div class="fg"><label class="fg-l">–ß—Ç–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª–∏?</label><input type="text" class="fg-i" id="calTitle" placeholder="–ù–æ–≤–∞—è –ø–æ–∑–∞..."></div>
<div class="fg"><label class="fg-l">–ó–∞–º–µ—Ç–∫–∏</label><textarea class="fg-i" id="calNotes" rows="2" placeholder="–ö–∞–∫ –ø—Ä–æ—à–ª–æ?"></textarea></div>
<div class="fg"><label class="fg-l">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</label><div class="mood-btns"><button class="mood-btn" onclick="selMood('üî•',this)">üî•</button><button class="mood-btn on" onclick="selMood('üòç',this)">üòç</button><button class="mood-btn" onclick="selMood('üòä',this)">üòä</button><button class="mood-btn" onclick="selMood('üí≠',this)">üí≠</button></div></div>
<button class="save-btn" onclick="saveCal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div></div>
<div class="toast" id="toast"></div>
<script>
// ===== CONFIG =====
// ========================================
// üî¥ –í–ê–ñ–ù–û! –ó–ê–ú–ï–ù–ò URL –ù–ê –°–í–û–ô –ò–ó RAILWAY:
// ========================================
const API_HOST = 'explore-api-production.up.railway.app'; // Railway URL
const API = 'https://' + API_HOST + '/api';

// ===== TELEGRAM =====
const tg = window.Telegram?.WebApp;
let tgUser = null;
let userId = null;

if (tg) {
  tg.ready();
  tg.expand();
  if (tg.initDataUnsafe?.user) {
    tgUser = tg.initDataUnsafe.user;
    userId = String(tgUser.id);
  }
}

// ===== STATE =====
let currentUser = null;
let partner = null;
let userPhone = null;
let D = { questionLevels: [], positions: [], tests: [], tips: [], ideas: [], pregnancyInfo: {} };
let S = { progress: {}, calendar: [], pregnancy: null, cycle: [] };
let curLv, curQi = 0, curTest, curTi = 0, testRes = [];
let calMonth = new Date().getMonth(), calYear = new Date().getFullYear();
let calType = 'intimate', calMood = 'üòç';
let cycleMonth = new Date().getMonth(), cycleYear = new Date().getFullYear();

// ===== AUTH FLOW =====
async function checkAuth() {
  if (!userId) {
    // –ù–µ—Ç Telegram ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    showAuthStatus('‚ö†Ô∏è –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram', 'error');
    return;
  }
  
  try {
    const r = await fetch(API + '/user/' + userId + '/status');
    const data = await r.json();
    console.log('Auth check:', data);
    
    if (data.registered) {
      currentUser = data.user;
      partner = data.partner;
      enterApp();
    }
    // else stay on auth screen
  } catch (e) {
    console.log('API error:', e);
    showAuthStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
  }
}

// –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram
async function authWithTelegram() {
  if (!tg) {
    showAuthStatus('‚ö†Ô∏è –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞', 'error');
    return;
  }
  
  showAuthStatus('–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞...', 'info');
  
  // –ó–∞–ø—Ä–æ—Å –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —á–µ—Ä–µ–∑ Telegram
  try {
    tg.requestContact((sent, event) => {
      console.log('Contact response:', sent, event);
      if (sent && event?.responseUnsafe?.contact) {
        userPhone = event.responseUnsafe.contact.phone_number;
        console.log('Got phone:', userPhone);
        showAuthStatus('‚úÖ –ù–æ–º–µ—Ä –ø–æ–ª—É—á–µ–Ω: ' + userPhone, 'success');
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        checkIfRegistered();
      } else {
        showAuthStatus('‚ùå –ù–æ–º–µ—Ä –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
      }
    });
  } catch(e) {
    console.log('Contact error:', e);
    showAuthStatus('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–æ–º–µ—Ä–∞', 'error');
  }
}

async function checkIfRegistered() {
  try {
    const r = await fetch(API + '/user/' + userId + '/status');
    const data = await r.json();
    
    if (data.registered) {
      currentUser = data.user;
      partner = data.partner;
      if (partner) {
        // –£–∂–µ –µ—Å—Ç—å –ø–∞—Ä–∞ ‚Äî –≤—Ö–æ–¥–∏–º
        enterApp();
      } else {
        // –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ –±–µ–∑ –ø–∞—Ä—ã ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥
        goTo('registerScreen');
        document.getElementById('myPairCode').textContent = currentUser.pairCode || '------';
      }
    } else {
      // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
      goTo('pairChoiceScreen');
    }
  } catch(e) {
    showAuthStatus('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', 'error');
  }
}

function showAuthStatus(msg, type) {
  const el = document.getElementById('authStatus');
  if (el) {
    el.className = 'pair-status ' + type;
    el.textContent = msg;
  }
}

function showAuth() {
  goTo('authScreen');
  document.getElementById('mainNav').style.display = 'none';
}

function showPairChoice() {
  goTo('pairChoiceScreen');
}

function goTo(screenId) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
}

async function showRegister() {
  goTo('registerScreen');
  
  // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–æ–ª—É—á–∞–µ–º –∫–æ–¥
  try {
    const r = await fetch(API + '/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        odUserId: userId,
        odName: tgUser?.first_name || '–ì–æ—Å—Ç—å',
        odPhone: userPhone || ''
      })
    });
    const data = await r.json();
    console.log('Register response:', data);
    
    if (data.success) {
      currentUser = data.user;
      document.getElementById('myPairCode').textContent = data.pairCode;
      toast('‚úÖ –ö–æ–¥ —Å–æ–∑–¥–∞–Ω!');
    } else if (data.error === 'exists') {
      // User exists, get their code
      const status = await fetch(API + '/user/' + userId + '/status');
      const statusData = await status.json();
      currentUser = statusData.user;
      partner = statusData.partner;
      
      if (partner) {
        // –£–∂–µ –µ—Å—Ç—å –ø–∞—Ä–∞
        toast('–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä!');
        enterApp();
      } else if (currentUser?.pairCode) {
        document.getElementById('myPairCode').textContent = currentUser.pairCode;
      }
    }
  } catch (e) {
    console.log('Register error:', e);
    toast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
  }
}

function showJoin() {
  goTo('joinScreen');
  setTimeout(() => document.getElementById('joinCodeInput').focus(), 100);
}

async function joinPartner() {
  const code = document.getElementById('joinCodeInput').value.trim().toUpperCase();
  if (code.length < 4) {
    showJoinStatus('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–∞—Ä—Ç–Ω—ë—Ä–∞', 'error');
    return;
  }
  
  showJoinStatus('–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...', 'info');
  
  try {
    console.log('Joining with:', { userId, code, phone: userPhone });
    const r = await fetch(API + '/join', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        odUserId: userId,
        odName: tgUser?.first_name || '–ì–æ—Å—Ç—å',
        odPhone: userPhone || '',
        odPairCode: code
      })
    });
    const data = await r.json();
    console.log('Join response:', data);
    
    if (data.success) {
      currentUser = data.user;
      partner = data.partner;
      showJoinStatus('‚úÖ –°–≤—è–∑–∞–Ω–æ —Å ' + partner.name + '!', 'success');
      if (tg) tg.HapticFeedback?.notificationOccurred('success');
      toast('üéâ –í—ã —Å–≤—è–∑–∞–Ω—ã —Å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º!');
      setTimeout(enterApp, 1000);
    } else {
      const msg = data.message || (
        data.error === 'invalid_code' ? '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥' : 
        data.error === 'used' ? '‚ùå –ö–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω' :
        data.error === 'exists' ? '‚ùå –í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã' : 
        '‚ùå –û—à–∏–±–∫–∞: ' + data.error
      );
      showJoinStatus(msg, 'error');
      if (tg) tg.HapticFeedback?.notificationOccurred('error');
    }
  } catch (e) {
    console.log('Join error:', e);
    showJoinStatus('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
  }
}

function showJoinStatus(msg, type) {
  const el = document.getElementById('joinStatus');
  el.className = 'pair-status ' + type;
  el.textContent = msg;
}

function copyCode() {
  const code = document.getElementById('myPairCode').textContent;
  navigator.clipboard?.writeText(code);
  toast('üìã –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
  if (tg) tg.HapticFeedback?.impactOccurred('light');
}

function continueAlone() {
  enterApp();
}

function enterApp() {
  document.getElementById('mainNav').style.display = 'block';
  go('homeScreen');
  
  // Update header
  document.getElementById('userName').textContent = currentUser?.name || tgUser?.first_name || '';
  
  if (partner) {
    document.getElementById('partnerStatus').textContent = 'üíï ' + partner.name;
    document.getElementById('partnerBadge').innerHTML = 
      '<div class="partner-badge"><div class="partner-badge-icon partner-heart">üíë</div><div class="partner-badge-info"><div class="partner-badge-name">–ü–∞—Ä–∞ —Å ' + partner.name + '</div><div class="partner-badge-status">–ê–∫–∫–∞—É–Ω—Ç—ã —Å–≤—è–∑–∞–Ω—ã</div></div></div>';
  } else if (currentUser?.pairCode) {
    document.getElementById('partnerStatus').textContent = '–ö–æ–¥: ' + currentUser.pairCode;
    document.getElementById('partnerBadge').innerHTML = 
      '<div class="partner-badge" onclick="showRegister()"><div class="partner-badge-icon">üîó</div><div class="partner-badge-info"><div class="partner-badge-name">–°–≤—è–∑–∞—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–∞</div><div class="partner-badge-status">–ö–æ–¥: ' + currentUser.pairCode + '</div></div></div>';
  }
  
  loadData();
  updateDashboard();
}

function updateDashboard() {
  const level = currentUser?.level || 1;
  const xp = currentUser?.xp || 0;
  const coins = currentUser?.coins || 100;
  const streak = S.streak?.current || 0;
  const days = currentUser?.coupleId && partner ? Math.floor((Date.now() - new Date(currentUser.created).getTime()) / 86400000) : 0;
  
  document.getElementById('dashLevel').textContent = '‚≠ê ' + level;
  document.getElementById('dashCoins').textContent = 'ü™ô ' + coins;
  document.getElementById('dashStreak').textContent = 'üî• ' + streak;
  document.getElementById('dashDays').textContent = 'üíë ' + days;
  
  const xpInLevel = xp % 100;
  const xpToNext = 100 - xpInLevel;
  document.getElementById('xpLabel').textContent = xp + ' XP';
  document.getElementById('xpNext').textContent = '–î–æ —Å–ª–µ–¥. —É—Ä–æ–≤–Ω—è: ' + xpToNext;
  document.getElementById('xpBar').style.width = xpInLevel + '%';
  
  // Achievements count
  const achCount = S.achievements?.length || 0;
  document.getElementById('achieveCount').textContent = achCount + ' –∏–∑ 24';
}

// ===== DATA =====
async function loadData() {
  try {
    const r = await fetch(API + '/content');
    D = await r.json();
  } catch (e) { console.log('Content error'); }

  if (userId && currentUser) {
    try {
      const r = await fetch(API + '/user/' + userId);
      const data = await r.json();
      if (data.progress) S.progress = data.progress;
      if (data.calendar) S.calendar = data.calendar;
      if (data.pregnancy) S.pregnancy = data.pregnancy;
      if (data.cycles) S.cycle = data.cycles;
    } catch (e) {
      S = JSON.parse(localStorage.getItem('exploreMega') || '{}');
    }
  } else {
    S = JSON.parse(localStorage.getItem('exploreMega') || '{}');
  }
  
  S.progress = S.progress || {};
  S.calendar = S.calendar || [];
  S.cycle = S.cycle || [];
  init();
}

function saveState() {
  localStorage.setItem('exploreMega', JSON.stringify(S));
  if (userId && currentUser) {
    fetch(API + '/user/' + userId + '/sync', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ progress: S.progress, calendar: S.calendar, pregnancy: S.pregnancy, cycles: S.cycle })
    }).catch(() => {});
  }
}

function init() {
  if (D.questionLevels?.length) renderLevels();
  renderRoulette();
  if (D.tests?.length) renderTests();
  if (D.tips?.length) renderTips();
  if (D.ideas?.length) renderIdeas();
  renderCalendar();
  renderPregnancy();
  renderCycle();
  initNewScreens();
}

// ===== NAV =====
function go(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.bnav-item').forEach(n => n.classList.remove('on'));
  const m = { homeScreen: 'nav0', questionsScreen: 'nav1', qPlayScreen: 'nav1', kamaScreen: 'nav2', calendarScreen: 'nav3', pregScreen: 'nav4', cycleScreen: 'nav4' };
  if (m[id]) document.getElementById(m[id]).classList.add('on');
  if (tg) tg.HapticFeedback?.impactOccurred('light');
}

function toast(m) { const t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2500); }

// ===== QUESTIONS =====
function renderLevels() {
  let total = 0; D.questionLevels.forEach(l => total += l.questions.length);
  document.getElementById('qTitle').textContent = 'üí¨ ' + total + ' –≤–æ–ø—Ä–æ—Å–æ–≤';
  document.getElementById('lvList').innerHTML = D.questionLevels.map(l => {
    const p = S.progress[l.id] || 0;
    return '<div class="lv ' + l.color + '" onclick="startLv(' + l.id + ')"><div class="lv-h"><span>–£—Ä–æ–≤–µ–Ω—å ' + l.id + '</span><span>' + p + '/' + l.questions.length + '</span></div><div class="lv-t">' + l.icon + ' ' + l.title + '</div><div class="lv-d">' + l.desc + '</div><div class="pb"><div class="pb-f" style="width:' + (p / l.questions.length * 100) + '%"></div></div></div>';
  }).join('');
}

function startLv(id) { curLv = D.questionLevels.find(l => l.id === id); curQi = S.progress[id] || 0; if (curQi >= curLv.questions.length) curQi = 0; renderQ(); go('qPlayScreen'); }

function renderQ() {
  const l = curLv, q = l.questions[curQi];
  let dots = ''; for (let i = 0; i < l.questions.length; i++) dots += '<div class="qp-d' + (i < curQi ? ' done' : '') + (i === curQi ? ' cur' : '') + '"></div>';
  document.getElementById('qContainer').innerHTML = '<div class="qp">' + dots + '</div><div class="qcard ' + l.color + '"><div class="qbadge">' + l.icon + ' ' + l.title + '</div><div class="qicon">üí¨</div><div class="qtext">' + q.q + '</div>' + (q.h ? '<div class="qhint">üí° ' + q.h + '</div>' : '') + '</div><div class="qnav"><button class="qbtn sec" onclick="prevQ()">‚Üê –ù–∞–∑–∞–¥</button><button class="qbtn pri" onclick="nextQ()">–û—Ç–≤–µ—Ç–∏–ª–∏ ‚Üí</button></div>';
}

function nextQ() { curQi++; S.progress[curLv.id] = curQi; saveState(); if (curQi >= curLv.questions.length) { toast('üéâ –£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!'); renderLevels(); go('questionsScreen'); } else renderQ(); }
function prevQ() { if (curQi > 0) { curQi--; renderQ(); } else go('questionsScreen'); }

// ===== KAMA SUTRA =====
function kamaTab(t, el) { document.querySelectorAll('.tabs .tab').forEach(x => x.classList.remove('on')); el.classList.add('on'); if (t === 'rlt') renderRoulette(); else if (t === 'dice') renderDice(); else renderPositions(); }

function renderRoulette() {
  document.getElementById('kamaC').innerHTML = '<div class="rlt" id="rCont"><div class="whl"><div class="whl-c"><div class="whl-n" id="wN">–ö—Ä—É—Ç–∏—Ç–µ!</div><div class="whl-d" id="wD">–í—ã–ø–∞–¥–µ—Ç –ø–æ–∑–∞</div></div></div><button class="sbtn" onclick="spin()">üé∞ –ö—Ä—É—Ç–∏—Ç—å</button><div class="rcard" id="rCard" style="display:none"></div></div>';
}

function spin() {
  if (!D.positions?.length) return toast('–ó–∞–≥—Ä—É–∑–∫–∞...');
  const p = D.positions[Math.floor(Math.random() * D.positions.length)];
  document.getElementById('rCont').classList.add('spin');
  document.getElementById('wN').textContent = '...';
  document.getElementById('wD').textContent = '';
  document.getElementById('rCard').style.display = 'none';
  if (tg) tg.HapticFeedback?.impactOccurred('medium');
  setTimeout(() => {
    document.getElementById('rCont').classList.remove('spin');
    document.getElementById('wN').textContent = p.icon + ' ' + p.name;
    document.getElementById('wD').textContent = '–ù–∞–∂–º–∏—Ç–µ ‚Üì';
    document.getElementById('rCard').style.display = 'block';
    document.getElementById('rCard').innerHTML = '<h3>' + p.icon + ' ' + p.name + '</h3><p>' + p.desc + '</p>';
    document.getElementById('rCard').onclick = () => showPos(p.name);
    if (tg) tg.HapticFeedback?.notificationOccurred('success');
  }, 3000);
}

function renderDice() {
  document.getElementById('kamaC').innerHTML = '<div class="dice-c"><div class="dice-p"><div class="dice a" id="dA"><div class="dice-l">–î–µ–π—Å—Ç–≤–∏–µ</div><div class="dice-v">üé≤</div></div><div class="dice b" id="dB"><div class="dice-l">–ö—É–¥–∞</div><div class="dice-v">üé≤</div></div></div><div class="dres" id="dR"><div class="dres-t">–ë—Ä–æ—Å—å—Ç–µ!</div><div class="dres-s">üòè</div></div><button class="sbtn" onclick="roll()">üé≤ –ë—Ä–æ—Å–∏—Ç—å</button></div>';
}

function roll() {
  const actions = ["–ü–æ—Ü–µ–ª—É–π", "–õ–∏–∑–Ω–∏", "–ü–æ–≥–ª–∞–¥—å", "–ü–æ–¥—É–π", "–£–∫—É—Å–∏", "–ú–∞—Å—Å–∏—Ä—É–π", "–ü–æ—â–µ–∫–æ—á–∏", "–®–µ–ø–Ω–∏"];
  const parts = ["—à–µ—é", "–≥—É–±—ã", "—É—Ö–æ", "–≥—Ä—É–¥—å", "–∂–∏–≤–æ—Ç", "–±–µ–¥—Ä–æ", "—Å–ø–∏–Ω—É", "–ø–æ–ø—É"];
  const d1 = document.getElementById('dA'), d2 = document.getElementById('dB');
  d1.classList.add('roll'); d2.classList.add('roll');
  if (tg) tg.HapticFeedback?.impactOccurred('medium');
  setTimeout(() => {
    d1.classList.remove('roll'); d2.classList.remove('roll');
    const a = actions[Math.floor(Math.random() * actions.length)];
    const b = parts[Math.floor(Math.random() * parts.length)];
    d1.querySelector('.dice-v').textContent = a;
    d2.querySelector('.dice-v').textContent = b;
    document.getElementById('dR').innerHTML = '<div class="dres-t">' + a + ' ' + b + '</div><div class="dres-s">–í—ã–ø–æ–ª–Ω—è–π—Ç–µ! üòè</div>';
  }, 600);
}

function renderPositions() {
  if (!D.positions?.length) return;
  let h = '<div class="pgrid">';
  D.positions.forEach(p => {
    let dots = ''; for (let d = 1; d <= 3; d++) dots += '<div class="pdot' + (d <= p.diff ? ' on' : '') + '"></div>';
    h += '<div class="pcard" onclick="showPos(\'' + p.name.replace(/'/g, "\\'") + '\')"><div class="pcard-i">' + p.icon + '</div><div class="pcard-n">' + p.name + '</div><div class="pdiff">' + dots + '</div></div>';
  });
  document.getElementById('kamaC').innerHTML = h + '</div>';
}

function showPos(name) {
  const p = D.positions.find(x => x.name === name); if (!p) return;
  let dots = ''; for (let d = 1; d <= 3; d++) dots += '<div class="pdot' + (d <= p.diff ? ' on' : '') + '"></div>';
  let steps = ''; (p.howTo || []).forEach((s, i) => steps += '<div class="mstep"><div class="mstep-n">' + (i + 1) + '</div><div class="mstep-t">' + s + '</div></div>');
  let vars = ''; (p.variants || []).forEach(v => vars += '<span class="mvar">' + v + '</span>');
  
  let html = '<div class="modal-h"><div class="modal-i">' + p.icon + '</div><button class="modal-x" onclick="closePos()">‚úï</button></div>';
  html += '<div class="modal-t">' + p.name + '</div>';
  html += '<div class="modal-diff">' + dots + '<span style="margin-left:12px;font-size:13px;color:var(--muted)">' + (p.diff === 1 ? '–õ–µ–≥–∫–æ' : p.diff === 2 ? '–°—Ä–µ–¥–Ω–µ' : '–°–ª–æ–∂–Ω–æ') + '</span></div>';
  html += '<div class="msec"><h4>üìù –û–ø–∏—Å–∞–Ω–∏–µ</h4><p>' + p.desc + '</p></div>';
  html += '<div class="msec"><h4>üìã –ö–∞–∫ –≤—ã–ø–æ–ª–Ω—è—Ç—å</h4><div class="msteps">' + steps + '</div></div>';
  if (p.tip) html += '<div class="mtip"><div class="mtip-t">üí° –°–æ–≤–µ—Ç –ø—Ä–æ—Ñ–∏</div><div class="mtip-c">' + p.tip + '</div></div>';
  if (p.muscles) html += '<div class="msec"><h4>üí™ –ù–∞–≥—Ä—É–∑–∫–∞</h4><p>' + p.muscles + '</p></div>';
  if (p.benefits) html += '<div class="msec"><h4>‚ú® –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞</h4><p>' + p.benefits + '</p></div>';
  if (p.variants?.length) html += '<div class="msec"><h4>üîÑ –í–∞—Ä–∏–∞—Ü–∏–∏</h4><div class="mvars">' + vars + '</div></div>';
  html += '<button onclick="addToTried(\'' + p.name.replace(/'/g, "\\'") + '\')" style="width:100%;padding:16px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:14px;color:#fff;font-size:15px;font-weight:600;cursor:pointer;margin-top:16px">‚úÖ –ú—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª–∏!</button>';
  
  document.getElementById('posModalC').innerHTML = html;
  document.getElementById('posModal').classList.add('show');
}

async function addToTried(posName) {
  if (currentUser?.coupleId) {
    try {
      await fetch(API + '/couple/' + currentUser.coupleId + '/calendar', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ date: new Date().toISOString(), type: 'intimate', position: posName, from: userId })
      });
      toast('üî• ' + posName + ' –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é!');
    } catch(e) { toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); }
  } else {
    toast('–°–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
  }
  closePos();
}

function closePos() { document.getElementById('posModal').classList.remove('show'); }

// ===== TESTS =====
let testResults = {}; // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –ø–∞—Ä—ã

async function renderTests() {
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ –ø–∞—Ä—ã
  if (currentUser?.coupleId) {
    try {
      const r = await fetch(API + '/couple/' + currentUser.coupleId + '/tests');
      testResults = await r.json();
    } catch(e) { testResults = {}; }
  }
  
  const icons = ['tc1', 'tc2', 'tc3', 'tc4', 'tc5', 'tc6', 'tc1', 'tc2', 'tc3', 'tc4'];
  const emojis = ['üíï', 'üé≠', 'üî•', 'üí≠', 'üí¨', '‚ù§Ô∏è', 'üå∂Ô∏è', 'üìä', 'üíë', 'üîÆ'];
  
  document.getElementById('testsList').innerHTML = D.tests.map((t, i) => {
    const myResult = testResults[t.id]?.[userId];
    const partnerResult = partner ? testResults[t.id]?.[partner.id] : null;
    let status = '';
    if (myResult && partnerResult) {
      status = '<div style="color:var(--green);font-size:12px;margin-top:6px">‚úÖ –û–±–∞ –ø—Ä–æ—à–ª–∏ ‚Äî —Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>';
    } else if (myResult) {
      status = '<div style="color:var(--yellow);font-size:12px;margin-top:6px">‚è≥ –ñ–¥—ë–º –ø–∞—Ä—Ç–Ω—ë—Ä–∞</div>';
    } else if (partnerResult) {
      status = '<div style="color:var(--accent);font-size:12px;margin-top:6px">üíï –ü–∞—Ä—Ç–Ω—ë—Ä —É–∂–µ –ø—Ä–æ—à—ë–ª!</div>';
    }
    return '<div class="tcard" onclick="startTest(\'' + t.id + '\')"><div class="tcard-h"><div class="tcard-i ' + icons[i % 10] + '">' + emojis[i % 10] + '</div><div class="tcard-info"><div class="tcard-t">' + t.title + '</div><div class="tcard-d">' + t.desc + '</div><div class="tcard-m">‚è± ' + t.time + ' ‚Ä¢ ' + t.questions.length + ' –≤–æ–ø—Ä–æ—Å–æ–≤</div>' + status + '</div></div></div>';
  }).join('');
}

function startTest(id) {
  curTest = D.tests.find(t => t.id === id);
  curTi = 0;
  testRes = [];
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—à–ª–∏ –ª–∏ –æ–±–∞
  const myResult = testResults[id]?.[userId];
  const partnerResult = partner ? testResults[id]?.[partner.id] : null;
  
  if (myResult && partnerResult) {
    // –û–±–∞ –ø—Ä–æ—à–ª–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
    showTestComparison(id, myResult, partnerResult);
    go('testPlayScreen');
  } else if (myResult) {
    // –Ø —É–∂–µ –ø—Ä–æ—à—ë–ª - –ø–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –∂–¥—ë–º –ø–∞—Ä—Ç–Ω—ë—Ä–∞
    showWaitingForPartner(id);
    go('testPlayScreen');
  } else {
    // –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç
    renderTestQ();
    go('testPlayScreen');
  }
}

function renderTestQ() {
  const t = curTest, q = t.questions[curTi];
  document.getElementById('testC').innerHTML = '<div class="tq"><div class="tq-n">–í–æ–ø—Ä–æ—Å ' + (curTi + 1) + ' –∏–∑ ' + t.questions.length + '</div><div class="tq-t">' + q.q + '</div><div class="tq-opts">' + q.opts.map((o, i) => '<div class="tq-opt" onclick="selOpt(' + i + ')">' + o + '</div>').join('') + '</div></div>';
}

async function selOpt(i) {
  testRes.push(i);
  curTi++;
  if (curTi >= curTest.questions.length) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    await saveTestResult();
  } else {
    renderTestQ();
  }
}

async function saveTestResult() {
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  if (currentUser?.coupleId) {
    try {
      await fetch(API + '/couple/' + currentUser.coupleId + '/tests', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ testId: curTest.id, odUserId: userId, answers: testRes })
      });
    } catch(e) { console.log(e); }
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
  if (!testResults[curTest.id]) testResults[curTest.id] = {};
  testResults[curTest.id][userId] = testRes;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞
  const partnerResult = partner ? testResults[curTest.id]?.[partner.id] : null;
  
  if (partnerResult) {
    showTestComparison(curTest.id, testRes, partnerResult);
  } else {
    showWaitingForPartner(curTest.id);
  }
}

function showWaitingForPartner(testId) {
  document.getElementById('testC').innerHTML = '<div class="tres"><div class="tres-i">‚è≥</div><div class="tres-t">–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!</div><div style="font-size:16px;color:var(--text2);margin:20px 0;line-height:1.6">–¢–µ–ø–µ—Ä—å –ø–æ–ø—Ä–æ—Å–∏—Ç–µ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –ø—Ä–æ–π—Ç–∏ —ç—Ç–æ—Ç —Ç–µ—Å—Ç.<br><br>–ö–æ–≥–¥–∞ –æ–±–∞ –ø—Ä–æ–π–¥—É—Ç ‚Äî —É–≤–∏–¥–∏—Ç–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å!</div>' + (partner ? '<div style="background:var(--bg2);border-radius:12px;padding:16px;margin-bottom:20px"><div style="font-size:14px;color:var(--text2)">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–∞—Ä—Ç–Ω—ë—Ä—É:</div><div style="font-size:16px;margin-top:8px">üíï –ü—Ä–æ–π–¥–∏ —Ç–µ—Å—Ç "' + curTest.title + '" –≤ Explore!</div></div>' : '') + '<button class="sbtn" onclick="go(\'testsScreen\');renderTests()" style="margin-top:24px">–ì–æ—Ç–æ–≤–æ</button></div>';
}

function showTestComparison(testId, myAnswers, partnerAnswers) {
  const test = D.tests.find(t => t.id === testId);
  if (!test) return;
  
  // –°—á–∏—Ç–∞–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
  let matches = 0;
  for (let i = 0; i < myAnswers.length && i < partnerAnswers.length; i++) {
    if (myAnswers[i] === partnerAnswers[i]) matches++;
  }
  
  const total = Math.min(myAnswers.length, partnerAnswers.length);
  const score = total > 0 ? Math.round((matches / total) * 100) : 0;
  
  let title, desc;
  if (score >= 80) {
    title = '–ò–¥–µ–∞–ª—å–Ω–∞—è –ø–∞—Ä–∞! üî•';
    desc = '–í—ã –¥—É–º–∞–µ—Ç–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ –≤ ' + matches + ' –∏–∑ ' + total + ' –≤–æ–ø—Ä–æ—Å–æ–≤!';
  } else if (score >= 60) {
    title = '–û—Ç–ª–∏—á–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å! üíï';
    desc = '–°–æ–≤–ø–∞–ª–∏ –≤ ' + matches + ' –∏–∑ ' + total + ' –≤–æ–ø—Ä–æ—Å–æ–≤. –£ –≤–∞—Å –º–Ω–æ–≥–æ –æ–±—â–µ–≥–æ!';
  } else if (score >= 40) {
    title = '–ï—Å—Ç—å –Ω–∞–¥ —á–µ–º –ø–æ—Ä–∞–±–æ—Ç–∞—Ç—å üí≠';
    desc = '–°–æ–≤–ø–∞–ª–∏ –≤ ' + matches + ' –∏–∑ ' + total + '. –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ ‚Äî —ç—Ç–æ —Ö–æ—Ä–æ—à–æ!';
  } else {
    title = '–í—ã —Ä–∞–∑–Ω—ã–µ ‚Äî –∏ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! üåà';
    desc = '–°–æ–≤–ø–∞–ª–∏ –≤ ' + matches + ' –∏–∑ ' + total + '. –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø—Ä–∏—Ç—è–≥–∏–≤–∞—é—Ç—Å—è!';
  }
  
  document.getElementById('testC').innerHTML = '<div class="tres"><div class="tres-i">üíë</div><div class="tres-t">' + title + '</div><div class="tres-s">' + score + '%</div><div class="tres-d">' + desc + '</div><button class="sbtn" onclick="go(\'testsScreen\');renderTests()" style="margin-top:24px">–ì–æ—Ç–æ–≤–æ</button><button style="margin-top:12px;padding:14px 24px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;color:var(--text);font-size:14px;cursor:pointer" onclick="retakeTest(\'' + testId + '\')">üîÑ –ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ</button></div>';
}

async function retakeTest(testId) {
  // –£–¥–∞–ª—è–µ–º —Å–≤–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  if (testResults[testId]) delete testResults[testId][userId];
  
  if (currentUser?.coupleId) {
    try {
      await fetch(API + '/couple/' + currentUser.coupleId + '/tests/' + testId + '/reset', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ odUserId: userId })
      });
    } catch(e) {}
  }
  
  curTest = D.tests.find(t => t.id === testId);
  curTi = 0;
  testRes = [];
  renderTestQ();
}

// ===== TIPS & IDEAS =====
function renderTips() {
  document.getElementById('tipsC').innerHTML = D.tips.map(t => {
    const icon = t.icon === 'her' ? 'üë©' : t.icon === 'him' ? 'üë®' : 'üíë';
    const steps = (t.steps || []).map((s, j) => '<div class="tip-step"><div class="tip-step-n">' + (j + 1) + '</div><div class="tip-step-t">' + s + '</div></div>').join('');
    return '<div class="tip-card"><div class="tip-h"><div class="tip-i ' + t.icon + '">' + icon + '</div><div><div class="tip-cat">' + t.cat + '</div><div class="tip-t">' + t.title + '</div></div></div><div class="tip-c">' + t.content + '</div><div class="tip-steps">' + steps + '</div></div>';
  }).join('');
}

function renderIdeas() {
  document.getElementById('ideasC').innerHTML = D.ideas.map(c =>
    '<div class="idea-sec"><h3>' + c.cat + '</h3><div class="idea-tags">' + c.items.map(i => '<div class="idea-tag">' + i + '</div>').join('') + '</div></div>'
  ).join('');
}

// ===== CALENDAR =====
function renderCalendar() {
  const months = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
  const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
  const fd = new Date(calYear, calMonth, 1).getDay();
  const dim = new Date(calYear, calMonth + 1, 0).getDate();
  const today = new Date();
  const sd = (fd + 6) % 7;
  
  let dh = ''; for (let i = 0; i < sd; i++) dh += '<div class="cal-day other"></div>';
  for (let d = 1; d <= dim; d++) {
    const ds = calYear + '-' + String(calMonth + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
    const hasE = S.calendar.some(e => e.date === ds);
    const isToday = today.getDate() === d && today.getMonth() === calMonth && today.getFullYear() === calYear;
    dh += '<div class="cal-day' + (isToday ? ' today' : '') + (hasE ? ' has' : '') + '" onclick="showDay(\'' + ds + '\')">' + d + '</div>';
  }
  
  const wd = days.map(d => '<div class="cal-wd">' + d + '</div>').join('');
  const prefix = calYear + '-' + String(calMonth + 1).padStart(2, '0');
  const eh = S.calendar.filter(e => e.date.startsWith(prefix)).map(e =>
    '<div class="cal-e"><div class="cal-e-h"><div class="cal-e-d">' + e.date.split('-')[2] + ' ' + months[calMonth] + '</div><div class="cal-e-type">' + e.mood + '</div></div><div class="cal-e-c"><b>' + e.title + '</b>' + (e.notes ? ' ‚Äî ' + e.notes : '') + '</div></div>'
  ).join('');
  
  document.getElementById('calC').innerHTML = '<div class="cal-h"><button class="cal-nav" onclick="chMonth(-1)">‚Üê</button><div class="cal-m">' + months[calMonth] + ' ' + calYear + '</div><button class="cal-nav" onclick="chMonth(1)">‚Üí</button></div><div class="cal-w">' + wd + '</div><div class="cal-days">' + dh + '</div>' + eh;
}

function chMonth(d) { calMonth += d; if (calMonth > 11) { calMonth = 0; calYear++; } if (calMonth < 0) { calMonth = 11; calYear--; } renderCalendar(); }
function showDay(d) { const e = S.calendar.find(x => x.date === d); if (e) toast(e.mood + ' ' + e.title); else openCM(); }
function openCM() { document.getElementById('calModal').classList.add('show'); }
function closeCM() { document.getElementById('calModal').classList.remove('show'); }
function selType(t, el) { calType = t; document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('on')); el.classList.add('on'); }
function selMood(m, el) { calMood = m; document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('on')); el.classList.add('on'); }
function saveCal() {
  const title = document.getElementById('calTitle').value; if (!title) { toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
  const t = new Date();
  S.calendar.push({ date: t.getFullYear() + '-' + String(t.getMonth() + 1).padStart(2, '0') + '-' + String(t.getDate()).padStart(2, '0'), type: calType, title, notes: document.getElementById('calNotes').value, mood: calMood });
  saveState(); closeCM(); renderCalendar(); toast('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
  document.getElementById('calTitle').value = ''; document.getElementById('calNotes').value = '';
}

// ===== PREGNANCY =====
function renderPregnancy() {
  const info = D.pregnancyInfo || {};
  if (!S.pregnancy) {
    const clHtml = info.checklist ? '<div style="margin-top:24px"><h2 style="font-size:18px;margin-bottom:16px">üìã –ß–µ–∫-–ª–∏—Å—Ç—ã</h2>' + renderChecklists(info.checklist) + '</div>' : '';
    document.getElementById('pregC').innerHTML = '<div class="preg-setup"><h3>ü§∞ –ù–∞—á–∞—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ</h3><p style="font-size:14px;color:var(--text2);margin-bottom:18px">–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏–∏</p><input type="date" class="preg-input" id="pregDate"><button class="preg-btn" onclick="startPreg()">–ù–∞—á–∞—Ç—å</button></div>' + clHtml;
  } else {
    const start = new Date(S.pregnancy.lastPeriod);
    const weeks = Math.floor((new Date() - start) / (7 * 24 * 60 * 60 * 1000));
    const cw = Math.min(Math.max(weeks, 1), 40);
    const wi = (info.weeks || []).filter(w => w.week <= cw).pop() || { week: cw, size: 'üçá', sizeName: '', dev: '', tips: [] };
    const tipsHtml = (wi.tips || []).map(t => '<div class="preg-tip">‚Ä¢ ' + t + '</div>').join('');
    const clHtml = info.checklist ? '<h2 style="font-size:18px;margin-bottom:16px">üìã –ß–µ–∫-–ª–∏—Å—Ç—ã</h2>' + renderChecklists(info.checklist) : '';
    document.getElementById('pregC').innerHTML = '<div class="preg-wk"><div class="preg-h"><div class="preg-w">–ù–µ–¥–µ–ª—è ' + cw + '</div><div class="preg-size"><div class="preg-size-i">' + wi.size + '</div><div class="preg-size-t">' + (wi.sizeName || '') + '</div></div></div><div class="preg-dev">' + (wi.dev || '') + '</div><div class="preg-tips">' + tipsHtml + '</div></div><button class="sbtn" style="width:100%;margin-bottom:20px" onclick="resetPreg()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>' + clHtml;
  }
}

function renderChecklists(cl) {
  if (!cl) return '';
  return [{ key: 'trimester1', title: '1 —Ç—Ä–∏–º–µ—Å—Ç—Ä' }, { key: 'trimester2', title: '2 —Ç—Ä–∏–º–µ—Å—Ç—Ä' }, { key: 'trimester3', title: '3 —Ç—Ä–∏–º–µ—Å—Ç—Ä' }, { key: 'hospital', title: '–°—É–º–∫–∞ –≤ —Ä–æ–¥–¥–æ–º' }].map(sec => {
    const items = (cl[sec.key] || []).map((item, i) => {
      const done = S['chk_' + sec.key + '_' + i];
      return '<div class="check-item"><div class="check-box' + (done ? ' done' : '') + '" onclick="toggleChk(\'' + sec.key + '\',' + i + ')">' + (done ? '‚úì' : '') + '</div><span>' + item + '</span></div>';
    }).join('');
    return '<div class="checklist"><h4>' + sec.title + '</h4>' + items + '</div>';
  }).join('');
}

function toggleChk(k, i) { S['chk_' + k + '_' + i] = !S['chk_' + k + '_' + i]; saveState(); renderPregnancy(); }
function startPreg() { const d = document.getElementById('pregDate').value; if (!d) { toast('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É'); return; } const lmp = new Date(d); const due = new Date(lmp); due.setDate(due.getDate() + 280); S.pregnancy = { lastPeriod: d, dueDate: due.toISOString().split('T')[0] }; saveState(); renderPregnancy(); toast('ü§∞ –ù–∞—á–∞—Ç–æ!'); }
function resetPreg() { S.pregnancy = null; saveState(); renderPregnancy(); }

// ===== CYCLE =====
function renderCycle() {
  const info = (D.pregnancyInfo || {}).cycleInfo || { phases: [], fertileDays: '', signs: [] };
  const months = ['–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'];
  const days = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
  const fd = new Date(cycleYear, cycleMonth, 1).getDay();
  const dim = new Date(cycleYear, cycleMonth + 1, 0).getDate();
  const sd = (fd + 6) % 7;
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–∏–∫–ª–∞
  if (!S.cycleSettings) S.cycleSettings = { cycleLength: 28, periodLength: 5 };
  const cycleLen = S.cycleSettings.cycleLength || 28;
  const periodLen = S.cycleSettings.periodLength || 5;
  
  // –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–∏–æ–¥–æ–≤
  if (!S.cyclePeriods) S.cyclePeriods = [];
  const lastPeriod = S.cyclePeriods[0];
  
  let pDays = [], fDays = [], ovDay = null;
  if (lastPeriod && !lastPeriod.ended) {
    // –¢–µ–∫—É—â–∏–µ –º–µ—Å—è—á–Ω—ã–µ
    const st = new Date(lastPeriod.start);
    for (let i = 0; i < periodLen; i++) { const nd = new Date(st); nd.setDate(nd.getDate() + i); pDays.push(nd.toISOString().split('T')[0]); }
  }
  if (lastPeriod) {
    // –ü—Ä–æ–≥–Ω–æ–∑ —Ñ–µ—Ä—Ç–∏–ª—å–Ω—ã—Ö –¥–Ω–µ–π –∏ –æ–≤—É–ª—è—Ü–∏–∏
    const st = new Date(lastPeriod.start);
    const ovulationDay = cycleLen - 14;
    for (let i = ovulationDay - 5; i <= ovulationDay; i++) { const nd = new Date(st); nd.setDate(nd.getDate() + i); fDays.push(nd.toISOString().split('T')[0]); }
    const ov = new Date(st); ov.setDate(ov.getDate() + ovulationDay); ovDay = ov.toISOString().split('T')[0];
  }
  
  let dh = ''; for (let i = 0; i < sd; i++) dh += '<div class="cal-day other"></div>';
  for (let d = 1; d <= dim; d++) {
    const ds = cycleYear + '-' + String(cycleMonth + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
    let cls = pDays.includes(ds) ? ' period' : ds === ovDay ? ' ovul' : fDays.includes(ds) ? ' fertile' : '';
    dh += '<div class="cal-day' + cls + '">' + d + '</div>';
  }
  
  const wd = days.map(d => '<div class="cal-wd">' + d + '</div>').join('');
  
  // –°—Ç–∞—Ç—É—Å
  let statusHtml = '';
  if (lastPeriod && !lastPeriod.ended) {
    const dayNum = Math.floor((new Date() - new Date(lastPeriod.start)) / (24*60*60*1000)) + 1;
    statusHtml = '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px;text-align:center"><div style="font-size:32px;margin-bottom:8px">üî¥</div><div style="font-size:18px;font-weight:700">–î–µ–Ω—å ' + dayNum + ' –º–µ—Å—è—á–Ω—ã—Ö</div><div style="font-size:14px;color:var(--text2);margin-top:4px">–ù–∞—á–∞–ª–æ—Å—å: ' + new Date(lastPeriod.start).toLocaleDateString('ru') + '</div></div>';
  } else if (lastPeriod) {
    const daysSince = Math.floor((new Date() - new Date(lastPeriod.start)) / (24*60*60*1000));
    const daysUntilNext = cycleLen - daysSince;
    const cycleDay = daysSince + 1;
    statusHtml = '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px;text-align:center"><div style="font-size:18px;font-weight:700">–î–µ–Ω—å ' + cycleDay + ' —Ü–∏–∫–ª–∞</div><div style="font-size:14px;color:var(--text2);margin-top:4px">–î–æ —Å–ª–µ–¥—É—é—â–∏—Ö: ~' + Math.max(0, daysUntilNext) + ' –¥–Ω–µ–π</div></div>';
  }
  
  // –ö–Ω–æ–ø–∫–∏
  let btnsHtml = '';
  if (!lastPeriod || lastPeriod.ended) {
    btnsHtml = '<button style="width:100%;padding:16px;background:var(--red);border:none;border-radius:14px;color:#fff;font-size:15px;font-weight:600;cursor:pointer;margin-top:16px" onclick="startPeriod()">üî¥ –ù–∞—á–∞–ª–æ –º–µ—Å—è—á–Ω—ã—Ö</button>';
  } else {
    btnsHtml = '<div style="display:flex;gap:10px;margin-top:16px"><button style="flex:1;padding:16px;background:var(--green);border:none;border-radius:14px;color:#fff;font-size:15px;font-weight:600;cursor:pointer" onclick="endPeriod()">‚úÖ –ó–∞–∫–æ–Ω—á–∏–ª–∏—Å—å</button><button style="flex:1;padding:16px;background:var(--bg3);border:1px solid var(--border);border-radius:14px;color:var(--text);font-size:15px;font-weight:600;cursor:pointer" onclick="cancelPeriod()">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button></div>';
  }
  
  // –ò—Å—Ç–æ—Ä–∏—è
  let historyHtml = '';
  if (S.cyclePeriods.length > 0) {
    historyHtml = '<div style="margin-top:20px"><h4 style="font-size:15px;margin-bottom:12px">üìÖ –ò—Å—Ç–æ—Ä–∏—è</h4>';
    S.cyclePeriods.slice(0, 5).forEach((p, i) => {
      const dur = p.ended ? Math.floor((new Date(p.ended) - new Date(p.start)) / (24*60*60*1000)) + 1 : '...';
      historyHtml += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg3);border-radius:12px;margin-bottom:8px"><div><div style="font-size:14px">' + new Date(p.start).toLocaleDateString('ru') + '</div><div style="font-size:12px;color:var(--text2)">' + dur + ' –¥–Ω–µ–π</div></div><button style="background:none;border:none;color:var(--red);font-size:18px;cursor:pointer;padding:8px" onclick="deletePeriod(' + i + ')">üóëÔ∏è</button></div>';
    });
    historyHtml += '</div>';
  }
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
  const settingsHtml = '<div style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border)"><h4 style="font-size:15px;margin-bottom:14px">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h4><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px"><span style="font-size:14px;color:var(--text2)">–î–ª–∏–Ω–∞ —Ü–∏–∫–ª–∞ (–¥–Ω–µ–π)</span><input type="number" value="' + cycleLen + '" min="21" max="40" style="width:70px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:16px;text-align:center" onchange="updateCycleLen(this.value)"></div><div style="display:flex;justify-content:space-between;align-items:center"><span style="font-size:14px;color:var(--text2)">–î–ª–∏–Ω–∞ –º–µ—Å—è—á–Ω—ã—Ö (–¥–Ω–µ–π)</span><input type="number" value="' + periodLen + '" min="2" max="10" style="width:70px;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:16px;text-align:center" onchange="updatePeriodLen(this.value)"></div></div>';
  
  const phasesHtml = (info.phases || []).map(p => '<p><b>' + p.name + '</b> (–¥–Ω–∏ ' + p.days + '): ' + p.desc + '</p>').join('');
  const signsHtml = (info.signs || []).map(s => '<p>‚Ä¢ ' + s + '</p>').join('');
  
  document.getElementById('cycleC').innerHTML = statusHtml + '<div class="cycle-legend"><div class="cycle-leg"><div class="cycle-dot period"></div>–ú–µ—Å—è—á–Ω—ã–µ</div><div class="cycle-leg"><div class="cycle-dot fertile"></div>–§–µ—Ä—Ç–∏–ª—å–Ω—ã–µ</div><div class="cycle-leg"><div class="cycle-dot ovul"></div>–û–≤—É–ª—è—Ü–∏—è</div></div><div class="cal-h"><button class="cal-nav" onclick="chCycleM(-1)">‚Üê</button><div class="cal-m">' + months[cycleMonth] + ' ' + cycleYear + '</div><button class="cal-nav" onclick="chCycleM(1)">‚Üí</button></div><div class="cal-w">' + wd + '</div><div class="cal-days">' + dh + '</div>' + btnsHtml + historyHtml + settingsHtml + '<div class="cycle-info"><h4>üìö –§–∞–∑—ã —Ü–∏–∫–ª–∞</h4>' + phasesHtml + '<p style="margin-top:14px"><b>üéØ –§–µ—Ä—Ç–∏–ª—å–Ω—ã–µ –¥–Ω–∏:</b> ' + (info.fertileDays || '') + '</p><h4 style="margin-top:18px">üîç –ü—Ä–∏–∑–Ω–∞–∫–∏ –æ–≤—É–ª—è—Ü–∏–∏</h4>' + signsHtml + '</div>';
}

function chCycleM(d) { cycleMonth += d; if (cycleMonth > 11) { cycleMonth = 0; cycleYear++; } if (cycleMonth < 0) { cycleMonth = 11; cycleYear--; } renderCycle(); }
function startPeriod() { if (!S.cyclePeriods) S.cyclePeriods = []; S.cyclePeriods.unshift({ start: new Date().toISOString().split('T')[0], ended: null }); saveState(); renderCycle(); toast('üî¥ –ú–µ—Å—è—á–Ω—ã–µ –Ω–∞—á–∞–ª–∏—Å—å'); }
function endPeriod() { if (S.cyclePeriods && S.cyclePeriods[0]) { S.cyclePeriods[0].ended = new Date().toISOString().split('T')[0]; saveState(); renderCycle(); toast('‚úÖ –ú–µ—Å—è—á–Ω—ã–µ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å'); } }
function cancelPeriod() { if (S.cyclePeriods && S.cyclePeriods[0] && !S.cyclePeriods[0].ended) { S.cyclePeriods.shift(); saveState(); renderCycle(); toast('‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ'); } }
function deletePeriod(i) { if (S.cyclePeriods) { S.cyclePeriods.splice(i, 1); saveState(); renderCycle(); toast('üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ'); } }
function updateCycleLen(v) { if (!S.cycleSettings) S.cycleSettings = {}; S.cycleSettings.cycleLength = parseInt(v) || 28; saveState(); renderCycle(); }
function updatePeriodLen(v) { if (!S.cycleSettings) S.cycleSettings = {}; S.cycleSettings.periodLength = parseInt(v) || 5; saveState(); renderCycle(); }

// ===== HOT MODE =====
const hotTasks = [
  {time:30,task:'–°—Ç—Ä–∞—Å—Ç–Ω–æ –ø–æ—Ü–µ–ª—É–π—Ç–µ—Å—å',icon:'üíã'},
  {time:60,task:'–ú–∞—Å—Å–∞–∂ —à–µ–∏ –∏ –ø–ª–µ—á',icon:'üíÜ'},
  {time:45,task:'–®–µ–ø–Ω–∏—Ç–µ –Ω–∞ —É—Ö–æ —Ñ–∞–Ω—Ç–∞–∑–∏—é',icon:'üëÇ'},
  {time:30,task:'–£–∫—É—Å–∏—Ç–µ –Ω–µ–∂–Ω–æ –∑–∞ –≥—É–±—É',icon:'üòà'},
  {time:60,task:'–ü–æ–≥–ª–∞–¥—å—Ç–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å—Ç–æ—Ä–æ–Ω—É –±–µ–¥—Ä–∞',icon:'üî•'},
  {time:45,task:'–ü–æ—Ü–µ–ª—É–π—Ç–µ —à–µ—é 10 —Ä–∞–∑',icon:'üíï'},
  {time:30,task:'–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –¥—Ä—É–≥ –¥—Ä—É–≥—É –≤ –≥–ª–∞–∑–∞ –º–æ–ª—á–∞',icon:'üëÄ'},
  {time:60,task:'–ú–µ–¥–ª–µ–Ω–Ω–æ —Å–Ω–∏–º–∏—Ç–µ –æ–¥–∏–Ω –ø—Ä–µ–¥–º–µ—Ç –æ–¥–µ–∂–¥—ã',icon:'üëó'},
  {time:45,task:'–û–±–≤–µ–¥–∏—Ç–µ –ø–∞–ª—å—Ü–µ–º –∫–æ–Ω—Ç—É—Ä –≥—É–± –ø–∞—Ä—Ç–Ω—ë—Ä–∞',icon:'‚ú®'},
  {time:30,task:'–ü—Ä–æ—à–µ–ø—á–∏—Ç–µ "–Ø —Ç–µ–±—è —Ö–æ—á—É"',icon:'üî•'},
  {time:60,task:'–ú–∞—Å—Å–∞–∂ —Å—Ç—É–ø–Ω–µ–π',icon:'ü¶∂'},
  {time:45,task:'–ü–æ—Ü–µ–ª—É–π —Å –∑–∞–∫—Ä—ã—Ç—ã–º–∏ –≥–ª–∞–∑–∞–º–∏',icon:'üòò'},
  {time:30,task:'–õ—ë–≥–∫–∏–π —É–∫—É—Å –º–æ—á–∫–∏ —É—Ö–∞',icon:'üëÇ'},
  {time:60,task:'–ü–æ–≥–ª–∞–¥—å—Ç–µ —Å–ø–∏–Ω—É –ø–æ–¥ –æ–¥–µ–∂–¥–æ–π',icon:'ü§ö'},
  {time:45,task:'–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π –ø–æ—Ü–µ–ª—É–π 30 —Å–µ–∫—É–Ω–¥',icon:'üíã'},
  {time:30,task:'–°–∫–∞–∂–∏—Ç–µ 3 –≤–µ—â–∏ –∫–æ—Ç–æ—Ä—ã–µ –ª—é–±–∏—Ç–µ',icon:'‚ù§Ô∏è'},
  {time:60,task:'–û–±–Ω–∏–º–∏—Ç–µ —Å–∑–∞–¥–∏ –∏ —Ü–µ–ª—É–π—Ç–µ —à–µ—é',icon:'ü§ó'},
  {time:45,task:'–ù–∞—Ä–∏—Å—É–π—Ç–µ —Å–µ—Ä–¥—Ü–µ –Ω–∞ —Å–ø–∏–Ω–µ –ø–∞–ª—å—Ü–µ–º',icon:'üíù'},
  {time:30,task:'–ü–æ—Ü–µ–ª—É–π—Ç–µ –∫–ª—é—á–∏—Ü—É',icon:'üíã'},
  {time:60,task:'–¢–∞–Ω—Ü—É–π—Ç–µ –º–µ–¥–ª–µ–Ω–Ω–æ –æ–±–Ω—è–≤—à–∏—Å—å',icon:'üíÉ'}
];
let hotTimer = null, hotTime = 0, hotTaskIndex = 0;

function renderHotMode() {
  document.getElementById('hotModeC').innerHTML = `
    <div style="text-align:center;padding:20px 0">
      <div id="hotTimerDisplay" style="font-size:72px;font-weight:800;color:var(--accent);margin-bottom:16px">00:00</div>
      <div id="hotTaskDisplay" style="font-size:48px;margin-bottom:12px">üî•</div>
      <div id="hotTaskText" style="font-size:18px;font-weight:600;margin-bottom:24px;min-height:50px">–ù–∞–∂–º–∏—Ç–µ —Å—Ç–∞—Ä—Ç!</div>
      <div style="display:flex;gap:12px;justify-content:center;margin-bottom:24px">
        <button onclick="startHotMode()" style="padding:16px 32px;background:linear-gradient(135deg,#ef4444,#f97316);border:none;border-radius:14px;color:#fff;font-size:16px;font-weight:600;cursor:pointer">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
        <button onclick="nextHotTask()" style="padding:16px 32px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;color:var(--text);font-size:16px;font-weight:600;cursor:pointer">‚è≠Ô∏è –î–∞–ª—å—à–µ</button>
        <button onclick="stopHotMode()" style="padding:16px 32px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;color:var(--text);font-size:16px;font-weight:600;cursor:pointer">‚èπÔ∏è –°—Ç–æ–ø</button>
      </div>
      <div style="background:var(--bg2);border-radius:16px;padding:16px;text-align:left">
        <div style="font-size:14px;color:var(--accent);margin-bottom:8px">–ö–∞–∫ –∏–≥—Ä–∞—Ç—å:</div>
        <div style="font-size:13px;color:var(--text2)">1. –ù–∞–∂–º–∏—Ç–µ —Å—Ç–∞—Ä—Ç<br>2. –í—ã–ø–æ–ª–Ω—è–π—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ–∫–∞ –∏–¥—ë—Ç —Ç–∞–π–º–µ—Ä<br>3. –ö–æ–≥–¥–∞ —Ç–∞–π–º–µ—Ä –∑–∞–∫–æ–Ω—á–∏—Ç—Å—è ‚Äî —Å–ª–µ–¥—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ<br>4. –ü–æ–≤—Ç–æ—Ä—è–π—Ç–µ –ø–æ–∫–∞ –Ω–µ —Å—Ç–∞–Ω–µ—Ç —Å–ª–∏—à–∫–æ–º –≥–æ—Ä—è—á–æ üî•</div>
      </div>
    </div>
  `;
}

function startHotMode() {
  if (hotTimer) return;
  nextHotTask();
}

function nextHotTask() {
  if (hotTimer) clearInterval(hotTimer);
  const task = hotTasks[Math.floor(Math.random() * hotTasks.length)];
  hotTime = task.time;
  document.getElementById('hotTaskDisplay').textContent = task.icon;
  document.getElementById('hotTaskText').textContent = task.task;
  updateHotTimer();
  hotTimer = setInterval(() => {
    hotTime--;
    updateHotTimer();
    if (hotTime <= 0) {
      clearInterval(hotTimer);
      hotTimer = null;
      if (tg) tg.HapticFeedback?.notificationOccurred('success');
      setTimeout(nextHotTask, 1000);
    }
  }, 1000);
}

function updateHotTimer() {
  const m = Math.floor(hotTime / 60);
  const s = hotTime % 60;
  document.getElementById('hotTimerDisplay').textContent = String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
}

function stopHotMode() {
  if (hotTimer) { clearInterval(hotTimer); hotTimer = null; }
  document.getElementById('hotTimerDisplay').textContent = '00:00';
  document.getElementById('hotTaskDisplay').textContent = 'üî•';
  document.getElementById('hotTaskText').textContent = '–ù–∞–∂–º–∏—Ç–µ —Å—Ç–∞—Ä—Ç!';
}

// ===== WISHES =====
const allWishes = [
  'üíã –î–æ–ª–≥–∏–π —Å—Ç—Ä–∞—Å—Ç–Ω—ã–π –ø–æ—Ü–µ–ª—É–π','üõÅ –°–æ–≤–º–µ—Å—Ç–Ω–∞—è –≤–∞–Ω–Ω–∞','üíÜ –≠—Ä–æ—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Å—Å–∞–∂','üç´ –ö–æ—Ä–º–∏—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞','üëÄ –°—Ç—Ä–∏–ø—Ç–∏–∑','üé≠ –†–æ–ª–µ–≤–∞—è –∏–≥—Ä–∞','üìç –°–µ–∫—Å –≤ –Ω–æ–≤–æ–º –º–µ—Å—Ç–µ','üåô –¶–µ–ª—É—é –Ω–æ—á—å –≤–º–µ—Å—Ç–µ',
  'üëó –£–≤–∏–¥–µ—Ç—å –≤ —Å–µ–∫—Å—É–∞–ª—å–Ω–æ–º –±–µ–ª—å–µ','üé¨ –°–Ω—è—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –≤–∏–¥–µ–æ','üî• –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–æ–≤—É—é –ø–æ–∑—É','üëÖ –î–æ–ª–≥–∏–π –æ—Ä–∞–ª—å–Ω—ã–π —Å–µ–∫—Å','‚õìÔ∏è –õ—ë–≥–∫–æ–µ —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ','üëÄ –°–µ–∫—Å –ø—Ä–∏ —Å–≤–µ—Ç–µ','üöø –°–µ–∫—Å –≤ –¥—É—à–µ','üåÖ –°–µ–∫—Å –Ω–∞ —Ä–∞—Å—Å–≤–µ—Ç–µ',
  'üí¨ Dirty talk','üé≤ –°–µ–∫—Å-–∏–≥—Ä–∞','üç∑ –†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —É–∂–∏–Ω + —Å–µ–∫—Å','üè® –ù–æ—á—å –≤ –æ—Ç–µ–ª–µ','üí¶ –°–æ–≤–º–µ—Å—Ç–Ω—ã–π –æ—Ä–≥–∞–∑–º','üîô –ê–Ω–∞–ª—å–Ω—ã–µ –ª–∞—Å–∫–∏','üéÅ –°—é—Ä–ø—Ä–∏–∑ –≤ –ø–æ—Å—Ç–µ–ª–∏','üì± –°–µ–∫—Å—Ç–∏–Ω–≥ –≤–µ—Å—å –¥–µ–Ω—å'
];

async function renderWishes() {
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
  let serverWishes = { user1: [], user2: [], matches: [] };
  if (currentUser?.coupleId) {
    try {
      const r = await fetch(API + '/couple/' + currentUser.coupleId + '/wishes');
      serverWishes = await r.json();
    } catch(e) {}
  }
  
  const couple = data.couples?.[currentUser?.coupleId];
  const isUser1 = currentUser?.id === couple?.user1;
  const myWishes = isUser1 ? serverWishes.user1 : serverWishes.user2;
  const matches = serverWishes.matches || [];
  
  let matchedHtml = '';
  if (matches.length > 0) {
    matchedHtml = '<div style="background:linear-gradient(135deg,rgba(34,197,94,.2),rgba(16,185,129,.2));border:1px solid rgba(34,197,94,.3);border-radius:16px;padding:16px;margin-bottom:20px"><div style="font-size:16px;font-weight:700;color:var(--green);margin-bottom:12px">üéâ –°–æ–≤–ø–∞–¥–µ–Ω–∏—è!</div>' + 
      matches.map(w => '<div style="padding:10px;background:rgba(255,255,255,.05);border-radius:10px;margin-bottom:8px;font-size:14px">' + w + '</div>').join('') + '</div>';
  }
  
  const myWishesHtml = allWishes.map(w => {
    const selected = myWishes.includes(w);
    return '<div onclick="toggleWish(\'' + w.replace(/'/g, "\\'") + '\')" style="padding:14px;background:' + (selected ? 'var(--accent)' : 'var(--bg2)') + ';border:1px solid ' + (selected ? 'var(--accent)' : 'var(--border)') + ';border-radius:12px;margin-bottom:10px;cursor:pointer;font-size:14px;display:flex;align-items:center;gap:10px"><span style="font-size:20px">' + (selected ? '‚úÖ' : '‚¨ú') + '</span>' + w + '</div>';
  }).join('');
  
  document.getElementById('wishesC').innerHTML = matchedHtml + `
    <div style="background:var(--bg2);border-radius:16px;padding:16px;margin-bottom:20px">
      <div style="font-size:14px;color:var(--accent);margin-bottom:8px">üîí –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</div>
      <div style="font-size:13px;color:var(--text2)">–í—ã–±–µ—Ä–∏—Ç–µ –∂–µ–ª–∞–Ω–∏—è –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–µ–ª–∏ –±—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å. –ü–∞—Ä—Ç–Ω—ë—Ä –Ω–µ –≤–∏–¥–∏—Ç –≤–∞—à –≤—ã–±–æ—Ä! –ö–æ–≥–¥–∞ –æ–±–∞ –≤—ã–±–µ—Ä—É—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ ‚Äî –æ–Ω–æ –ø–æ—è–≤–∏—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "–°–æ–≤–ø–∞–¥–µ–Ω–∏—è" ‚ú®</div>
    </div>
    <div style="font-size:16px;font-weight:700;margin-bottom:14px">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–∏ –∂–µ–ª–∞–Ω–∏—è:</div>
    ${myWishesHtml}
  `;
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º myWishes –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è toggleWish
  window.currentMyWishes = myWishes;
}

async function toggleWish(w) {
  if (!currentUser?.coupleId) { toast('–°–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã'); return; }
  
  let wishes = window.currentMyWishes || [];
  const idx = wishes.indexOf(w);
  if (idx >= 0) wishes.splice(idx, 1);
  else wishes.push(w);
  
  try {
    await fetch(API + '/couple/' + currentUser.coupleId + '/wishes', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ odUserId: userId, wishes })
    });
    renderWishes();
  } catch(e) { toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); }
}

// ===== CHALLENGES =====
const challenges = [
  {title:'–ù–µ–¥–µ–ª—è –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–æ–≤',desc:'–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≥–æ–≤–æ—Ä–∏—Ç–µ 3 –∏—Å–∫—Ä–µ–Ω–Ω–∏—Ö –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–∞',days:7,icon:'üí¨'},
  {title:'–ë–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤',desc:'–û–¥–∏–Ω –≤–µ—á–µ—Ä –±–µ–∑ –≥–∞–¥–∂–µ—Ç–æ–≤ ‚Äî —Ç–æ–ª—å–∫–æ –≤—ã –¥–≤–æ–µ',days:1,icon:'üìµ'},
  {title:'–ù–æ–≤—ã–µ –º–µ—Å—Ç–∞',desc:'–ö–∞–∂–¥—ã–π –¥–µ–Ω—å —Ü–µ–ª—É–π—Ç–µ—Å—å –≤ –Ω–æ–≤–æ–º –º–µ—Å—Ç–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã',days:5,icon:'üíã'},
  {title:'–ú–∞—Å—Å–∞–∂ –º–∞—Ä–∞—Ñ–æ–Ω',desc:'–ß–µ—Ä–µ–¥—É–π—Ç–µ—Å—å –¥–µ–ª–∞—è –¥—Ä—É–≥ –¥—Ä—É–≥—É –º–∞—Å—Å–∞–∂ –∫–∞–∂–¥—ã–π –≤–µ—á–µ—Ä',days:7,icon:'üíÜ'},
  {title:'–ó–∞–ø–∏—Å–∫–∏ –ª—é–±–≤–∏',desc:'–û—Å—Ç–∞–≤–ª—è–π—Ç–µ –∑–∞–ø–∏—Å–∫–∏ —Å –ø—Ä–∏–∑–Ω–∞–Ω–∏—è–º–∏ –≤ –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö',days:7,icon:'üíå'},
  {title:'–ó–∞–≤—Ç—Ä–∞–∫ –≤ –ø–æ—Å—Ç–µ–ª—å',desc:'–ü–æ –æ—á–µ—Ä–µ–¥–∏ –≥–æ—Ç–æ–≤—å—Ç–µ –∑–∞–≤—Ç—Ä–∞–∫ –≤ –ø–æ—Å—Ç–µ–ª—å',days:2,icon:'üç≥'},
  {title:'–¢–∞–Ω—Ü—ã –¥–æ–º–∞',desc:'–ö–∞–∂–¥—ã–π –≤–µ—á–µ—Ä –æ–¥–∏–Ω –º–µ–¥–ª–µ–Ω–Ω—ã–π —Ç–∞–Ω–µ—Ü –≤–º–µ—Å—Ç–µ',days:7,icon:'üíÉ'},
  {title:'–ù–æ–≤–∞—è –ø–æ–∑–∞',desc:'–ü–æ–ø—Ä–æ–±—É–π—Ç–µ 3 –Ω–æ–≤—ã–µ –ø–æ–∑—ã –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è',days:7,icon:'üî•'},
  {title:'–§–æ—Ç–æ –¥–Ω—è',desc:'–î–µ–ª–∞–π—Ç–µ —Å–æ–≤–º–µ—Å—Ç–Ω–æ–µ —Ñ–æ—Ç–æ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å',days:7,icon:'üì∏'},
  {title:'–ë–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å',desc:'–ö–∞–∂–¥—ã–π –≤–µ—á–µ—Ä –≥–æ–≤–æ—Ä–∏—Ç–µ –∑–∞ —á—Ç–æ –±–ª–∞–≥–æ–¥–∞—Ä–Ω—ã –ø–∞—Ä—Ç–Ω—ë—Ä—É',days:7,icon:'üôè'}
];

function renderChallenges() {
  if (!S.challenges) S.challenges = { active: null, completed: [] };
  
  let activeHtml = '';
  if (S.challenges.active) {
    const ch = S.challenges.active;
    const daysPassed = Math.floor((new Date() - new Date(ch.started)) / (24*60*60*1000)) + 1;
    const progress = Math.min(100, (daysPassed / ch.days) * 100);
    activeHtml = `
      <div style="background:linear-gradient(135deg,rgba(6,182,212,.2),rgba(34,211,238,.2));border:1px solid rgba(6,182,212,.3);border-radius:18px;padding:20px;margin-bottom:20px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <div style="font-size:32px">${ch.icon}</div>
          <div style="font-size:13px;color:var(--text2)">–î–µ–Ω—å ${daysPassed} –∏–∑ ${ch.days}</div>
        </div>
        <div style="font-size:18px;font-weight:700;margin-bottom:6px">${ch.title}</div>
        <div style="font-size:14px;color:var(--text2);margin-bottom:14px">${ch.desc}</div>
        <div style="height:8px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden">
          <div style="height:100%;width:${progress}%;background:var(--green);border-radius:4px"></div>
        </div>
        <button onclick="completeChallenge()" style="width:100%;padding:14px;background:var(--green);border:none;border-radius:12px;color:#fff;font-size:15px;font-weight:600;cursor:pointer;margin-top:14px">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂</button>
      </div>
    `;
  }
  
  const listHtml = challenges.map((ch, i) => {
    const done = S.challenges.completed.includes(ch.title);
    return `<div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px;opacity:${done ? '0.5' : '1'}">
      <div style="display:flex;gap:14px;align-items:center">
        <div style="font-size:32px">${ch.icon}</div>
        <div style="flex:1">
          <div style="font-size:16px;font-weight:700">${ch.title} ${done ? '‚úÖ' : ''}</div>
          <div style="font-size:13px;color:var(--text2);margin-top:4px">${ch.desc}</div>
          <div style="font-size:12px;color:var(--muted);margin-top:4px">${ch.days} –¥–Ω–µ–π</div>
        </div>
        ${!done && !S.challenges.active ? `<button onclick="startChallenge(${i})" style="padding:10px 16px;background:var(--accent);border:none;border-radius:10px;color:#fff;font-size:13px;font-weight:600;cursor:pointer">–ù–∞—á–∞—Ç—å</button>` : ''}
      </div>
    </div>`;
  }).join('');
  
  document.getElementById('challengesC').innerHTML = activeHtml + '<div style="font-size:16px;font-weight:700;margin-bottom:14px">–î–æ—Å—Ç—É–ø–Ω—ã–µ —á–µ–ª–ª–µ–Ω–¥–∂–∏:</div>' + listHtml;
}

function startChallenge(i) {
  const ch = challenges[i];
  S.challenges.active = { ...ch, started: new Date().toISOString() };
  saveState();
  renderChallenges();
  toast('üéØ –ß–µ–ª–ª–µ–Ω–¥–∂ –Ω–∞—á–∞—Ç!');
}

function completeChallenge() {
  if (S.challenges.active) {
    S.challenges.completed.push(S.challenges.active.title);
    S.challenges.active = null;
    saveState();
    renderChallenges();
    toast('üéâ –ß–µ–ª–ª–µ–Ω–¥–∂ –∑–∞–≤–µ—Ä—à—ë–Ω!');
    checkAchievements();
  }
}

// ===== CONFESSIONS =====
function renderConfess() {
  if (!S.confessions) S.confessions = { sent: [], received: [] };
  
  const receivedHtml = S.confessions.received.length > 0 ? 
    '<div style="margin-bottom:20px"><div style="font-size:16px;font-weight:700;margin-bottom:12px">üì¨ –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ:</div>' +
    S.confessions.received.map(c => `<div style="background:linear-gradient(135deg,rgba(244,114,182,.1),rgba(251,113,133,.1));border:1px solid rgba(244,114,182,.2);border-radius:14px;padding:16px;margin-bottom:10px">
      <div style="font-size:14px;line-height:1.6">${c.text}</div>
      <div style="font-size:12px;color:var(--muted);margin-top:8px">${new Date(c.date).toLocaleDateString('ru')}</div>
    </div>`).join('') + '</div>' : '';
  
  document.getElementById('confessC').innerHTML = receivedHtml + `
    <div style="background:var(--bg2);border-radius:16px;padding:16px;margin-bottom:20px">
      <div style="font-size:14px;color:var(--accent);margin-bottom:8px">üíù –ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ:</div>
      <textarea id="confessText" style="width:100%;padding:14px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:15px;resize:none" rows="4" placeholder="–Ø —Ö–æ—á—É –ø—Ä–∏–∑–Ω–∞—Ç—å—Å—è, —á—Ç–æ..."></textarea>
      <button onclick="sendConfess()" style="width:100%;padding:14px;background:var(--accent);border:none;border-radius:12px;color:#fff;font-size:15px;font-weight:600;cursor:pointer;margin-top:12px">üíå –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω–∏–º–Ω–æ</button>
    </div>
    <div style="font-size:13px;color:var(--text2);text-align:center">–ü–∞—Ä—Ç–Ω—ë—Ä –ø–æ–ª—É—á–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –Ω–æ –Ω–µ —É–∑–Ω–∞–µ—Ç —á—Ç–æ —ç—Ç–æ –æ—Ç –≤–∞—Å üòâ</div>
  `;
}

function sendConfess() {
  const text = document.getElementById('confessText').value.trim();
  if (!text) { toast('–ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ'); return; }
  if (!partner) { toast('–°–Ω–∞—á–∞–ª–∞ —Å–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç'); return; }
  S.confessions.sent.push({ text, date: new Date().toISOString() });
  // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –±—ã –ø–∞—Ä—Ç–Ω—ë—Ä—É —á–µ—Ä–µ–∑ API
  saveState();
  document.getElementById('confessText').value = '';
  toast('üíå –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
}

// ===== ACHIEVEMENTS =====
const achievements = [
  {id:'first_q',title:'–ü–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å',desc:'–û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å',icon:'üí¨',check:() => Object.values(S.progress || {}).some(v => v > 0)},
  {id:'level1',title:'–£—Ä–æ–≤–µ–Ω—å 1',desc:'–ü—Ä–æ–π–¥–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å "–ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ"',icon:'üå±',check:() => (S.progress || {})[1] >= 33},
  {id:'all_levels',title:'–ú–∞—Å—Ç–µ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤',desc:'–ü—Ä–æ–π–¥–∏—Ç–µ –≤—Å–µ 6 —É—Ä–æ–≤–Ω–µ–π',icon:'üèÜ',check:() => [1,2,3,4,5,6].every(l => (S.progress || {})[l] >= 33)},
  {id:'first_cal',title:'–ü–µ—Ä–≤–∞—è –∑–∞–ø–∏—Å—å',desc:'–°–¥–µ–ª–∞–π—Ç–µ –∑–∞–ø–∏—Å—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ',icon:'üìÖ',check:() => (S.calendar || []).length > 0},
  {id:'week_cal',title:'–ù–µ–¥–µ–ª—è –ª—é–±–≤–∏',desc:'7 –∑–∞–ø–∏—Å–µ–π –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ',icon:'‚ù§Ô∏è',check:() => (S.calendar || []).length >= 7},
  {id:'first_test',title:'–ü–µ—Ä–≤—ã–π —Ç–µ—Å—Ç',desc:'–ü—Ä–æ–π–¥–∏—Ç–µ –ª—é–±–æ–π —Ç–µ—Å—Ç',icon:'üìù',check:() => (S.testsDone || 0) > 0},
  {id:'all_tests',title:'–ó–Ω–∞—Ç–æ–∫',desc:'–ü—Ä–æ–π–¥–∏—Ç–µ –≤—Å–µ 10 —Ç–µ—Å—Ç–æ–≤',icon:'üéì',check:() => (S.testsDone || 0) >= 10},
  {id:'challenge1',title:'–ß–µ–ª–ª–µ–Ω–¥–∂–µ—Ä',desc:'–ó–∞–≤–µ—Ä—à–∏—Ç–µ –ø–µ—Ä–≤—ã–π —á–µ–ª–ª–µ–Ω–¥–∂',icon:'üéØ',check:() => (S.challenges?.completed || []).length > 0},
  {id:'challenge5',title:'–ú–∞—Å—Ç–µ—Ä —á–µ–ª–ª–µ–Ω–¥–∂–µ–π',desc:'–ó–∞–≤–µ—Ä—à–∏—Ç–µ 5 —á–µ–ª–ª–µ–Ω–¥–∂–µ–π',icon:'‚≠ê',check:() => (S.challenges?.completed || []).length >= 5},
  {id:'confess',title:'–†–æ–º–∞–Ω—Ç–∏–∫',desc:'–û—Ç–ø—Ä–∞–≤—å—Ç–µ –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ',icon:'üíå',check:() => (S.confessions?.sent || []).length > 0},
  {id:'partner',title:'–í–º–µ—Å—Ç–µ',desc:'–°–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç —Å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º',icon:'üíë',check:() => !!partner},
  {id:'month',title:'–ú–µ—Å—è—Ü –≤–º–µ—Å—Ç–µ',desc:'–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ 30 –¥–Ω–µ–π',icon:'üìÜ',check:() => S.daysUsed >= 30},
];

function renderAchievements() {
  checkAchievements();
  if (!S.achievements) S.achievements = [];
  
  const html = achievements.map(a => {
    const unlocked = S.achievements.includes(a.id);
    return `<div style="background:var(--bg2);border:1px solid ${unlocked ? 'var(--yellow)' : 'var(--border)'};border-radius:16px;padding:16px;margin-bottom:12px;opacity:${unlocked ? '1' : '0.5'}">
      <div style="display:flex;gap:14px;align-items:center">
        <div style="font-size:36px;filter:${unlocked ? 'none' : 'grayscale(1)'}">${a.icon}</div>
        <div style="flex:1">
          <div style="font-size:16px;font-weight:700">${a.title} ${unlocked ? '‚úÖ' : 'üîí'}</div>
          <div style="font-size:13px;color:var(--text2);margin-top:4px">${a.desc}</div>
        </div>
      </div>
    </div>`;
  }).join('');
  
  const count = S.achievements.length;
  document.getElementById('achieveC').innerHTML = `
    <div style="text-align:center;margin-bottom:20px">
      <div style="font-size:48px;font-weight:800;color:var(--yellow)">${count}</div>
      <div style="font-size:14px;color:var(--text2)">–∏–∑ ${achievements.length} –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div>
    </div>
  ` + html;
  
  document.getElementById('achieveCount').textContent = count + ' –∏–∑ ' + achievements.length;
}

function checkAchievements() {
  if (!S.achievements) S.achievements = [];
  let newUnlock = false;
  achievements.forEach(a => {
    if (!S.achievements.includes(a.id) && a.check()) {
      S.achievements.push(a.id);
      newUnlock = true;
    }
  });
  if (newUnlock) saveState();
}

// ===== STATS =====
function renderStats() {
  const qAnswered = Object.values(S.progress || {}).reduce((a, b) => a + b, 0);
  const calEntries = (S.calendar || []).length;
  const daysUsed = S.daysUsed || 1;
  const challenges = (S.challenges?.completed || []).length;
  
  document.getElementById('statsC').innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px">
      <div style="background:var(--bg2);border-radius:16px;padding:20px;text-align:center">
        <div style="font-size:36px;font-weight:800;color:var(--accent)">${qAnswered}</div>
        <div style="font-size:13px;color:var(--text2)">–í–æ–ø—Ä–æ—Å–æ–≤</div>
      </div>
      <div style="background:var(--bg2);border-radius:16px;padding:20px;text-align:center">
        <div style="font-size:36px;font-weight:800;color:var(--green)">${calEntries}</div>
        <div style="font-size:13px;color:var(--text2)">–ó–∞–ø–∏—Å–µ–π</div>
      </div>
      <div style="background:var(--bg2);border-radius:16px;padding:20px;text-align:center">
        <div style="font-size:36px;font-weight:800;color:var(--yellow)">${daysUsed}</div>
        <div style="font-size:13px;color:var(--text2)">–î–Ω–µ–π</div>
      </div>
      <div style="background:var(--bg2);border-radius:16px;padding:20px;text-align:center">
        <div style="font-size:36px;font-weight:800;color:var(--blue)">${challenges}</div>
        <div style="font-size:13px;color:var(--text2)">–ß–µ–ª–ª–µ–Ω–¥–∂–µ–π</div>
      </div>
    </div>
    <div style="background:var(--bg2);border-radius:16px;padding:20px">
      <div style="font-size:16px;font-weight:700;margin-bottom:14px">üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —É—Ä–æ–≤–Ω—è–º</div>
      ${[1,2,3,4,5,6].map(l => {
        const p = (S.progress || {})[l] || 0;
        const max = 33;
        const pct = Math.round((p / max) * 100);
        const colors = ['#10b981','#3b82f6','#f59e0b','#ec4899','#ef4444','#991b1b'];
        return `<div style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:4px"><span>–£—Ä–æ–≤–µ–Ω—å ${l}</span><span>${pct}%</span></div>
          <div style="height:8px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden">
            <div style="height:100%;width:${pct}%;background:${colors[l-1]};border-radius:4px"></div>
          </div>
        </div>`;
      }).join('')}
    </div>
  `;
}

// ===== INIT NEW SCREENS =====
function initNewScreens() {
  renderHotMode();
  renderWishes();
  renderChallenges();
  renderConfess();
  renderAchievements();
  renderStats();
  
  // Track days used
  if (!S.firstUse) S.firstUse = new Date().toISOString();
  S.daysUsed = Math.floor((new Date() - new Date(S.firstUse)) / (24*60*60*1000)) + 1;
  saveState();
}

// ===== CHAT =====
let chatMessages = [];
async function loadChat() {
  if (!currentUser?.coupleId) { document.getElementById('chatC').innerHTML = '<p style="color:var(--text2);text-align:center;padding:40px">–°–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã –¥–ª—è —á–∞—Ç–∞</p>'; return; }
  try { const r = await fetch(API + '/couple/' + currentUser.coupleId + '/chat'); chatMessages = await r.json(); } catch(e) { chatMessages = S.chat || []; }
  renderChat();
}
function renderChat() {
  if (!chatMessages.length) { document.getElementById('chatC').innerHTML = '<p style="color:var(--text2);text-align:center;padding:40px">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ! üíï</p>'; return; }
  document.getElementById('chatC').innerHTML = chatMessages.map(m => {
    const mine = m.from === userId;
    return '<div style="display:flex;justify-content:'+(mine?'flex-end':'flex-start')+';margin-bottom:10px"><div class="msg-bubble '+(mine?'sent':'received')+'">'+m.message+'<div class="msg-time">'+new Date(m.time).toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'})+'</div></div></div>';
  }).join('');
}
async function sendChat() {
  const input = document.getElementById('chatInput');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  chatMessages.push({ id: Date.now(), from: userId, message: msg, time: new Date().toISOString() });
  renderChat();
  if (currentUser?.coupleId) { try { await fetch(API + '/couple/' + currentUser.coupleId + '/chat', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ from: userId, message: msg }) }); } catch(e) { console.log(e); } }
  toast('‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
}

// ===== DIARY =====
let diaryEntries = [];
async function renderDiary() {
  if (currentUser?.coupleId) { try { const r = await fetch(API + '/couple/' + currentUser.coupleId + '/diary'); diaryEntries = await r.json(); } catch(e) { diaryEntries = S.diary || []; } } else { diaryEntries = S.diary || []; }
  if (!diaryEntries.length) { document.getElementById('diaryC').innerHTML = '<p style="color:var(--text2);text-align:center;padding:40px">–ù–∞—á–Ω–∏—Ç–µ –≤–µ—Å—Ç–∏ –¥–Ω–µ–≤–Ω–∏–∫ üìñ</p>'; return; }
  document.getElementById('diaryC').innerHTML = diaryEntries.map(d => '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px"><div style="display:flex;justify-content:space-between;margin-bottom:8px"><div style="font-size:18px">'+(d.mood||'üìù')+'</div><div style="font-size:12px;color:var(--text2)">'+new Date(d.date).toLocaleDateString('ru')+'</div></div><div style="font-size:16px;font-weight:600;margin-bottom:6px">'+d.title+'</div><div style="font-size:14px;color:var(--text2)">'+(d.content||'')+'</div></div>').join('');
}
let diaryMood = 'üòç';
function openDiaryModal() {
  document.body.insertAdjacentHTML('beforeend', '<div style="position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:300;display:flex;align-items:center;justify-content:center;padding:16px" id="diaryModal" onclick="if(event.target.id===\'diaryModal\')this.remove()"><div style="background:var(--bg2);border-radius:20px;padding:24px;width:100%;max-width:400px"><h3 style="font-size:20px;margin-bottom:16px">üìñ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h3><input type="text" id="diaryTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" style="width:100%;padding:14px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:15px;margin-bottom:12px"><textarea id="diaryContent" placeholder="–ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ?" rows="4" style="width:100%;padding:14px;background:var(--bg);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:15px;resize:none;margin-bottom:12px"></textarea><div style="display:flex;gap:10px;justify-content:center;margin-bottom:16px" id="diaryMoodBtns"><span onclick="diaryMood=\'üòç\'" style="font-size:28px;cursor:pointer">üòç</span><span onclick="diaryMood=\'ü•∞\'" style="font-size:28px;cursor:pointer">ü•∞</span><span onclick="diaryMood=\'üòä\'" style="font-size:28px;cursor:pointer">üòä</span><span onclick="diaryMood=\'üî•\'" style="font-size:28px;cursor:pointer">üî•</span><span onclick="diaryMood=\'üíï\'" style="font-size:28px;cursor:pointer">üíï</span></div><button onclick="saveDiary()" style="width:100%;padding:16px;background:var(--accent);border:none;border-radius:14px;color:#fff;font-size:16px;font-weight:600;cursor:pointer">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div>');
}
async function saveDiary() {
  const title = document.getElementById('diaryTitle').value.trim();
  const content = document.getElementById('diaryContent').value.trim();
  if (!title) { toast('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫'); return; }
  if (currentUser?.coupleId) { try { await fetch(API + '/couple/' + currentUser.coupleId + '/diary', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ title, content, mood: diaryMood, author: userId }) }); } catch(e) {} }
  if (!S.diary) S.diary = [];
  S.diary.unshift({ id: Date.now(), title, content, mood: diaryMood, date: new Date().toISOString() }); saveState();
  document.getElementById('diaryModal').remove();
  renderDiary();
  toast('üìñ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞');
}

// ===== MOOD =====
let moodData = [];
async function renderMood() {
  if (currentUser?.coupleId) { try { const r = await fetch(API + '/couple/' + currentUser.coupleId + '/mood'); moodData = await r.json(); } catch(e) { moodData = []; } } else { moodData = S.moodHistory || []; }
  const today = new Date().toISOString().split('T')[0];
  const myToday = moodData.find(m => m.userId === userId && m.date?.startsWith(today));
  const partnerToday = partner ? moodData.find(m => m.userId === partner.id && m.date?.startsWith(today)) : null;
  let html = '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px;text-align:center"><h3 style="font-size:16px;margin-bottom:16px">–ö–∞–∫ —Ç—ã —Å–µ–≥–æ–¥–Ω—è?</h3><div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap" id="moodSelect">';
  ['üòç','ü•∞','üòä','üòê','üòî','üò¢','üî•','üò¥'].forEach(m => { html += '<span onclick="setMood(\''+m+'\')" style="font-size:36px;cursor:pointer;padding:8px;border-radius:12px;background:'+(myToday?.mood===m?'var(--accent)':'transparent')+'">'+m+'</span>'; });
  html += '</div></div>';
  if (myToday || partnerToday) {
    html += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:20px"><h3 style="font-size:16px;margin-bottom:12px">–°–µ–≥–æ–¥–Ω—è</h3>';
    if (myToday) html += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:8px"><span style="font-size:28px">'+myToday.mood+'</span><span>–í—ã</span></div>';
    if (partnerToday) html += '<div style="display:flex;align-items:center;gap:12px"><span style="font-size:28px">'+partnerToday.mood+'</span><span>–ü–∞—Ä—Ç–Ω—ë—Ä</span></div>';
    html += '</div>';
  }
  document.getElementById('moodC').innerHTML = html;
}
async function setMood(mood) {
  if (currentUser?.coupleId) { try { await fetch(API + '/couple/' + currentUser.coupleId + '/mood', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ odUserId: userId, mood: mood }) }); } catch(e) {} }
  if (!S.moodHistory) S.moodHistory = [];
  S.moodHistory = S.moodHistory.filter(m => !(m.odUserId === userId && m.date?.startsWith(new Date().toISOString().split('T')[0])));
  S.moodHistory.unshift({ odUserId: userId, mood, date: new Date().toISOString() }); saveState();
  renderMood();
  toast('üòä –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
}

// ===== DATE IDEA =====
const dateIdeas = {home:['–ú–∞—Ä–∞—Ñ–æ–Ω —Ñ–∏–ª—å–º–æ–≤ üé¨','–°–æ–≤–º–µ—Å—Ç–Ω–∞—è –≥–æ—Ç–æ–≤–∫–∞ üë®‚Äçüç≥','–ù–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã üé≤','–°–ø–∞ –≤–µ—á–µ—Ä üíÜ','–ö–∞—Ä–∞–æ–∫–µ üé§','–¢–∞–Ω—Ü—ã –≤ –≥–æ—Å—Ç–∏–Ω–æ–π üíÉ','–§–æ—Ä—Ç –∏–∑ –æ–¥–µ—è–ª üè∞','–î–µ–≥—É—Å—Ç–∞—Ü–∏—è –≤–∏–Ω–∞ üç∑','–ô–æ–≥–∞ –≤–¥–≤–æ—ë–º üßò','–†–∏—Å–æ–≤–∞–Ω–∏–µ üé®'],outside:['–ü–∏–∫–Ω–∏–∫ üß∫','–ü—Ä–æ–≥—É–ª–∫–∞ –Ω–∞ –∑–∞–∫–∞—Ç–µ üåÖ','–ë–æ—É–ª–∏–Ω–≥ üé≥','–ö–∏–Ω–æ üé•','–†–µ—Å—Ç–æ—Ä–∞–Ω üçΩÔ∏è','–ú—É–∑–µ–π üèõÔ∏è','–ö–æ–Ω—Ü–µ—Ä—Ç üéµ','–ö–∞—Ç–æ–∫ ‚õ∏Ô∏è','–ö–≤–µ—Å—Ç-–∫–æ–º–Ω–∞—Ç–∞ üîê','–ú–∏–Ω–∏-–≥–æ–ª—å—Ñ ‚õ≥'],adventure:['–ü–æ—Ö–æ–¥ ü•æ','–í–µ–ª–æ–ø—Ä–æ–≥—É–ª–∫–∞ üö¥','–°–∫–∞–ª–æ–¥—Ä–æ–º üßó','–ö–∞—Ä—Ç–∏–Ω–≥ üèéÔ∏è','–ê–∫–≤–∞–ø–∞—Ä–∫ üèä','–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å üë®‚Äçüè´','Escape room üö™','–°–ø–æ–Ω—Ç–∞–Ω–Ω–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ üó∫Ô∏è'],romantic:['–£–∂–∏–Ω –ø—Ä–∏ —Å–≤–µ—á–∞—Ö üïØÔ∏è','–ú–∞—Å—Å–∞–∂ üíÜ','–ó–≤—ë–∑–¥—ã –Ω–∞ –∫—Ä—ã—à–µ ‚≠ê','–ù–∞–ø–∏—Å–∞—Ç—å –ø–∏—Å—å–º–∞ üíå','–ê–ª—å–±–æ–º –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π üì∏','–¢–∞–Ω–µ—Ü üíë','–ó–∞–≤—Ç—Ä–∞–∫ –≤ –ø–æ—Å—Ç–µ–ª—å ü•ê','–í–∞–Ω–Ω–∞ —Å –ø–µ–Ω–æ–π üõÅ']};
let currentDateIdea = '';
function renderDateIdea() {
  let html = '<div style="text-align:center;padding:20px"><div style="font-size:80px;margin-bottom:20px">üé≤</div>';
  html += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:24px;margin-bottom:20px;min-height:100px;display:flex;align-items:center;justify-content:center"><div style="font-size:20px;font-weight:600" id="dateIdeaText">'+(currentDateIdea||'–ù–∞–∂–º–∏—Ç–µ –∫—Ä—É—Ç–∏—Ç—å!')+'</div></div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px">';
  html += '<button onclick="spinDate(\'home\')" style="padding:14px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;color:var(--text);font-size:14px;cursor:pointer">üè† –î–æ–º–∞</button>';
  html += '<button onclick="spinDate(\'outside\')" style="padding:14px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;color:var(--text);font-size:14px;cursor:pointer">üåÜ –ù–∞ —É–ª–∏—Ü–µ</button>';
  html += '<button onclick="spinDate(\'adventure\')" style="padding:14px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;color:var(--text);font-size:14px;cursor:pointer">üé¢ –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ</button>';
  html += '<button onclick="spinDate(\'romantic\')" style="padding:14px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;color:var(--text);font-size:14px;cursor:pointer">üíï –†–æ–º–∞–Ω—Ç–∏–∫–∞</button>';
  html += '</div>';
  html += '<button onclick="spinDate()" style="width:100%;padding:18px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:16px;color:#fff;font-size:18px;font-weight:700;cursor:pointer">üé∞ –ö—Ä—É—Ç–∏—Ç—å!</button></div>';
  document.getElementById('dateIdeaC').innerHTML = html;
}
function spinDate(cat) {
  const cats = Object.keys(dateIdeas);
  const c = cat || cats[Math.floor(Math.random() * cats.length)];
  const ideas = dateIdeas[c];
  const idea = ideas[Math.floor(Math.random() * ideas.length)];
  currentDateIdea = idea;
  document.getElementById('dateIdeaText').innerHTML = idea;
  toast('üé≤ ' + idea);
}

// ===== COMPLIMENT =====
const compliments = ["–¢—ã –¥–µ–ª–∞–µ—à—å –º–µ–Ω—è —Å—á–∞—Å—Ç–ª–∏–≤–µ–µ üíï","–¢–≤–æ—è —É–ª—ã–±–∫–∞ ‚Äî –º–æ—ë –ª—é–±–∏–º–æ–µ üòä","–¢—ã —Å–∞–º—ã–π –∫—Ä–∞—Å–∏–≤—ã–π —á–µ–ª–æ–≤–µ–∫ ‚ú®","–ú–Ω–µ –ø–æ–≤–µ–∑–ª–æ –±—ã—Ç—å —Å —Ç–æ–±–æ–π üçÄ","–¢—ã –∑–∞—Å—Ç–∞–≤–ª—è–µ—à—å —Å–µ—Ä–¥—Ü–µ –±–∏—Ç—å—Å—è –±—ã—Å—Ç—Ä–µ–µ üíì","–õ—é–±–ª—é –ø—Ä–æ—Å—ã–ø–∞—Ç—å—Å—è —Ä—è–¥–æ–º ‚òÄÔ∏è","–¢—ã –º–æ–π –ª—É—á—à–∏–π –¥—Ä—É–≥ –∏ –ª—é–±–æ–≤—å üíë","–ö–∞–∂–¥—ã–π –º–æ–º–µ–Ω—Ç —Å —Ç–æ–±–æ–π ‚Äî –ø–æ–¥–∞—Ä–æ–∫ üéÅ","–¢—ã –¥–µ–ª–∞–µ—à—å –¥–Ω–∏ –æ—Å–æ–±–µ–Ω–Ω—ã–º–∏ ‚≠ê","–ì–æ—Ä–∂—É—Å—å —Ç–æ–±–æ–π üèÜ","–¢–≤–æ–∏ –æ–±—ä—è—Ç–∏—è ‚Äî –ª—É—á—à–µ–µ –º–µ—Å—Ç–æ ü§ó","–¢—ã –ø–æ–Ω–∏–º–∞–µ—à—å –º–µ–Ω—è –∫–∞–∫ –Ω–∏–∫—Ç–æ üí≠","–° —Ç–æ–±–æ–π —è –º–æ–≥—É –±—ã—Ç—å —Å–æ–±–æ–π ü¶ã","–¢—ã –º–æ—è –ø–æ–ª–æ–≤–∏–Ω–∫–∞ üíù","–õ—é–±–ª—é –∫–∞–∫ —Ç—ã —Å–º–µ—ë—à—å—Å—è üòÑ","–¢—ã –ø–∞—Ö–Ω–µ—à—å –∫–∞–∫ –¥–æ–º üè†","–ú–æ–∏ —á—É–≤—Å—Ç–≤–∞ —Ç–æ–ª—å–∫–æ —Ä–∞—Å—Ç—É—Ç üìà","–¢—ã ‚Äî –ø—Ä–∏—á–∏–Ω–∞ –º–æ–µ–π —É–ª—ã–±–∫–∏ üòÉ","–•–æ—á—É —Å–æ—Å—Ç–∞—Ä–∏—Ç—å—Å—è —Å —Ç–æ–±–æ–π üë¥üëµ","–¢—ã –ª—É—á—à–µ–µ –≤ –º–æ–µ–π –∂–∏–∑–Ω–∏ üåü"];
let currentCompliment = '';
function renderCompliment() {
  let html = '<div style="text-align:center;padding:20px"><div style="font-size:80px;margin-bottom:20px">üíå</div>';
  html += '<div style="background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:20px;padding:32px;margin-bottom:24px;min-height:120px;display:flex;align-items:center;justify-content:center"><div style="font-size:22px;font-weight:600;line-height:1.4" id="complimentText">'+(currentCompliment||'–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–∞')+'</div></div>';
  html += '<button onclick="newCompliment()" style="width:100%;padding:18px;background:var(--bg2);border:1px solid var(--border);border-radius:16px;color:var(--text);font-size:16px;font-weight:600;cursor:pointer;margin-bottom:12px">üîÑ –ù–æ–≤—ã–π –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç</button>';
  html += '<button onclick="sendCompliment()" style="width:100%;padding:18px;background:linear-gradient(135deg,#ef4444,#f87171);border:none;border-radius:16px;color:#fff;font-size:16px;font-weight:600;cursor:pointer">‚ù§Ô∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä—É</button></div>';
  document.getElementById('complimentC').innerHTML = html;
}
function newCompliment() {
  currentCompliment = compliments[Math.floor(Math.random() * compliments.length)];
  document.getElementById('complimentText').innerHTML = currentCompliment;
}
async function sendCompliment() {
  if (!currentCompliment) { newCompliment(); }
  if (!currentUser?.coupleId) { toast('–°–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã'); return; }
  try { await fetch(API + '/couple/' + currentUser.coupleId + '/chat', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ from: userId, message: 'üíå ' + currentCompliment }) }); toast('üíï –ö–æ–º–ø–ª–∏–º–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!'); } catch(e) { toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'); }
}

// ===== GIFTS =====
const virtualGifts = [{id:1,name:'–†–æ–∑–∞',icon:'üåπ',cost:10},{id:2,name:'–®–æ–∫–æ–ª–∞–¥',icon:'üç´',cost:15},{id:3,name:'–°–µ—Ä–¥—Ü–µ',icon:'‚ù§Ô∏è',cost:20},{id:4,name:'–ú–∏—à–∫–∞',icon:'üß∏',cost:30},{id:5,name:'–ö–æ–ª—å—Ü–æ',icon:'üíç',cost:50},{id:6,name:'–ë—É–∫–µ—Ç',icon:'üíê',cost:25},{id:7,name:'–ü–æ—Ü–µ–ª—É–π',icon:'üíã',cost:5},{id:8,name:'–ö–æ—Ä–æ–Ω–∞',icon:'üëë',cost:100}];
let receivedGifts = [];
async function renderGifts() {
  const coins = currentUser?.coins || 100;
  if (currentUser?.coupleId) { try { const r = await fetch(API+'/couple/'+currentUser.coupleId+'/gifts'); receivedGifts = await r.json(); } catch(e) { receivedGifts = []; } }
  let html = '<div style="background:linear-gradient(135deg,#fbbf24,#f59e0b);border-radius:16px;padding:16px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between"><div style="font-size:14px">–í–∞—à–∏ –º–æ–Ω–µ—Ç—ã</div><div style="font-size:24px;font-weight:700">ü™ô '+coins+'</div></div>';
  html += '<h3 style="font-size:16px;margin-bottom:12px">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–¥–∞—Ä–æ–∫</h3><div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:24px">';
  virtualGifts.forEach(g => { html += '<div onclick="sendGift('+g.id+')" style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;cursor:pointer"><div style="font-size:32px">'+g.icon+'</div><div style="font-size:11px;color:var(--text2);margin-top:4px">ü™ô'+g.cost+'</div></div>'; });
  html += '</div>';
  if (receivedGifts.length > 0) {
    html += '<h3 style="font-size:16px;margin-bottom:12px">–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –ø–æ–¥–∞—Ä–∫–∏</h3><div style="display:flex;flex-wrap:wrap;gap:8px">';
    receivedGifts.slice(-20).forEach(g => { html += '<div style="font-size:28px" title="–û—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞">'+g.icon+'</div>'; });
    html += '</div>';
  }
  document.getElementById('giftsC').innerHTML = html;
}
async function sendGift(giftId) {
  if (!currentUser?.coupleId || !partner) { toast('–°–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã'); return; }
  const gift = virtualGifts.find(g => g.id === giftId);
  if ((currentUser.coins || 0) < gift.cost) { toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç'); return; }
  try {
    const r = await fetch(API+'/couple/'+currentUser.coupleId+'/gifts', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ giftId, from: userId, to: partner.id }) });
    const d = await r.json();
    if (d.success) { currentUser.coins = d.user.coins; toast('üéÅ '+gift.icon+' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!'); renderGifts(); }
    else toast(d.error || '–û—à–∏–±–∫–∞');
  } catch(e) { toast('–û—à–∏–±–∫–∞'); }
}

// ===== TRUTH OR DARE =====
let todItem = null;
async function renderTruthDare() {
  let html = '<div style="text-align:center;padding:20px"><div style="font-size:80px;margin-bottom:20px">üî•</div>';
  html += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:32px;margin-bottom:24px;min-height:150px"><div style="font-size:14px;color:var(--accent);margin-bottom:12px" id="todType">'+(todItem?.type==='truth'?'–ü–†–ê–í–î–ê':'–î–ï–ô–°–¢–í–ò–ï')+'</div><div style="font-size:20px;font-weight:600;line-height:1.4" id="todText">'+(todItem?.item||'–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø')+'</div></div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
  html += '<button onclick="getTod(\'truth\')" style="padding:18px;background:linear-gradient(135deg,#3b82f6,#60a5fa);border:none;border-radius:16px;color:#fff;font-size:16px;font-weight:600;cursor:pointer">ü§î –ü—Ä–∞–≤–¥–∞</button>';
  html += '<button onclick="getTod(\'dare\')" style="padding:18px;background:linear-gradient(135deg,#ef4444,#f87171);border:none;border-radius:16px;color:#fff;font-size:16px;font-weight:600;cursor:pointer">üòà –î–µ–π—Å—Ç–≤–∏–µ</button>';
  html += '</div></div>';
  document.getElementById('truthDareC').innerHTML = html;
}
async function getTod(type) {
  try { const r = await fetch(API+'/games/truth-or-dare?type='+type); todItem = await r.json(); } 
  catch(e) { 
    const truths = ['–ö–∞–∫–∞—è —Ç–≤–æ—è —Å–∞–º–∞—è —Å–º–µ–ª–∞—è —Ñ–∞–Ω—Ç–∞–∑–∏—è?','–ß—Ç–æ —Ç–µ–±—è –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –≤–æ–∑–±—É–∂–¥–∞–µ—Ç –≤–æ –º–Ω–µ?','–ö–∞–∫–æ–π —Å–µ–∫—Ä–µ—Ç —Ç—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Ä–∞—Å—Å–∫–∞–∑—ã–≤–∞–ª?','–ß—Ç–æ –±—ã —Ç—ã —Ö–æ—Ç–µ–ª —á—Ç–æ–±—ã —è –¥–µ–ª–∞–ª —á–∞—â–µ?'];
    const dares = ['–ü–æ—Ü–µ–ª—É–π –º–µ–Ω—è 10 —Å–µ–∫—É–Ω–¥','–°–¥–µ–ª–∞–π –º–Ω–µ –º–∞—Å—Å–∞–∂ 5 –º–∏–Ω—É—Ç','–°—Ç–∞–Ω—Ü—É–π –¥–ª—è –º–µ–Ω—è','–°–Ω–∏–º–∏ –æ–¥–∏–Ω –ø—Ä–µ–¥–º–µ—Ç –æ–¥–µ–∂–¥—ã'];
    const items = type==='truth'?truths:dares;
    todItem = { type, item: items[Math.floor(Math.random()*items.length)] };
  }
  document.getElementById('todType').textContent = todItem.type==='truth'?'–ü–†–ê–í–î–ê':'–î–ï–ô–°–¢–í–ò–ï';
  document.getElementById('todText').textContent = todItem.item;
}

// ===== WOULD YOU RATHER =====
let wyrItem = null;
async function renderWouldRather() {
  let html = '<div style="text-align:center;padding:20px"><div style="font-size:80px;margin-bottom:20px">ü§î</div>';
  if (wyrItem) {
    html += '<div style="display:flex;flex-direction:column;gap:16px">';
    html += '<button onclick="pickWyr(\'a\')" style="padding:24px;background:linear-gradient(135deg,#ec4899,#f472b6);border:none;border-radius:16px;color:#fff;font-size:18px;font-weight:600;cursor:pointer">'+wyrItem.a+'</button>';
    html += '<div style="color:var(--text2)">–∏–ª–∏</div>';
    html += '<button onclick="pickWyr(\'b\')" style="padding:24px;background:linear-gradient(135deg,#8b5cf6,#a78bfa);border:none;border-radius:16px;color:#fff;font-size:18px;font-weight:600;cursor:pointer">'+wyrItem.b+'</button>';
    html += '</div>';
  } else {
    html += '<p style="color:var(--text2);margin-bottom:20px">–ù–∞–∂–º–∏—Ç–µ —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>';
  }
  html += '<button onclick="getWyr()" style="width:100%;padding:18px;background:var(--bg2);border:1px solid var(--border);border-radius:16px;color:var(--text);font-size:16px;font-weight:600;cursor:pointer;margin-top:20px">üîÑ –ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å</button></div>';
  document.getElementById('wouldRatherC').innerHTML = html;
}
async function getWyr() {
  try { const r = await fetch(API+'/games/would-you-rather'); wyrItem = await r.json(); }
  catch(e) { 
    const items = [{a:'–°–µ–∫—Å –Ω–∞ –ø–ª—è–∂–µ',b:'–°–µ–∫—Å –≤ –≥–æ—Ä–∞—Ö'},{a:'–ë—ã—Ç—å —Å–≤–µ—Ä—Ö—É',b:'–ë—ã—Ç—å —Å–Ω–∏–∑—É'},{a:'–£—Ç—Ä–µ–Ω–Ω–∏–π —Å–µ–∫—Å',b:'–ù–æ—á–Ω–æ–π —Å–µ–∫—Å'}];
    wyrItem = items[Math.floor(Math.random()*items.length)];
  }
  renderWouldRather();
}
function pickWyr(choice) { toast('–¢—ã –≤—ã–±—Ä–∞–ª: '+wyrItem[choice]+' üòè'); getWyr(); }

// ===== SPIN WHEEL =====
let spinResult = null;
function renderSpinWheel() {
  let html = '<div style="text-align:center;padding:20px"><div style="font-size:100px;margin-bottom:20px;animation:spin 0.5s ease-out" id="wheelIcon">üé°</div>';
  html += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:20px;min-height:80px;display:flex;align-items:center;justify-content:center"><div style="font-size:22px;font-weight:600" id="spinText">'+(spinResult?.item||'–ö—Ä—É—Ç–∏—Ç–µ –∫–æ–ª–µ—Å–æ!')+'</div></div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">';
  html += '<button onclick="spinWheel(\'position\')" style="padding:14px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:14px;cursor:pointer">üî• –ü–æ–∑–∞</button>';
  html += '<button onclick="spinWheel(\'action\')" style="padding:14px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:14px;cursor:pointer">üíã –î–µ–π—Å—Ç–≤–∏–µ</button>';
  html += '<button onclick="spinWheel(\'place\')" style="padding:14px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:14px;cursor:pointer">üìç –ú–µ—Å—Ç–æ</button>';
  html += '<button onclick="spinWheel(\'time\')" style="padding:14px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:14px;cursor:pointer">‚è±Ô∏è –í—Ä–µ–º—è</button>';
  html += '</div>';
  html += '<button onclick="spinWheel()" style="width:100%;padding:18px;background:linear-gradient(135deg,var(--accent),var(--accent2));border:none;border-radius:16px;color:#fff;font-size:18px;font-weight:700;cursor:pointer">üé∞ –°–ª—É—á–∞–π–Ω–æ–µ!</button></div>';
  document.getElementById('spinWheelC').innerHTML = html;
}
async function spinWheel(cat) {
  document.getElementById('wheelIcon').style.animation = 'none';
  setTimeout(() => document.getElementById('wheelIcon').style.animation = 'spin 0.5s ease-out', 10);
  try { const r = await fetch(API+'/games/spin'+(cat?'?category='+cat:'')); spinResult = await r.json(); }
  catch(e) {
    const items = {position:['–ú–∏—Å—Å–∏–æ–Ω–µ—Ä—Å–∫–∞—è','–ù–∞–µ–∑–¥–Ω–∏—Ü–∞','–î–æ–≥–≥–∏','69'],action:['–ü–æ—Ü–µ–ª—É–π','–ú–∞—Å—Å–∞–∂','–°—Ç—Ä–∏–ø—Ç–∏–∑'],place:['–ö—Ä–æ–≤–∞—Ç—å','–î–∏–≤–∞–Ω','–í–∞–Ω–Ω–∞—è'],time:['5 –º–∏–Ω—É—Ç','15 –º–∏–Ω—É—Ç','30 –º–∏–Ω—É—Ç']};
    const cats = Object.keys(items);
    const c = cat || cats[Math.floor(Math.random()*cats.length)];
    spinResult = { category: c, item: items[c][Math.floor(Math.random()*items[c].length)] };
  }
  document.getElementById('spinText').textContent = spinResult.item;
  toast('üé° '+spinResult.item);
}

// ===== SECRETS =====
let secretsData = { partner1: [], partner2: [], revealed: [] };
async function renderSecrets() {
  if (currentUser?.coupleId) { try { const r = await fetch(API+'/couple/'+currentUser.coupleId+'/secrets'); secretsData = await r.json(); } catch(e) {} }
  const isP1 = currentUser?.coupleId?.includes(userId);
  const mySecrets = isP1 ? secretsData.partner1 : secretsData.partner2;
  const canReveal = secretsData.partner1.filter(s=>!secretsData.revealed.includes(s.id)).length > 0 && secretsData.partner2.filter(s=>!secretsData.revealed.includes(s.id)).length > 0;
  
  let html = '<div style="text-align:center;padding:20px"><div style="font-size:60px;margin-bottom:16px">ü§´</div>';
  html += '<p style="color:var(--text2);margin-bottom:20px">–ù–∞–ø–∏—à–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã ‚Äî –æ–Ω–∏ —Ä–∞—Å–∫—Ä–æ—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ!</p>';
  html += '<textarea id="secretInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–π —Å–µ–∫—Ä–µ—Ç –∏–ª–∏ —Ñ–∞–Ω—Ç–∞–∑–∏—é..." rows="3" style="width:100%;padding:14px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:15px;resize:none;margin-bottom:12px"></textarea>';
  html += '<button onclick="addSecret()" style="width:100%;padding:16px;background:var(--accent);border:none;border-radius:14px;color:#fff;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:20px">ü§´ –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç</button>';
  html += '<div style="display:flex;justify-content:space-between;margin-bottom:12px"><span>–í–∞—à–∏—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤: '+mySecrets.filter(s=>!secretsData.revealed.includes(s.id)).length+'</span><span>–†–∞—Å–∫—Ä—ã—Ç–æ: '+secretsData.revealed.length/2+'</span></div>';
  if (canReveal) {
    html += '<button onclick="revealSecrets()" style="width:100%;padding:18px;background:linear-gradient(135deg,#ec4899,#f472b6);border:none;border-radius:16px;color:#fff;font-size:16px;font-weight:700;cursor:pointer">‚ú® –†–∞—Å–∫—Ä—ã—Ç—å —Å–µ–∫—Ä–µ—Ç—ã!</button>';
  } else {
    html += '<div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px;color:var(--text2)">–ù—É–∂–Ω—ã —Å–µ–∫—Ä–µ—Ç—ã –æ—Ç –æ–±–æ–∏—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–∏—è</div>';
  }
  html += '</div>';
  document.getElementById('secretsC').innerHTML = html;
}
async function addSecret() {
  const input = document.getElementById('secretInput');
  const secret = input.value.trim();
  if (!secret) { toast('–ù–∞–ø–∏—à–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç'); return; }
  if (!currentUser?.coupleId) { toast('–°–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã'); return; }
  const isP1 = currentUser.coupleId.includes(userId);
  try { await fetch(API+'/couple/'+currentUser.coupleId+'/secrets', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ secret, isPartner1: isP1 }) }); }
  catch(e) {}
  input.value = '';
  toast('ü§´ –°–µ–∫—Ä–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω');
  renderSecrets();
}
async function revealSecrets() {
  if (!currentUser?.coupleId) return;
  try {
    const r = await fetch(API+'/couple/'+currentUser.coupleId+'/secrets/reveal', { method:'POST' });
    const d = await r.json();
    if (d.success && d.secrets) {
      alert('ü§´ –†–∞—Å–∫—Ä—ã—Ç—ã–µ —Å–µ–∫—Ä–µ—Ç—ã:\n\nüë§ –ü–∞—Ä—Ç–Ω—ë—Ä 1: '+d.secrets[0].secret+'\n\nüë§ –ü–∞—Ä—Ç–Ω—ë—Ä 2: '+d.secrets[1].secret);
      renderSecrets();
    } else { toast(d.error || '–ù—É–∂–Ω—ã —Å–µ–∫—Ä–µ—Ç—ã –æ—Ç –æ–±–æ–∏—Ö'); }
  } catch(e) { toast('–û—à–∏–±–∫–∞'); }
}

// ===== PROFILE =====
function renderProfile() {
  const u = currentUser || {};
  const level = u.level || 1;
  const xp = u.xp || 0;
  const coins = u.coins || 100;
  const nextLevelXp = level * 100;
  const progress = Math.min(100, (xp % 100));
  const streak = S.streak?.current || 0;
  const bestStreak = S.streak?.best || 0;
  
  let html = '<div style="text-align:center;padding:20px">';
  html += '<div style="font-size:80px;margin-bottom:16px;animation:float 3s infinite">üë§</div>';
  html += '<div style="font-size:24px;font-weight:700;margin-bottom:4px">'+(u.name||'–ì–æ—Å—Ç—å')+'</div>';
  html += '<div style="color:var(--text2);margin-bottom:8px">@'+(u.username||'unknown')+'</div>';
  html += '<div class="level-badge" style="margin-bottom:20px">‚≠ê –£—Ä–æ–≤–µ–Ω—å '+level+'</div>';
  
  // XP Card
  html += '<div class="glass" style="border-radius:16px;padding:20px;margin-bottom:16px">';
  html += '<div style="display:flex;justify-content:space-between;margin-bottom:12px"><span>–û–ø—ã—Ç</span><span style="font-weight:700;color:var(--accent)">'+xp+' XP</span></div>';
  html += '<div class="xp-bar"><div class="xp-bar-fill" style="width:'+progress+'%"></div></div>';
  html += '<div style="font-size:12px;color:var(--text2);margin-top:8px">–î–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è: '+(100-progress)+' XP</div>';
  html += '</div>';
  
  // Stats Grid
  html += '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px">';
  html += '<div class="stat-card"><div class="icon">ü™ô</div><div class="value">'+coins+'</div><div class="label">–ú–æ–Ω–µ—Ç—ã</div></div>';
  html += '<div class="stat-card"><div class="icon">üèÜ</div><div class="value">'+(S.achievements?.length||0)+'</div><div class="label">–î–æ—Å—Ç–∏–∂–µ–Ω–∏–π</div></div>';
  html += '<div class="stat-card"><div class="icon">üî•</div><div class="value">'+streak+'</div><div class="label">–°—Ç—Ä–∏–∫</div></div>';
  html += '<div class="stat-card"><div class="icon">‚≠ê</div><div class="value">'+bestStreak+'</div><div class="label">–†–µ–∫–æ—Ä–¥</div></div>';
  html += '</div>';
  
  if (partner) {
    html += '<div class="glass" style="border-radius:16px;padding:20px;display:flex;align-items:center;gap:16px">';
    html += '<div style="font-size:48px;animation:heartbeat 1.5s infinite">üíë</div>';
    html += '<div style="text-align:left"><div style="font-size:12px;color:var(--text2)">–ü–∞—Ä—Ç–Ω—ë—Ä</div><div style="font-size:20px;font-weight:700">'+partner.name+'</div></div>';
    html += '</div>';
  }
  html += '</div>';
  document.getElementById('profileC').innerHTML = html;
}

// ===== ACHIEVEMENT POPUP =====
function showAchievementUnlocked(title, icon, desc) {
  const popup = document.createElement('div');
  popup.className = 'achievement-unlocked';
  popup.innerHTML = '<div class="icon">'+icon+'</div><div class="title">üéâ '+title+'</div><div class="desc">'+desc+'</div>';
  popup.onclick = () => popup.remove();
  document.body.appendChild(popup);
  if (tg) tg.HapticFeedback?.notificationOccurred('success');
  setTimeout(() => popup.remove(), 4000);
}

// ===== CONFETTI =====
function showConfetti() {
  const colors = ['#ff6b9d', '#a855f7', '#22c55e', '#f59e0b', '#3b82f6'];
  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div');
    confetti.style.cssText = 'position:fixed;width:10px;height:10px;background:'+colors[Math.floor(Math.random()*colors.length)]+';top:-10px;left:'+Math.random()*100+'%;animation:confetti '+(.5+Math.random()*2)+'s linear forwards;z-index:9999;border-radius:'+(Math.random()>.5?'50%':'0');
    document.body.appendChild(confetti);
    setTimeout(() => confetti.remove(), 3000);
  }
}

// ===== LEVEL UP =====
function showLevelUp(level) {
  showConfetti();
  const popup = document.createElement('div');
  popup.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:24px;padding:40px;text-align:center;z-index:2000;animation:slideUp .5s,pulse 1s .5s';
  popup.innerHTML = '<div style="font-size:64px;margin-bottom:16px;animation:float 2s infinite">‚≠ê</div><div style="font-size:14px;opacity:.9;margin-bottom:8px">–ù–û–í–´–ô –£–†–û–í–ï–ù–¨</div><div style="font-size:48px;font-weight:800">'+level+'</div><div style="margin-top:16px;font-size:14px;opacity:.9">+50 –º–æ–Ω–µ—Ç!</div>';
  popup.onclick = () => popup.remove();
  document.body.appendChild(popup);
  if (tg) tg.HapticFeedback?.notificationOccurred('success');
  setTimeout(() => popup.remove(), 4000);
}

// ===== DAILY BONUS =====
function checkDailyBonus() {
  const lastBonus = localStorage.getItem('lastDailyBonus');
  const today = new Date().toISOString().split('T')[0];
  if (lastBonus !== today) {
    setTimeout(() => {
      const bonus = 10 + Math.floor(Math.random() * 20);
      showDailyBonus(bonus);
      localStorage.setItem('lastDailyBonus', today);
      if (currentUser) currentUser.coins = (currentUser.coins || 0) + bonus;
      updateDashboard();
    }, 2000);
  }
}

function showDailyBonus(coins) {
  showConfetti();
  const popup = document.createElement('div');
  popup.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#000;border-radius:24px;padding:40px;text-align:center;z-index:2000;animation:slideUp .5s';
  popup.innerHTML = '<div style="font-size:64px;margin-bottom:16px">üéÅ</div><div style="font-size:14px;opacity:.8;margin-bottom:8px">–ï–ñ–ï–î–ù–ï–í–ù–´–ô –ë–û–ù–£–°</div><div style="font-size:36px;font-weight:800">+'+coins+' ü™ô</div>';
  popup.onclick = () => popup.remove();
  document.body.appendChild(popup);
  if (tg) tg.HapticFeedback?.notificationOccurred('success');
  setTimeout(() => popup.remove(), 3000);
}

// ===== INIT =====
document.getElementById('posModal').onclick = e => { if (e.target.id === 'posModal') closePos(); };
document.getElementById('calModal').onclick = e => { if (e.target.id === 'calModal') closeCM(); };

checkAuth();
setTimeout(checkDailyBonus, 3000);
</script>
</body>
</html>
